"use strict";var t=Object.defineProperty,e=(e,i,s)=>(((e,i,s)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s})(e,"symbol"!=typeof i?i+"":i,s),s);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const i=require("three"),s=require("@thatopen-platform/fragments-beta");function n(t){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(t)for(const i in t)if("default"!==i){const s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:()=>t[i]})}return e.default=t,Object.freeze(e)}const r=n(i);class o{constructor(){e(this,"enabled",!0),e(this,"trigger",(t=>{if(!this.enabled)return;const e=this.handlers.slice(0);for(const i of e)i(t)})),e(this,"handlers",[])}add(t){this.handlers.push(t)}remove(t){this.handlers=this.handlers.filter((e=>e!==t))}reset(){this.handlers.length=0}}class a{constructor(t){e(this,"isDisposeable",(()=>"dispose"in this&&"onDisposed"in this)),e(this,"isResizeable",(()=>"resize"in this&&"getSize"in this)),e(this,"isUpdateable",(()=>"onAfterUpdate"in this&&"onBeforeUpdate"in this&&"update"in this)),e(this,"isHideable",(()=>"visible"in this)),e(this,"isConfigurable",(()=>"setup"in this&&"config"in this&&"onSetup"in this)),this.components=t}}class h extends a{}class l extends a{constructor(t){super(t),e(this,"worlds",new Map),e(this,"onWorldChanged",new o),e(this,"currentWorld",null),this.onWorldChanged.add((({world:t,action:e})=>{"removed"===e&&this.worlds.delete(t.uuid)}))}}class c extends l{constructor(){super(...arguments),e(this,"hasCameraControls",(()=>"controls"in this))}}class d extends l{constructor(){super(...arguments),e(this,"onAfterUpdate",new o),e(this,"onBeforeUpdate",new o),e(this,"onDisposed",new o),e(this,"onResize",new o),e(this,"onClippingPlanesUpdated",new o),e(this,"clippingPlanes",[])}updateClippingPlanes(){this.onClippingPlanesUpdated.trigger()}setPlane(t,e,i){e.isLocal=i;const s=this.clippingPlanes.indexOf(e);t&&-1===s?this.clippingPlanes.push(e):!t&&s>-1&&this.clippingPlanes.splice(s,1),this.three.clippingPlanes=this.clippingPlanes.filter((t=>!t.isLocal))}}const u=class t extends h{constructor(i){super(i),e(this,"_disposedComponents",new Set),e(this,"enabled",!0),i.add(t.uuid,this)}get(){return this._disposedComponents}destroy(t,e=!0,i=!0){t.removeFromParent();const s=t;s.dispose&&s.dispose(),this.disposeGeometryAndMaterials(t,e),i&&s.children&&s.children.length&&this.disposeChildren(s),t.children.length=0}disposeGeometry(t){t.boundsTree&&t.disposeBoundsTree&&t.disposeBoundsTree(),t.dispose()}disposeGeometryAndMaterials(e,i){const s=e;s.geometry&&this.disposeGeometry(s.geometry),i&&s.material&&t.disposeMaterial(s),s.material=[],s.geometry=null}disposeChildren(t){for(const e of t.children)this.destroy(e)}static disposeMaterial(t){if(t.material)if(Array.isArray(t.material))for(const e of t.material)e.dispose();else t.material.dispose()}};e(u,"uuid","76e9cd8e-ad8f-4753-9ef6-cbc60f7247fe");let p=u;class f extends l{constructor(t){super(t),e(this,"onDisposed",new o),e(this,"directionalLights",new Map),e(this,"ambientLights",new Map)}dispose(){const t=this.components.get(p);for(const e of this.three.children){const i=e;i.geometry&&t.destroy(i)}this.deleteAllLights(),this.three.children=[],this.onDisposed.trigger(),this.onDisposed.reset()}deleteAllLights(){for(const[,t]of this.directionalLights)t.removeFromParent(),t.target.removeFromParent(),t.dispose();this.directionalLights.clear();for(const[,t]of this.ambientLights)t.removeFromParent(),t.dispose();this.ambientLights.clear()}}class m extends Set{constructor(t){super(t),e(this,"onItemAdded",new o),e(this,"onItemDeleted",new o),e(this,"onCleared",new o),e(this,"guard",(()=>!0))}clear(){super.clear(),this.onCleared.trigger()}add(...t){for(const e of t){if(this.has(e))continue;this.guard(e)&&(super.add(e),this.onItemAdded||(this.onItemAdded=new o),this.onItemAdded.trigger(e))}return this}delete(t){const e=super.delete(t);return e&&this.onItemDeleted.trigger(),e}dispose(){this.clear(),this.onItemAdded.reset(),this.onItemDeleted.reset(),this.onCleared.reset()}}class g extends Map{constructor(t){super(t),e(this,"onItemSet",new o),e(this,"onItemUpdated",new o),e(this,"onItemDeleted",new o),e(this,"onCleared",new o),e(this,"guard",(()=>!0))}clear(){super.clear(),this.onCleared.trigger()}set(t,e){const i=this.has(t);if(!(this.guard??(()=>!0))(t,e))return this;const s=super.set(t,e);return i?(this.onItemUpdated||(this.onItemUpdated=new o),this.onItemUpdated.trigger({key:t,value:e})):(this.onItemSet||(this.onItemSet=new o),this.onItemSet.trigger({key:t,value:e})),s}delete(t){const e=super.delete(t);return e&&this.onItemDeleted.trigger(t),e}dispose(){this.clear(),this.onItemSet.reset(),this.onItemDeleted.reset(),this.onCleared.reset()}}class _{static isEntry(t){return new Set(["Boolean","Color","Text","Number","Select","Vector3","TextSet","None"]).has(t.type)}static copySchema(t,e={}){for(const i in t){const s=t[i];this.isEntry(s)?e[i]=this.copyEntry(s):(e[i]={},this.copySchema(s,e[i]))}return e}static copyEntry(t){if("Boolean"===t.type){const e=t;return{type:e.type,value:e.value}}if("Color"===t.type){const e=t;return{type:e.type,value:e.value.clone()}}if("Text"===t.type){const e=t;return{type:e.type,value:e.value}}if("Number"===t.type){const e=t;return{type:e.type,value:e.value,min:e.min,max:e.max,interpolable:e.interpolable}}if("Select"===t.type){const e=t;return{type:e.type,value:e.value,multiple:e.multiple,options:new Set(e.options)}}if("Vector3"===t.type){const e=t;return{type:e.type,value:e.value.clone()}}if("TextSet"===t.type){const e=t;return{type:e.type,value:new Set(e.value)}}if("None"===t.type){const e=t;return{type:e.type,value:e.value}}throw new Error("Invalid entry!")}}const y=class t{static create(){const e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return`${t._lut[255&e]+t._lut[e>>8&255]+t._lut[e>>16&255]+t._lut[e>>24&255]}-${t._lut[255&i]}${t._lut[i>>8&255]}-${t._lut[i>>16&15|64]}${t._lut[i>>24&255]}-${t._lut[63&s|128]}${t._lut[s>>8&255]}-${t._lut[s>>16&255]}${t._lut[s>>24&255]}${t._lut[255&n]}${t._lut[n>>8&255]}${t._lut[n>>16&255]}${t._lut[n>>24&255]}`.toLowerCase()}static validate(e){if(!t._pattern.test(e))throw new Error(`${e} is not a valid UUID v4.\n\n- If you're the tool creator, you can take one from https://www.uuidgenerator.net/.\n\n- If you're using a platform tool, verify the uuid isn't misspelled or contact the tool creator.`)}};e(y,"_pattern",/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/),e(y,"_lut",["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"]);let w=y;class v{constructor(t,i,s,n){e(this,"_component"),e(this,"name"),e(this,"uuid"),this._component=t,this.name=s,this.uuid=n??w.create();i.get(x).list.set(this.uuid,this)}get controls(){return _.copySchema(this._config)}set(t){for(const e in t)if(e in this){this[e]=t[e].value}}export(t=this._config,e={}){for(const i in t){const s=t[i];if(_.isEntry(s))if("Color"===s.type){const{r:t,g:n,b:r}=s.value;e[i]={...s,value:{r:t,g:n,b:r}}}else if("Vector3"===s.type){const{x:t,y:n,z:r}=s.value;e[i]={...s,value:{x:t,y:n,z:r}}}else if("TextSet"===s.type){const t=Array.from(s.value);e[i]={...s,value:t}}else if("Select"===s.type){const t=Array.from(s.options);e[i]={...s,options:t}}else e[i]={...s};else e[i]={},this.export(s,e[i])}return e}import(t,e={},i=!0){for(const i in t){const s=t[i];if(_.isEntry(s))if("Color"===s.type){const{r:t,g:n,b:o}=s.value;e[i]={...s,value:new r.Color(t,n,o)}}else if("Vector3"===s.type){const{x:t,y:n,z:o}=s.value;e[i]={...s,value:new r.Vector3(t,n,o)}}else"TextSet"===s.type?e[i]={...s,value:new Set(s.value)}:"Select"===s.type?e[i]={...s,options:new Set(s.options)}:e[i]={...s};else e[i]={},this.import(s,e[i],!1)}i&&this.set(e)}}const b=class t extends h{constructor(i){super(i),e(this,"list",new g),e(this,"enabled",!0),i.add(t.uuid,this)}};e(b,"uuid","b8c764e0-6b24-4e77-9a32-35fa728ee5b4");let x=b;class T extends a{constructor(){super(...arguments),e(this,"meshes",new Set),e(this,"onAfterUpdate",new o),e(this,"onBeforeUpdate",new o),e(this,"onDisposed",new o),e(this,"isDisposing",!1),e(this,"enabled",!0),e(this,"uuid",w.create()),e(this,"name"),e(this,"_scene"),e(this,"_camera"),e(this,"_renderer",null)}get scene(){if(!this._scene)throw new Error("No scene initialized!");return this._scene}set scene(t){this._scene=t,t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"})}get camera(){if(!this._camera)throw new Error("No camera initialized!");return this._camera}set camera(t){this._camera=t,t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"})}get renderer(){return this._renderer}set renderer(t){this._renderer=t,t&&(t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"}))}update(t){this.enabled&&this._scene&&this._camera&&(this.scene.currentWorld=this,this.camera.currentWorld=this,this.renderer&&(this.renderer.currentWorld=this),this.onBeforeUpdate.trigger(),this.scene.isUpdateable()&&this.scene.update(t),this.camera.isUpdateable()&&this.camera.update(t),this.renderer&&this.renderer.update(t),this.onAfterUpdate.trigger())}dispose(t=!0){if(this.enabled=!1,this.isDisposing=!0,this.scene.onWorldChanged.trigger({world:this,action:"removed"}),this.camera.onWorldChanged.trigger({world:this,action:"removed"}),this.renderer&&this.renderer.onWorldChanged.trigger({world:this,action:"removed"}),t){const t=this.components.get(p);this.scene.dispose(),this.camera.isDisposeable()&&this.camera.dispose(),this.renderer&&this.renderer.dispose();for(const e of this.meshes)t.destroy(e);this.meshes.clear()}this._scene=null,this._camera=null,this._renderer=null;this.components.get(Ct).list.delete(this.uuid),this.onDisposed.trigger(),this.onDisposed.reset()}}class E{constructor(t,i){e(this,"_list"),e(this,"_scene"),this._list=t,this._scene=i}get color(){return this._list.directionalLight.color.value}set color(t){this._list.directionalLight.color.value=t;for(const[,e]of this._scene.directionalLights)e.color.copy(t)}get intensity(){return this._list.directionalLight.intensity.value}set intensity(t){this._list.directionalLight.intensity.value=t;for(const[,e]of this._scene.directionalLights)e.intensity=t}get position(){return this._list.directionalLight.position.value.clone()}set position(t){this._list.directionalLight.position.value=t;for(const[,e]of this._scene.directionalLights)e.position.copy(t)}}class C{constructor(t,i){e(this,"_list"),e(this,"_scene"),this._list=t,this._scene=i}get color(){return this._list.ambientLight.color.value}set color(t){this._list.ambientLight.color.value=t;for(const[,e]of this._scene.ambientLights)e.color.copy(t)}get intensity(){return this._list.ambientLight.intensity.value}set intensity(t){this._list.ambientLight.intensity.value=t;for(const[,e]of this._scene.ambientLights)e.intensity=t}}class O extends v{constructor(){super(...arguments),e(this,"_config",{backgroundColor:{value:new r.Color,type:"Color"},ambientLight:{color:{type:"Color",value:new r.Color},intensity:{type:"Number",interpolable:!0,min:0,max:10,value:2}},directionalLight:{color:{type:"Color",value:new r.Color},intensity:{type:"Number",interpolable:!0,min:0,max:10,value:2},position:{type:"Vector3",value:new r.Vector3}}}),e(this,"ambientLight",new C(this._config,this._component)),e(this,"directionalLight",new E(this._config,this._component))}get backgroundColor(){return this._config.backgroundColor.value}set backgroundColor(t){this._config.backgroundColor.value=t,this._component.three.background=t}}
/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */
const A=1,S=2,P=4,k=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,SCREEN_PAN:4,OFFSET:8,DOLLY:16,ZOOM:32,TOUCH_ROTATE:64,TOUCH_TRUCK:128,TOUCH_SCREEN_PAN:256,TOUCH_OFFSET:512,TOUCH_DOLLY:1024,TOUCH_ZOOM:2048,TOUCH_DOLLY_TRUCK:4096,TOUCH_DOLLY_SCREEN_PAN:8192,TOUCH_DOLLY_OFFSET:16384,TOUCH_DOLLY_ROTATE:32768,TOUCH_ZOOM_TRUCK:65536,TOUCH_ZOOM_OFFSET:131072,TOUCH_ZOOM_SCREEN_PAN:262144,TOUCH_ZOOM_ROTATE:524288}),z=0,M=1,B=-1;function D(t){return t.isPerspectiveCamera}function I(t){return t.isOrthographicCamera}const U=2*Math.PI,N=Math.PI/2,L=Math.PI/180;function R(t,e,i){return Math.max(e,Math.min(i,t))}function F(t,e=1e-5){return Math.abs(t)<e}function V(t,e,i=1e-5){return F(t-e,i)}function Z(t,e){return Math.round(t/e)*e}function j(t){return isFinite(t)?t:t<0?-Number.MAX_VALUE:Number.MAX_VALUE}function H(t){return Math.abs(t)<Number.MAX_VALUE?t:t*(1/0)}function Y(t,e,i,s,n=1/0,r){const o=2/(s=Math.max(1e-4,s)),a=o*r,h=1/(1+a+.48*a*a+.235*a*a*a);let l=t-e;const c=e,d=n*s;l=R(l,-d,d),e=t-l;const u=(i.value+o*l)*r;i.value=(i.value-o*u)*h;let p=e+(l+u)*h;return c-t>0==p>c&&(p=c,i.value=(p-c)/r),p}function W(t,e,i,s,n=1/0,r,o){const a=2/(s=Math.max(1e-4,s)),h=a*r,l=1/(1+h+.48*h*h+.235*h*h*h);let c=e.x,d=e.y,u=e.z,p=t.x-c,f=t.y-d,m=t.z-u;const g=c,_=d,y=u,w=n*s,v=p*p+f*f+m*m;if(v>w*w){const t=Math.sqrt(v);p=p/t*w,f=f/t*w,m=m/t*w}c=t.x-p,d=t.y-f,u=t.z-m;const b=(i.x+a*p)*r,x=(i.y+a*f)*r,T=(i.z+a*m)*r;i.x=(i.x-a*b)*l,i.y=(i.y-a*x)*l,i.z=(i.z-a*T)*l,o.x=c+(p+b)*l,o.y=d+(f+x)*l,o.z=u+(m+T)*l;const E=g-t.x,C=_-t.y,O=y-t.z;return E*(o.x-g)+C*(o.y-_)+O*(o.z-y)>0&&(o.x=g,o.y=_,o.z=y,i.x=(o.x-g)/r,i.y=(o.y-_)/r,i.z=(o.z-y)/r),o}function $(t,e){e.set(0,0),t.forEach((t=>{e.x+=t.clientX,e.y+=t.clientY})),e.x/=t.length,e.y/=t.length}function X(t,e){return!!I(t)&&(console.warn(`${e} is not supported in OrthographicCamera`),!0)}class G{constructor(){this._listeners={}}addEventListener(t,e){const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}hasEventListener(t,e){const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}removeEventListener(t,e){const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}removeAllEventListeners(t){t?Array.isArray(this._listeners[t])&&(this._listeners[t].length=0):this._listeners={}}dispatchEvent(t){const e=this._listeners[t.type];if(void 0!==e){t.target=this;const i=e.slice(0);for(let e=0,s=i.length;e<s;e++)i[e].call(this,t)}}}var Q;const q=1/8,K=/Mac/.test(null===(Q=null===globalThis||void 0===globalThis?void 0:globalThis.navigator)||void 0===Q?void 0:Q.platform);let J,tt,et,it,st,nt,rt,ot,at,ht,lt,ct,dt,ut,pt,ft,mt,gt,_t,yt,wt,vt,bt;class xt extends G{static install(t){J=t.THREE,tt=Object.freeze(new J.Vector3(0,0,0)),et=Object.freeze(new J.Vector3(0,1,0)),it=Object.freeze(new J.Vector3(0,0,1)),st=new J.Vector2,nt=new J.Vector3,rt=new J.Vector3,ot=new J.Vector3,at=new J.Vector3,ht=new J.Vector3,lt=new J.Vector3,ct=new J.Vector3,dt=new J.Vector3,ut=new J.Vector3,pt=new J.Spherical,ft=new J.Spherical,mt=new J.Box3,gt=new J.Box3,_t=new J.Sphere,yt=new J.Quaternion,wt=new J.Quaternion,vt=new J.Matrix4,bt=new J.Raycaster}static get ACTION(){return k}constructor(t,e){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=k.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=z,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new J.Vector3,this._focalOffsetVelocity=new J.Vector3,this._zoomVelocity={value:0},this._truckInternal=(t,e,i,s)=>{let n,r;if(D(this._camera)){const i=nt.copy(this._camera.position).sub(this._target),s=this._camera.getEffectiveFOV()*L,o=i.length()*Math.tan(.5*s);n=this.truckSpeed*t*o/this._elementRect.height,r=this.truckSpeed*e*o/this._elementRect.height}else{if(!I(this._camera))return;{const i=this._camera;n=this.truckSpeed*t*(i.right-i.left)/i.zoom/this._elementRect.width,r=this.truckSpeed*e*(i.top-i.bottom)/i.zoom/this._elementRect.height}}s?(i?this.setFocalOffset(this._focalOffsetEnd.x+n,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(n,0,!0),this.forward(-r,!0)):i?this.setFocalOffset(this._focalOffsetEnd.x+n,this._focalOffsetEnd.y+r,this._focalOffsetEnd.z,!0):this.truck(n,r,!0)},this._rotateInternal=(t,e)=>{const i=U*this.azimuthRotateSpeed*t/this._elementRect.height,s=U*this.polarRotateSpeed*e/this._elementRect.height;this.rotate(i,s,!0)},this._dollyInternal=(t,e,i)=>{const s=Math.pow(.95,-t*this.dollySpeed),n=this._sphericalEnd.radius,r=this._sphericalEnd.radius*s,o=R(r,this.minDistance,this.maxDistance),a=o-r;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(r,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(a,!0),this._dollyToNoClamp(o,!0)):this._dollyToNoClamp(o,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?r:o)-n,this._dollyControlCoord.set(e,i)),this._lastDollyDirection=Math.sign(-t)},this._zoomInternal=(t,e,i)=>{const s=Math.pow(.95,t*this.dollySpeed),n=this._zoom,r=this._zoom*s;this.zoomTo(r,!0),this.dollyToCursor&&(this._changedZoom+=r-n,this._dollyControlCoord.set(e,i))},void 0===J&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=t,this._yAxisUpSpace=(new J.Quaternion).setFromUnitVectors(this._camera.up,et),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=k.NONE,this._target=new J.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new J.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=(new J.Spherical).setFromVector3(nt.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new J.Vector3,new J.Vector3,new J.Vector3,new J.Vector3],this._updateNearPlaneCorners(),this._boundary=new J.Box3(new J.Vector3(-1/0,-1/0,-1/0),new J.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new J.Vector2,this.mouseButtons={left:k.ROTATE,middle:k.DOLLY,right:k.TRUCK,wheel:D(this._camera)?k.DOLLY:I(this._camera)?k.ZOOM:k.NONE},this.touches={one:k.TOUCH_ROTATE,two:D(this._camera)?k.TOUCH_DOLLY_TRUCK:I(this._camera)?k.TOUCH_ZOOM_TRUCK:k.NONE,three:k.TOUCH_TRUCK};const i=new J.Vector2,s=new J.Vector2,n=new J.Vector2,r=t=>{if(!this._enabled||!this._domElement)return;if(0!==this._interactiveArea.left||0!==this._interactiveArea.top||1!==this._interactiveArea.width||1!==this._interactiveArea.height){const e=this._domElement.getBoundingClientRect(),i=t.clientX/e.width,s=t.clientY/e.height;if(i<this._interactiveArea.left||i>this._interactiveArea.right||s<this._interactiveArea.top||s>this._interactiveArea.bottom)return}const e="mouse"!==t.pointerType?null:(t.buttons&A)===A?A:(t.buttons&P)===P?P:(t.buttons&S)===S?S:null;if(null!==e){const t=this._findPointerByMouseButton(e);t&&this._disposePointer(t)}if((t.buttons&A)===A&&this._lockedPointer)return;const i={pointerId:t.pointerId,clientX:t.clientX,clientY:t.clientY,deltaX:0,deltaY:0,mouseButton:e};this._activePointers.push(i),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",a),this._isDragging=!0,d(t)},o=t=>{t.cancelable&&t.preventDefault();const e=t.pointerId,i=this._lockedPointer||this._findPointerById(e);if(i){if(i.clientX=t.clientX,i.clientY=t.clientY,i.deltaX=t.movementX,i.deltaY=t.movementY,this._state=0,"touch"===t.pointerType)switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(t.buttons&A)===A)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(t.buttons&P)===P&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(t.buttons&S)===S&&(this._state=this._state|this.mouseButtons.right);u()}},a=t=>{const e=this._findPointerById(t.pointerId);if(!e||e!==this._lockedPointer){if(e&&this._disposePointer(e),"touch"===t.pointerType)switch(this._activePointers.length){case 0:this._state=k.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else this._state=k.NONE;p()}};let h=-1;const l=t=>{if(!this._domElement)return;if(!this._enabled||this.mouseButtons.wheel===k.NONE)return;if(0!==this._interactiveArea.left||0!==this._interactiveArea.top||1!==this._interactiveArea.width||1!==this._interactiveArea.height){const e=this._domElement.getBoundingClientRect(),i=t.clientX/e.width,s=t.clientY/e.height;if(i<this._interactiveArea.left||i>this._interactiveArea.right||s<this._interactiveArea.top||s>this._interactiveArea.bottom)return}if(t.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===k.ROTATE||this.mouseButtons.wheel===k.TRUCK){const t=performance.now();h-t<1e3&&this._getClientRect(this._elementRect),h=t}const e=K?-1:-3,i=1===t.deltaMode?t.deltaY/e:t.deltaY/(10*e),s=this.dollyToCursor?(t.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,n=this.dollyToCursor?(t.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case k.ROTATE:this._rotateInternal(t.deltaX,t.deltaY),this._isUserControllingRotate=!0;break;case k.TRUCK:this._truckInternal(t.deltaX,t.deltaY,!1,!1),this._isUserControllingTruck=!0;break;case k.SCREEN_PAN:this._truckInternal(t.deltaX,t.deltaY,!1,!0),this._isUserControllingTruck=!0;break;case k.OFFSET:this._truckInternal(t.deltaX,t.deltaY,!0,!1),this._isUserControllingOffset=!0;break;case k.DOLLY:this._dollyInternal(-i,s,n),this._isUserControllingDolly=!0;break;case k.ZOOM:this._zoomInternal(-i,s,n),this._isUserControllingZoom=!0}this.dispatchEvent({type:"control"})},c=t=>{if(this._domElement&&this._enabled){if(this.mouseButtons.right===xt.ACTION.NONE){const e=t instanceof PointerEvent?t.pointerId:0,i=this._findPointerById(e);return i&&this._disposePointer(i),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),void this._domElement.ownerDocument.removeEventListener("pointerup",a)}t.preventDefault()}},d=t=>{if(!this._enabled)return;$(this._activePointers,st),this._getClientRect(this._elementRect),i.copy(st),s.copy(st);if(this._activePointers.length>=2){const t=st.x-this._activePointers[1].clientX,e=st.y-this._activePointers[1].clientY,i=Math.sqrt(t*t+e*e);n.set(0,i);const r=.5*(this._activePointers[0].clientX+this._activePointers[1].clientX),o=.5*(this._activePointers[0].clientY+this._activePointers[1].clientY);s.set(r,o)}if(this._state=0,t)if("pointerType"in t&&"touch"===t.pointerType)switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three}else this._lockedPointer||(t.buttons&A)!==A||(this._state=this._state|this.mouseButtons.left),(t.buttons&P)===P&&(this._state=this._state|this.mouseButtons.middle),(t.buttons&S)===S&&(this._state=this._state|this.mouseButtons.right);else this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);(this._state&k.ROTATE)!==k.ROTATE&&(this._state&k.TOUCH_ROTATE)!==k.TOUCH_ROTATE&&(this._state&k.TOUCH_DOLLY_ROTATE)!==k.TOUCH_DOLLY_ROTATE&&(this._state&k.TOUCH_ZOOM_ROTATE)!==k.TOUCH_ZOOM_ROTATE||(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),(this._state&k.TRUCK)!==k.TRUCK&&(this._state&k.SCREEN_PAN)!==k.SCREEN_PAN&&(this._state&k.TOUCH_TRUCK)!==k.TOUCH_TRUCK&&(this._state&k.TOUCH_SCREEN_PAN)!==k.TOUCH_SCREEN_PAN&&(this._state&k.TOUCH_DOLLY_TRUCK)!==k.TOUCH_DOLLY_TRUCK&&(this._state&k.TOUCH_DOLLY_SCREEN_PAN)!==k.TOUCH_DOLLY_SCREEN_PAN&&(this._state&k.TOUCH_ZOOM_TRUCK)!==k.TOUCH_ZOOM_TRUCK&&(this._state&k.TOUCH_ZOOM_SCREEN_PAN)!==k.TOUCH_DOLLY_SCREEN_PAN||(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),(this._state&k.DOLLY)!==k.DOLLY&&(this._state&k.TOUCH_DOLLY)!==k.TOUCH_DOLLY&&(this._state&k.TOUCH_DOLLY_TRUCK)!==k.TOUCH_DOLLY_TRUCK&&(this._state&k.TOUCH_DOLLY_SCREEN_PAN)!==k.TOUCH_DOLLY_SCREEN_PAN&&(this._state&k.TOUCH_DOLLY_OFFSET)!==k.TOUCH_DOLLY_OFFSET&&(this._state&k.TOUCH_DOLLY_ROTATE)!==k.TOUCH_DOLLY_ROTATE||(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),(this._state&k.ZOOM)!==k.ZOOM&&(this._state&k.TOUCH_ZOOM)!==k.TOUCH_ZOOM&&(this._state&k.TOUCH_ZOOM_TRUCK)!==k.TOUCH_ZOOM_TRUCK&&(this._state&k.TOUCH_ZOOM_SCREEN_PAN)!==k.TOUCH_ZOOM_SCREEN_PAN&&(this._state&k.TOUCH_ZOOM_OFFSET)!==k.TOUCH_ZOOM_OFFSET&&(this._state&k.TOUCH_ZOOM_ROTATE)!==k.TOUCH_ZOOM_ROTATE||(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),(this._state&k.OFFSET)!==k.OFFSET&&(this._state&k.TOUCH_OFFSET)!==k.TOUCH_OFFSET&&(this._state&k.TOUCH_DOLLY_OFFSET)!==k.TOUCH_DOLLY_OFFSET&&(this._state&k.TOUCH_ZOOM_OFFSET)!==k.TOUCH_ZOOM_OFFSET||(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})},u=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,$(this._activePointers,st);const t=this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,e=t?-t.deltaX:s.x-st.x,r=t?-t.deltaY:s.y-st.y;if(s.copy(st),(this._state&k.ROTATE)!==k.ROTATE&&(this._state&k.TOUCH_ROTATE)!==k.TOUCH_ROTATE&&(this._state&k.TOUCH_DOLLY_ROTATE)!==k.TOUCH_DOLLY_ROTATE&&(this._state&k.TOUCH_ZOOM_ROTATE)!==k.TOUCH_ZOOM_ROTATE||(this._rotateInternal(e,r),this._isUserControllingRotate=!0),(this._state&k.DOLLY)===k.DOLLY||(this._state&k.ZOOM)===k.ZOOM){const t=this.dollyToCursor?(i.x-this._elementRect.x)/this._elementRect.width*2-1:0,e=this.dollyToCursor?(i.y-this._elementRect.y)/this._elementRect.height*-2+1:0,s=this.dollyDragInverted?-1:1;(this._state&k.DOLLY)===k.DOLLY?(this._dollyInternal(s*r*q,t,e),this._isUserControllingDolly=!0):(this._zoomInternal(s*r*q,t,e),this._isUserControllingZoom=!0)}if((this._state&k.TOUCH_DOLLY)===k.TOUCH_DOLLY||(this._state&k.TOUCH_ZOOM)===k.TOUCH_ZOOM||(this._state&k.TOUCH_DOLLY_TRUCK)===k.TOUCH_DOLLY_TRUCK||(this._state&k.TOUCH_ZOOM_TRUCK)===k.TOUCH_ZOOM_TRUCK||(this._state&k.TOUCH_DOLLY_SCREEN_PAN)===k.TOUCH_DOLLY_SCREEN_PAN||(this._state&k.TOUCH_ZOOM_SCREEN_PAN)===k.TOUCH_ZOOM_SCREEN_PAN||(this._state&k.TOUCH_DOLLY_OFFSET)===k.TOUCH_DOLLY_OFFSET||(this._state&k.TOUCH_ZOOM_OFFSET)===k.TOUCH_ZOOM_OFFSET||(this._state&k.TOUCH_DOLLY_ROTATE)===k.TOUCH_DOLLY_ROTATE||(this._state&k.TOUCH_ZOOM_ROTATE)===k.TOUCH_ZOOM_ROTATE){const t=st.x-this._activePointers[1].clientX,e=st.y-this._activePointers[1].clientY,i=Math.sqrt(t*t+e*e),r=n.y-i;n.set(0,i);const o=this.dollyToCursor?(s.x-this._elementRect.x)/this._elementRect.width*2-1:0,a=this.dollyToCursor?(s.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&k.TOUCH_DOLLY)===k.TOUCH_DOLLY||(this._state&k.TOUCH_DOLLY_ROTATE)===k.TOUCH_DOLLY_ROTATE||(this._state&k.TOUCH_DOLLY_TRUCK)===k.TOUCH_DOLLY_TRUCK||(this._state&k.TOUCH_DOLLY_SCREEN_PAN)===k.TOUCH_DOLLY_SCREEN_PAN||(this._state&k.TOUCH_DOLLY_OFFSET)===k.TOUCH_DOLLY_OFFSET?(this._dollyInternal(r*q,o,a),this._isUserControllingDolly=!0):(this._zoomInternal(r*q,o,a),this._isUserControllingZoom=!0)}(this._state&k.TRUCK)!==k.TRUCK&&(this._state&k.TOUCH_TRUCK)!==k.TOUCH_TRUCK&&(this._state&k.TOUCH_DOLLY_TRUCK)!==k.TOUCH_DOLLY_TRUCK&&(this._state&k.TOUCH_ZOOM_TRUCK)!==k.TOUCH_ZOOM_TRUCK||(this._truckInternal(e,r,!1,!1),this._isUserControllingTruck=!0),(this._state&k.SCREEN_PAN)!==k.SCREEN_PAN&&(this._state&k.TOUCH_SCREEN_PAN)!==k.TOUCH_SCREEN_PAN&&(this._state&k.TOUCH_DOLLY_SCREEN_PAN)!==k.TOUCH_DOLLY_SCREEN_PAN&&(this._state&k.TOUCH_ZOOM_SCREEN_PAN)!==k.TOUCH_ZOOM_SCREEN_PAN||(this._truckInternal(e,r,!1,!0),this._isUserControllingTruck=!0),(this._state&k.OFFSET)!==k.OFFSET&&(this._state&k.TOUCH_OFFSET)!==k.TOUCH_OFFSET&&(this._state&k.TOUCH_DOLLY_OFFSET)!==k.TOUCH_DOLLY_OFFSET&&(this._state&k.TOUCH_ZOOM_OFFSET)!==k.TOUCH_ZOOM_OFFSET||(this._truckInternal(e,r,!0,!1),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},p=()=>{$(this._activePointers,st),s.copy(st),this._dragNeedsUpdate=!1,(0===this._activePointers.length||1===this._activePointers.length&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),0===this._activePointers.length&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{this._enabled&&this._domElement&&(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",f),this._domElement.ownerDocument.addEventListener("pointerlockerror",m),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",a),d())},this.unlockPointer=()=>{var t,e,i;null!==this._lockedPointer&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),null===(t=this._domElement)||void 0===t||t.ownerDocument.exitPointerLock(),null===(e=this._domElement)||void 0===e||e.ownerDocument.removeEventListener("pointerlockchange",f),null===(i=this._domElement)||void 0===i||i.ownerDocument.removeEventListener("pointerlockerror",m),this.cancel()};const f=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},m=()=>{this.unlockPointer()};this._addAllEventListeners=t=>{this._domElement=t,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",r),this._domElement.addEventListener("pointercancel",a),this._domElement.addEventListener("wheel",l,{passive:!1}),this._domElement.addEventListener("contextmenu",c)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",r),this._domElement.removeEventListener("pointercancel",a),this._domElement.removeEventListener("wheel",l,{passive:!1}),this._domElement.removeEventListener("contextmenu",c),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",a),this._domElement.ownerDocument.removeEventListener("pointerlockchange",f),this._domElement.ownerDocument.removeEventListener("pointerlockerror",m))},this.cancel=()=>{this._state!==k.NONE&&(this._state=k.NONE,this._activePointers.length=0,p())},e&&this.connect(e),this.update(0)}get camera(){return this._camera}set camera(t){this._camera=t,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this._domElement&&(t?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(t){this._spherical.radius===t&&this._sphericalEnd.radius===t||(this._spherical.radius=t,this._sphericalEnd.radius=t,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(t){this._spherical.theta===t&&this._sphericalEnd.theta===t||(this._spherical.theta=t,this._sphericalEnd.theta=t,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(t){this._spherical.phi===t&&this._sphericalEnd.phi===t||(this._spherical.phi=t,this._sphericalEnd.phi=t,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(t){this._boundaryEnclosesCamera=t,this._needsUpdate=!0}set interactiveArea(t){this._interactiveArea.width=R(t.width,0,1),this._interactiveArea.height=R(t.height,0,1),this._interactiveArea.x=R(t.x,0,1-this._interactiveArea.width),this._interactiveArea.y=R(t.y,0,1-this._interactiveArea.height)}addEventListener(t,e){super.addEventListener(t,e)}removeEventListener(t,e){super.removeEventListener(t,e)}rotate(t,e,i=!1){return this.rotateTo(this._sphericalEnd.theta+t,this._sphericalEnd.phi+e,i)}rotateAzimuthTo(t,e=!1){return this.rotateTo(t,this._sphericalEnd.phi,e)}rotatePolarTo(t,e=!1){return this.rotateTo(this._sphericalEnd.theta,t,e)}rotateTo(t,e,i=!1){this._isUserControllingRotate=!1;const s=R(t,this.minAzimuthAngle,this.maxAzimuthAngle),n=R(e,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=s,this._sphericalEnd.phi=n,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,i||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const r=!i||V(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&V(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(r)}dolly(t,e=!1){return this.dollyTo(this._sphericalEnd.radius-t,e)}dollyTo(t,e=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=z,this._changedDolly=0,this._dollyToNoClamp(R(t,this.minDistance,this.maxDistance),e)}_dollyToNoClamp(t,e=!1){const i=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const e=this._collisionTest(),s=V(e,this._spherical.radius);if(!(i>t)&&s)return Promise.resolve();this._sphericalEnd.radius=Math.min(t,e)}else this._sphericalEnd.radius=t;this._needsUpdate=!0,e||(this._spherical.radius=this._sphericalEnd.radius);const s=!e||V(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(s)}dollyInFixed(t,e=!1){this._targetEnd.add(this._getCameraDirection(at).multiplyScalar(t)),e||this._target.copy(this._targetEnd);const i=!e||V(this._target.x,this._targetEnd.x,this.restThreshold)&&V(this._target.y,this._targetEnd.y,this.restThreshold)&&V(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(i)}zoom(t,e=!1){return this.zoomTo(this._zoomEnd+t,e)}zoomTo(t,e=!1){this._isUserControllingZoom=!1,this._zoomEnd=R(t,this.minZoom,this.maxZoom),this._needsUpdate=!0,e||(this._zoom=this._zoomEnd);const i=!e||V(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(i)}pan(t,e,i=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(t,e,i)}truck(t,e,i=!1){this._camera.updateMatrix(),ht.setFromMatrixColumn(this._camera.matrix,0),lt.setFromMatrixColumn(this._camera.matrix,1),ht.multiplyScalar(t),lt.multiplyScalar(-e);const s=nt.copy(ht).add(lt),n=rt.copy(this._targetEnd).add(s);return this.moveTo(n.x,n.y,n.z,i)}forward(t,e=!1){nt.setFromMatrixColumn(this._camera.matrix,0),nt.crossVectors(this._camera.up,nt),nt.multiplyScalar(t);const i=rt.copy(this._targetEnd).add(nt);return this.moveTo(i.x,i.y,i.z,e)}elevate(t,e=!1){return nt.copy(this._camera.up).multiplyScalar(t),this.moveTo(this._targetEnd.x+nt.x,this._targetEnd.y+nt.y,this._targetEnd.z+nt.z,e)}moveTo(t,e,i,s=!1){this._isUserControllingTruck=!1;const n=nt.set(t,e,i).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,n,this.boundaryFriction),this._needsUpdate=!0,s||this._target.copy(this._targetEnd);const r=!s||V(this._target.x,this._targetEnd.x,this.restThreshold)&&V(this._target.y,this._targetEnd.y,this.restThreshold)&&V(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(r)}lookInDirectionOf(t,e,i,s=!1){const n=nt.set(t,e,i).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(n.x,n.y,n.z,s)}fitToBox(t,e,{cover:i=!1,paddingLeft:s=0,paddingRight:n=0,paddingBottom:r=0,paddingTop:o=0}={}){const a=[],h=t.isBox3?mt.copy(t):mt.setFromObject(t);h.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const l=Z(this._sphericalEnd.theta,N),c=Z(this._sphericalEnd.phi,N);a.push(this.rotateTo(l,c,e));const d=nt.setFromSpherical(this._sphericalEnd).normalize(),u=yt.setFromUnitVectors(d,it),p=V(Math.abs(d.y),1);p&&u.multiply(wt.setFromAxisAngle(et,l)),u.multiply(this._yAxisUpSpaceInverse);const f=gt.makeEmpty();rt.copy(h.min).applyQuaternion(u),f.expandByPoint(rt),rt.copy(h.min).setX(h.max.x).applyQuaternion(u),f.expandByPoint(rt),rt.copy(h.min).setY(h.max.y).applyQuaternion(u),f.expandByPoint(rt),rt.copy(h.max).setZ(h.min.z).applyQuaternion(u),f.expandByPoint(rt),rt.copy(h.min).setZ(h.max.z).applyQuaternion(u),f.expandByPoint(rt),rt.copy(h.max).setY(h.min.y).applyQuaternion(u),f.expandByPoint(rt),rt.copy(h.max).setX(h.min.x).applyQuaternion(u),f.expandByPoint(rt),rt.copy(h.max).applyQuaternion(u),f.expandByPoint(rt),f.min.x-=s,f.min.y-=r,f.max.x+=n,f.max.y+=o,u.setFromUnitVectors(it,d),p&&u.premultiply(wt.invert()),u.premultiply(this._yAxisUpSpace);const m=f.getSize(nt),g=f.getCenter(rt).applyQuaternion(u);if(D(this._camera)){const t=this.getDistanceToFitBox(m.x,m.y,m.z,i);a.push(this.moveTo(g.x,g.y,g.z,e)),a.push(this.dollyTo(t,e)),a.push(this.setFocalOffset(0,0,0,e))}else if(I(this._camera)){const t=this._camera,s=t.right-t.left,n=t.top-t.bottom,r=i?Math.max(s/m.x,n/m.y):Math.min(s/m.x,n/m.y);a.push(this.moveTo(g.x,g.y,g.z,e)),a.push(this.zoomTo(r,e)),a.push(this.setFocalOffset(0,0,0,e))}return Promise.all(a)}fitToSphere(t,e){const i=[],s="isObject3D"in t?xt.createBoundingSphere(t,_t):_t.copy(t);if(i.push(this.moveTo(s.center.x,s.center.y,s.center.z,e)),D(this._camera)){const t=this.getDistanceToFitSphere(s.radius);i.push(this.dollyTo(t,e))}else if(I(this._camera)){const t=this._camera.right-this._camera.left,n=this._camera.top-this._camera.bottom,r=2*s.radius,o=Math.min(t/r,n/r);i.push(this.zoomTo(o,e))}return i.push(this.setFocalOffset(0,0,0,e)),Promise.all(i)}setLookAt(t,e,i,s,n,r,o=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=z,this._changedDolly=0;const a=rt.set(s,n,r),h=nt.set(t,e,i);this._targetEnd.copy(a),this._sphericalEnd.setFromVector3(h.sub(a).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,o||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const l=!o||V(this._target.x,this._targetEnd.x,this.restThreshold)&&V(this._target.y,this._targetEnd.y,this.restThreshold)&&V(this._target.z,this._targetEnd.z,this.restThreshold)&&V(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&V(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&V(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(l)}lerpLookAt(t,e,i,s,n,r,o,a,h,l,c,d,u,p=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=z,this._changedDolly=0;const f=nt.set(s,n,r),m=rt.set(t,e,i);pt.setFromVector3(m.sub(f).applyQuaternion(this._yAxisUpSpace));const g=ot.set(l,c,d),_=rt.set(o,a,h);ft.setFromVector3(_.sub(g).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(f.lerp(g,u));const y=ft.theta-pt.theta,w=ft.phi-pt.phi,v=ft.radius-pt.radius;this._sphericalEnd.set(pt.radius+v*u,pt.phi+w*u,pt.theta+y*u),this.normalizeRotations(),this._needsUpdate=!0,p||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const b=!p||V(this._target.x,this._targetEnd.x,this.restThreshold)&&V(this._target.y,this._targetEnd.y,this.restThreshold)&&V(this._target.z,this._targetEnd.z,this.restThreshold)&&V(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&V(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&V(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(b)}setPosition(t,e,i,s=!1){return this.setLookAt(t,e,i,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,s)}setTarget(t,e,i,s=!1){const n=this.getPosition(nt),r=this.setLookAt(n.x,n.y,n.z,t,e,i,s);return this._sphericalEnd.phi=R(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),r}setFocalOffset(t,e,i,s=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(t,e,i),this._needsUpdate=!0,s||this._focalOffset.copy(this._focalOffsetEnd);const n=!s||V(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&V(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&V(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(n)}setOrbitPoint(t,e,i){this._camera.updateMatrixWorld(),ht.setFromMatrixColumn(this._camera.matrixWorldInverse,0),lt.setFromMatrixColumn(this._camera.matrixWorldInverse,1),ct.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const s=nt.set(t,e,i),n=s.distanceTo(this._camera.position),r=s.sub(this._camera.position);ht.multiplyScalar(r.x),lt.multiplyScalar(r.y),ct.multiplyScalar(r.z),nt.copy(ht).add(lt).add(ct),nt.z=nt.z+n,this.dollyTo(n,!1),this.setFocalOffset(-nt.x,nt.y,-nt.z,!1),this.moveTo(t,e,i,!1)}setBoundary(t){if(!t)return this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),void(this._needsUpdate=!0);this._boundary.copy(t),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(t,e,i,s){null!==t?(this._viewport=this._viewport||new J.Vector4,"number"==typeof t?this._viewport.set(t,e,i,s):this._viewport.copy(t)):this._viewport=null}getDistanceToFitBox(t,e,i,s=!1){if(X(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const n=t/e,r=this._camera.getEffectiveFOV()*L,o=this._camera.aspect;return.5*((s?n>o:n<o)?e:t/o)/Math.tan(.5*r)+.5*i}getDistanceToFitSphere(t){if(X(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const e=this._camera.getEffectiveFOV()*L,i=2*Math.atan(Math.tan(.5*e)*this._camera.aspect),s=1<this._camera.aspect?e:i;return t/Math.sin(.5*s)}getTarget(t,e=!0){return(t&&t.isVector3?t:new J.Vector3).copy(e?this._targetEnd:this._target)}getPosition(t,e=!0){return(t&&t.isVector3?t:new J.Vector3).setFromSpherical(e?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(e?this._targetEnd:this._target)}getSpherical(t,e=!0){return(t||new J.Spherical).copy(e?this._sphericalEnd:this._spherical)}getFocalOffset(t,e=!0){return(t&&t.isVector3?t:new J.Vector3).copy(e?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%U,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=U),this._spherical.theta+=U*Math.round((this._sphericalEnd.theta-this._spherical.theta)/U)}stop(){this._focalOffset.copy(this._focalOffsetEnd),this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd),this._zoom=this._zoomEnd}reset(t=!1){if(!V(this._camera.up.x,this._cameraUp0.x)||!V(this._camera.up.y,this._cameraUp0.y)||!V(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const t=this.getPosition(nt);this.updateCameraUp(),this.setPosition(t.x,t.y,t.z)}const e=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,t),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,t),this.zoomTo(this._zoom0,t)];return Promise.all(e)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,et),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const t=nt.subVectors(this._target,this._camera.position).normalize(),e=rt.crossVectors(t,this._camera.up);this._camera.up.crossVectors(e,t).normalize(),this._camera.updateMatrixWorld();const i=this.getPosition(nt);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}update(t){const e=this._sphericalEnd.theta-this._spherical.theta,i=this._sphericalEnd.phi-this._spherical.phi,s=this._sphericalEnd.radius-this._spherical.radius,n=dt.subVectors(this._targetEnd,this._target),r=ut.subVectors(this._focalOffsetEnd,this._focalOffset),o=this._zoomEnd-this._zoom;if(F(e))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const e=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=Y(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,e,1/0,t),this._needsUpdate=!0}if(F(i))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const e=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=Y(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,e,1/0,t),this._needsUpdate=!0}if(F(s))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const e=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=Y(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,e,this.maxSpeed,t),this._needsUpdate=!0}if(F(n.x)&&F(n.y)&&F(n.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const e=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;W(this._target,this._targetEnd,this._targetVelocity,e,this.maxSpeed,t,this._target),this._needsUpdate=!0}if(F(r.x)&&F(r.y)&&F(r.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const e=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;W(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,e,this.maxSpeed,t,this._focalOffset),this._needsUpdate=!0}if(F(o))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const e=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=Y(this._zoom,this._zoomEnd,this._zoomVelocity,e,1/0,t)}if(this.dollyToCursor)if(D(this._camera)&&0!==this._changedDolly){const t=this._spherical.radius-this._lastDistance,e=this._camera,i=this._getCameraDirection(at),s=nt.copy(i).cross(e.up).normalize();0===s.lengthSq()&&(s.x=1);const n=rt.crossVectors(s,i),r=this._sphericalEnd.radius*Math.tan(e.getEffectiveFOV()*L*.5),o=(this._sphericalEnd.radius-t-this._sphericalEnd.radius)/this._sphericalEnd.radius,a=ot.copy(this._targetEnd).add(s.multiplyScalar(this._dollyControlCoord.x*r*e.aspect)).add(n.multiplyScalar(this._dollyControlCoord.y*r)),h=nt.copy(this._targetEnd).lerp(a,o),l=this._lastDollyDirection===M&&this._spherical.radius<=this.minDistance,c=this._lastDollyDirection===B&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(l||c)){this._sphericalEnd.radius-=t,this._spherical.radius-=t;const e=rt.copy(i).multiplyScalar(-t);h.add(e)}this._boundary.clampPoint(h,h);const d=rt.subVectors(h,this._targetEnd);this._targetEnd.copy(h),this._target.add(d),this._changedDolly-=t,F(this._changedDolly)&&(this._changedDolly=0)}else if(I(this._camera)&&0!==this._changedZoom){const t=this._zoom-this._lastZoom,e=this._camera,i=nt.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(e.near+e.far)/(e.near-e.far)).unproject(e),s=rt.set(0,0,-1).applyQuaternion(e.quaternion),n=ot.copy(i).add(s.multiplyScalar(-i.dot(e.up))),r=-(this._zoom-t-this._zoom)/this._zoom,o=this._getCameraDirection(at),a=this._targetEnd.dot(o),h=nt.copy(this._targetEnd).lerp(n,r),l=h.dot(o),c=o.multiplyScalar(l-a);h.sub(c),this._boundary.clampPoint(h,h);const d=rt.subVectors(h,this._targetEnd);this._targetEnd.copy(h),this._target.add(d),this._changedZoom-=t,F(this._changedZoom)&&(this._changedZoom=0)}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const a=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,a),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target);(!F(this._focalOffset.x)||!F(this._focalOffset.y)||!F(this._focalOffset.z))&&(ht.setFromMatrixColumn(this._camera.matrix,0),lt.setFromMatrixColumn(this._camera.matrix,1),ct.setFromMatrixColumn(this._camera.matrix,2),ht.multiplyScalar(this._focalOffset.x),lt.multiplyScalar(-this._focalOffset.y),ct.multiplyScalar(this._focalOffset.z),nt.copy(ht).add(lt).add(ct),this._camera.position.add(nt),this._camera.updateMatrixWorld()),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),nt.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const h=this._needsUpdate;return h&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):h?(this.dispatchEvent({type:"update"}),F(e,this.restThreshold)&&F(i,this.restThreshold)&&F(s,this.restThreshold)&&F(n.x,this.restThreshold)&&F(n.y,this.restThreshold)&&F(n.z,this.restThreshold)&&F(r.x,this.restThreshold)&&F(r.y,this.restThreshold)&&F(r.z,this.restThreshold)&&F(o,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!h&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=h,this._needsUpdate=!1,h}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:j(this.maxDistance),minZoom:this.minZoom,maxZoom:j(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:j(this.maxPolarAngle),minAzimuthAngle:j(this.minAzimuthAngle),maxAzimuthAngle:j(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,target:this._targetEnd.toArray(),position:nt.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(t,e=!1){const i=JSON.parse(t);this.enabled=i.enabled,this.minDistance=i.minDistance,this.maxDistance=H(i.maxDistance),this.minZoom=i.minZoom,this.maxZoom=H(i.maxZoom),this.minPolarAngle=i.minPolarAngle,this.maxPolarAngle=H(i.maxPolarAngle),this.minAzimuthAngle=H(i.minAzimuthAngle),this.maxAzimuthAngle=H(i.maxAzimuthAngle),this.smoothTime=i.smoothTime,this.draggingSmoothTime=i.draggingSmoothTime,this.dollySpeed=i.dollySpeed,this.truckSpeed=i.truckSpeed,this.dollyToCursor=i.dollyToCursor,this._target0.fromArray(i.target0),this._position0.fromArray(i.position0),this._zoom0=i.zoom0,this._focalOffset0.fromArray(i.focalOffset0),this.moveTo(i.target[0],i.target[1],i.target[2],e),pt.setFromVector3(nt.fromArray(i.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(pt.theta,pt.phi,e),this.dollyTo(pt.radius,e),this.zoomTo(i.zoom,e),this.setFocalOffset(i.focalOffset[0],i.focalOffset[1],i.focalOffset[2],e),this._needsUpdate=!0}connect(t){this._domElement?console.warn("camera-controls is already connected."):(t.setAttribute("data-camera-controls-version","2.10.0"),this._addAllEventListeners(t),this._getClientRect(this._elementRect))}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(t){return t.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(t){return this._getTargetDirection(t).negate()}_findPointerById(t){return this._activePointers.find((e=>e.pointerId===t))}_findPointerByMouseButton(t){return this._activePointers.find((e=>e.mouseButton===t))}_disposePointer(t){this._activePointers.splice(this._activePointers.indexOf(t),1)}_encloseToBoundary(t,e,i){const s=e.lengthSq();if(0===s)return t;const n=rt.copy(e).add(t),r=this._boundary.clampPoint(n,ot).sub(n),o=r.lengthSq();if(0===o)return t.add(e);if(o===s)return t;if(0===i)return t.add(e).add(r);{const s=1+i*o/e.dot(r);return t.add(rt.copy(e).multiplyScalar(s)).add(r.multiplyScalar(1-i))}}_updateNearPlaneCorners(){if(D(this._camera)){const t=this._camera,e=t.near,i=t.getEffectiveFOV()*L,s=Math.tan(.5*i)*e,n=s*t.aspect;this._nearPlaneCorners[0].set(-n,-s,0),this._nearPlaneCorners[1].set(n,-s,0),this._nearPlaneCorners[2].set(n,s,0),this._nearPlaneCorners[3].set(-n,s,0)}else if(I(this._camera)){const t=this._camera,e=1/t.zoom,i=t.left*e,s=t.right*e,n=t.top*e,r=t.bottom*e;this._nearPlaneCorners[0].set(i,n,0),this._nearPlaneCorners[1].set(s,n,0),this._nearPlaneCorners[2].set(s,r,0),this._nearPlaneCorners[3].set(i,r,0)}}_collisionTest(){let t=1/0;if(!(this.colliderMeshes.length>=1))return t;if(X(this._camera,"_collisionTest"))return t;const e=this._getTargetDirection(at);vt.lookAt(tt,e,this._camera.up);for(let i=0;i<4;i++){const s=rt.copy(this._nearPlaneCorners[i]);s.applyMatrix4(vt);const n=ot.addVectors(this._target,s);bt.set(n,e),bt.far=this._spherical.radius+1;const r=bt.intersectObjects(this.colliderMeshes);0!==r.length&&r[0].distance<t&&(t=r[0].distance)}return t}_getClientRect(t){if(!this._domElement)return;const e=this._domElement.getBoundingClientRect();return t.x=e.left,t.y=e.top,this._viewport?(t.x+=this._viewport.x,t.y+=e.height-this._viewport.w-this._viewport.y,t.width=this._viewport.z,t.height=this._viewport.w):(t.width=e.width,t.height=e.height),t}_createOnRestPromise(t){return t?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise((t=>{const e=()=>{this.removeEventListener("rest",e),t()};this.addEventListener("rest",e)})))}_addAllEventListeners(t){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(t){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(t){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(t,e=new J.Sphere){const i=e,s=i.center;mt.makeEmpty(),t.traverseVisible((t=>{t.isMesh&&mt.expandByObject(t)})),mt.getCenter(s);let n=0;return t.traverseVisible((t=>{if(!t.isMesh)return;const e=t;if(!e.geometry)return;const i=e.geometry.clone();i.applyMatrix4(e.matrixWorld);const r=i.attributes.position;for(let t=0,e=r.count;t<e;t++)nt.fromBufferAttribute(r,t),n=Math.max(n,s.distanceToSquared(nt))})),i.radius=Math.sqrt(n),i}}class Tt extends c{constructor(t){super(t),e(this,"onBeforeUpdate",new o),e(this,"onAfterUpdate",new o),e(this,"onAspectUpdated",new o),e(this,"onDisposed",new o),e(this,"three"),e(this,"_allControls",new Map),e(this,"updateAspect",(()=>{var t;if(this.currentWorld&&this.currentWorld.renderer)if(this.three instanceof r.OrthographicCamera)this.onAspectUpdated.trigger();else if(null==(t=this.currentWorld.renderer)?void 0:t.isResizeable()){const t=this.currentWorld.renderer.getSize();this.three.aspect=t.width/t.height,this.three.updateProjectionMatrix(),this.onAspectUpdated.trigger()}})),this.three=this.setupCamera(),this.setupEvents(!0),this.onWorldChanged.add((({action:t,world:e})=>{if("added"===t){const t=this.newCameraControls();this._allControls.set(e.uuid,t)}if("removed"===t){const t=this._allControls.get(e.uuid);t&&(t.dispose(),this._allControls.delete(e.uuid))}}))}get controls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");const t=this._allControls.get(this.currentWorld.uuid);if(!t)throw new Error("Controls not found!");return t}get enabled(){return null!==this.currentWorld&&this.controls.enabled}set enabled(t){null!==this.currentWorld&&(this.controls.enabled=t)}dispose(){this.setupEvents(!1),this.onAspectUpdated.reset(),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.three.removeFromParent(),this.onDisposed.trigger(),this.onDisposed.reset();for(const[t,e]of this._allControls)e.dispose()}update(t){this.enabled&&(this.onBeforeUpdate.trigger(this),this.controls.update(t),this.onAfterUpdate.trigger(this))}setupCamera(){const t=window.innerWidth/window.innerHeight,e=new r.PerspectiveCamera(60,t,1,1e3);return e.position.set(50,50,50),e.lookAt(new r.Vector3(0,0,0)),e}newCameraControls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");if(!this.currentWorld.renderer)throw new Error("This camera needs a renderer to work!");xt.install({THREE:Tt.getSubsetOfThree()});const{domElement:t}=this.currentWorld.renderer.three,e=new xt(this.three,t);return e.smoothTime=.2,e.dollyToCursor=!0,e.infinityDolly=!0,e.minDistance=6,e}setupEvents(t){t?window.addEventListener("resize",this.updateAspect):window.removeEventListener("resize",this.updateAspect)}static getSubsetOfThree(){return{MOUSE:r.MOUSE,Vector2:r.Vector2,Vector3:r.Vector3,Vector4:r.Vector4,Quaternion:r.Quaternion,Matrix4:r.Matrix4,Spherical:r.Spherical,Box3:r.Box3,Sphere:r.Sphere,Raycaster:r.Raycaster,MathUtils:r.MathUtils}}}const Et=class t extends h{constructor(i){super(i),e(this,"onAfterUpdate",new o),e(this,"onBeforeUpdate",new o),e(this,"onDisposed",new o),e(this,"list",new g),e(this,"enabled",!0),i.add(t.uuid,this)}create(){const t=new T(this.components),e=t.uuid;if(this.list.has(e))throw new Error("There is already a world with this name!");return this.list.set(e,t),t}delete(t){if(!this.list.has(t.uuid))throw new Error("The provided world is not found in the list!");this.list.delete(t.uuid),t.dispose()}dispose(){this.enabled=!1;for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}update(t){if(this.enabled)for(const[e,i]of this.list)i.update(t)}};e(Et,"uuid","fdb61dc4-2ec1-4966-b83d-54ea795fad4a");let Ct=Et;class Ot extends v{constructor(){super(...arguments),e(this,"_config",{visible:{value:!0,type:"Boolean"},color:{value:new r.Color,type:"Color"},primarySize:{type:"Number",interpolable:!0,value:1,min:0,max:1e3},secondarySize:{type:"Number",interpolable:!0,value:10,min:0,max:1e3},distance:{type:"Number",interpolable:!0,value:500,min:0,max:500}})}get visible(){return this._config.visible.value}set visible(t){this._config.visible.value=t,this._component.visible=t}get color(){return this._config.color.value}set color(t){this._config.color.value=t,this._component.material.uniforms.uColor.value=t,this._component.material.uniformsNeedUpdate=!0}get primarySize(){return this._config.primarySize.value}set primarySize(t){this._config.primarySize.value=t,this._component.material.uniforms.uSize1.value=t,this._component.material.uniformsNeedUpdate=!0}get secondarySize(){return this._config.secondarySize.value}set secondarySize(t){this._config.secondarySize.value=t,this._component.material.uniforms.uSize2.value=t,this._component.material.uniformsNeedUpdate=!0}get distance(){return this._config.distance.value}set distance(t){this._config.distance.value=t,this._component.material.uniforms.uDistance.value=t,this._component.material.uniformsNeedUpdate=!0}}class At{constructor(t,i){e(this,"onDisposed",new o),e(this,"onSetup",new o),e(this,"isSetup",!1),e(this,"world"),e(this,"components"),e(this,"config"),e(this,"_defaultConfig",{visible:!0,color:new r.Color(12303291),primarySize:1,secondarySize:10,distance:500}),e(this,"three"),e(this,"_fade",3),e(this,"updateZoom",(()=>{this.world.camera instanceof Tt&&(this.material.uniforms.uZoom.value=this.world.camera.three.zoom)})),this.world=i;const{color:s,primarySize:n,secondarySize:a,distance:h}=this._defaultConfig;this.components=t,this.config=new Ot(this,this.components,"Grid");const l=new r.PlaneGeometry(2,2,1,1),c=new r.ShaderMaterial({side:r.DoubleSide,uniforms:{uSize1:{value:n},uSize2:{value:a},uColor:{value:s},uDistance:{value:h},uFade:{value:this._fade},uZoom:{value:1}},transparent:!0,vertexShader:"\n            \n            varying vec3 worldPosition;\n            \n            uniform float uDistance;\n            \n            void main() {\n            \n                    vec3 pos = position.xzy * uDistance;\n                    pos.xz += cameraPosition.xz;\n                    \n                    worldPosition = pos;\n                    \n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n            \n            }\n            ",fragmentShader:"\n            \n            varying vec3 worldPosition;\n            \n            uniform float uZoom;\n            uniform float uFade;\n            uniform float uSize1;\n            uniform float uSize2;\n            uniform vec3 uColor;\n            uniform float uDistance;\n                \n                \n                \n                float getGrid(float size) {\n                \n                    vec2 r = worldPosition.xz / size;\n                    \n                    \n                    vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);\n                    float line = min(grid.x, grid.y);\n                    \n                \n                    return 1.0 - min(line, 1.0);\n                }\n                \n            void main() {\n            \n                    \n                    float d = 1.0 - min(distance(cameraPosition.xz, worldPosition.xz) / uDistance, 1.0);\n                    \n                    float g1 = getGrid(uSize1);\n                    float g2 = getGrid(uSize2);\n                    \n                    // Ortho camera fades the grid away when zooming out\n                    float minZoom = step(0.2, uZoom);\n                    float zoomFactor = pow(min(uZoom, 1.), 2.) * minZoom;\n                    \n                    gl_FragColor = vec4(uColor.rgb, mix(g2, g1, g1) * pow(d, uFade));\n                    gl_FragColor.a = mix(0.5 * gl_FragColor.a, gl_FragColor.a, g2) * zoomFactor;\n                    \n                    if ( gl_FragColor.a <= 0.0 ) discard;\n                    \n            \n            }\n            \n            ",extensions:{derivatives:!0}});this.three=new r.Mesh(l,c),this.three.frustumCulled=!1,i.scene.three.add(this.three),this.setupEvents(!0)}get visible(){return this.three.visible}set visible(t){if(this.three.visible=t,t){this.world.scene.three.add(this.three)}else this.three.removeFromParent()}get material(){return this.three.material}get fade(){return 3===this._fade}set fade(t){this._fade=t?3:0,this.material.uniforms.uFade.value=this._fade}setup(t){const e={...this._defaultConfig,...t};this.config.visible=!0,this.config.color=e.color,this.config.primarySize=e.primarySize,this.config.secondarySize=e.secondarySize,this.config.distance=e.distance,this.isSetup=!0,this.onSetup.trigger()}dispose(){this.setupEvents(!1);this.components.get(x).list.delete(this.config.uuid);this.components.get(p).destroy(this.three),this.onDisposed.trigger(),this.onDisposed.reset(),this.world=null,this.components=null}setupEvents(t){if(this.world.isDisposing)return;if(!(this.world.camera instanceof Tt))return;const e=this.world.camera.controls;t?e.addEventListener("update",this.updateZoom):e.removeEventListener("update",this.updateZoom)}}const St=class t extends h{constructor(i){super(i),e(this,"list",new Map),e(this,"onDisposed",new o),e(this,"enabled",!0),i.add(t.uuid,this)}create(t){if(this.list.has(t.uuid))throw new Error("This world already has a grid!");const e=new At(this.components,t);return this.list.set(t.uuid,e),t.onDisposed.add((()=>{this.delete(t)})),e}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger(),this.onDisposed.reset()}};e(St,"uuid","d1e814d5-b81c-4452-87a2-f039375e0489");let Pt=St;const kt=1.25,zt=65535,Mt=Math.pow(2,-24),Bt=Symbol("SKIP_GENERATION");function Dt(t){return function(t){return t.index?t.index.count:t.attributes.position.count}(t)/3}function It(t,e){if(!t.index){const s=t.attributes.position.count,n=function(t,e=ArrayBuffer){return t>65535?new Uint32Array(new e(4*t)):new Uint16Array(new e(2*t))}(s,e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);t.setIndex(new i.BufferAttribute(n,1));for(let t=0;t<s;t++)n[t]=t}}function Ut(t){const e=Dt(t),i=t.drawRange,s=i.start/3,n=(i.start+i.count)/3,r=Math.max(0,s),o=Math.min(e,n)-r;return[{offset:Math.floor(r),count:Math.floor(o)}]}function Nt(t){if(!t.groups||!t.groups.length)return Ut(t);const e=[],i=new Set,s=t.drawRange,n=s.start/3,r=(s.start+s.count)/3;for(const e of t.groups){const t=e.start/3,s=(e.start+e.count)/3;i.add(Math.max(n,t)),i.add(Math.min(r,s))}const o=Array.from(i.values()).sort(((t,e)=>t-e));for(let t=0;t<o.length-1;t++){const i=o[t],s=o[t+1];e.push({offset:Math.floor(i),count:Math.floor(s-i)})}return e}function Lt(t,e,i){return i.min.x=e[t],i.min.y=e[t+1],i.min.z=e[t+2],i.max.x=e[t+3],i.max.y=e[t+4],i.max.z=e[t+5],i}function Rt(t){let e=-1,i=-1/0;for(let s=0;s<3;s++){const n=t[s+3]-t[s];n>i&&(i=n,e=s)}return e}function Ft(t,e){e.set(t)}function Vt(t,e,i){let s,n;for(let r=0;r<3;r++){const o=r+3;s=t[r],n=e[r],i[r]=s<n?s:n,s=t[o],n=e[o],i[o]=s>n?s:n}}function Zt(t,e,i){for(let s=0;s<3;s++){const n=e[t+2*s],r=e[t+2*s+1],o=n-r,a=n+r;o<i[s]&&(i[s]=o),a>i[s+3]&&(i[s+3]=a)}}function jt(t){const e=t[3]-t[0],i=t[4]-t[1],s=t[5]-t[2];return 2*(e*i+i*s+s*e)}function Ht(t,e,i,s,n=null){let r=1/0,o=1/0,a=1/0,h=-1/0,l=-1/0,c=-1/0,d=1/0,u=1/0,p=1/0,f=-1/0,m=-1/0,g=-1/0;const _=null!==n;for(let s=6*e,n=6*(e+i);s<n;s+=6){const e=t[s+0],i=t[s+1],n=e-i,y=e+i;n<r&&(r=n),y>h&&(h=y),_&&e<d&&(d=e),_&&e>f&&(f=e);const w=t[s+2],v=t[s+3],b=w-v,x=w+v;b<o&&(o=b),x>l&&(l=x),_&&w<u&&(u=w),_&&w>m&&(m=w);const T=t[s+4],E=t[s+5],C=T-E,O=T+E;C<a&&(a=C),O>c&&(c=O),_&&T<p&&(p=T),_&&T>g&&(g=T)}s[0]=r,s[1]=o,s[2]=a,s[3]=h,s[4]=l,s[5]=c,_&&(n[0]=d,n[1]=u,n[2]=p,n[3]=f,n[4]=m,n[5]=g)}const Yt=32,Wt=(t,e)=>t.candidate-e.candidate,$t=new Array(Yt).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),Xt=new Float32Array(6);class Gt{constructor(){}}function Qt(t,e,i,s,n,r){let o=s,a=s+n-1;const h=r.pos,l=2*r.axis;for(;;){for(;o<=a&&i[6*o+l]<h;)o++;for(;o<=a&&i[6*a+l]>=h;)a--;if(!(o<a))return o;for(let t=0;t<3;t++){let i=e[3*o+t];e[3*o+t]=e[3*a+t],e[3*a+t]=i}for(let t=0;t<6;t++){let e=i[6*o+t];i[6*o+t]=i[6*a+t],i[6*a+t]=e}o++,a--}}function qt(t,e,i,s,n,r){let o=s,a=s+n-1;const h=r.pos,l=2*r.axis;for(;;){for(;o<=a&&i[6*o+l]<h;)o++;for(;o<=a&&i[6*a+l]>=h;)a--;if(!(o<a))return o;{let e=t[o];t[o]=t[a],t[a]=e;for(let t=0;t<6;t++){let e=i[6*o+t];i[6*o+t]=i[6*a+t],i[6*a+t]=e}o++,a--}}}function Kt(t,e){const i=t.geometry,s=i.index?i.index.array:null,n=e.maxDepth,r=e.verbose,o=e.maxLeafTris,a=e.strategy,h=e.onProgress,l=Dt(i),c=t._indirectBuffer;let d=!1;const u=new Float32Array(6),p=new Float32Array(6),f=function(t,e){var i;(i=e)[0]=i[1]=i[2]=1/0,i[3]=i[4]=i[5]=-1/0;const s=t.attributes.position,n=t.index?t.index.array:null,r=Dt(t),o=new Float32Array(6*r),a=s.normalized,h=s.array,l=s.offset||0;let c=3;s.isInterleavedBufferAttribute&&(c=s.data.stride);const d=["getX","getY","getZ"];for(let t=0;t<r;t++){const i=3*t,r=6*t;let u=i+0,p=i+1,f=i+2;n&&(u=n[u],p=n[p],f=n[f]),a||(u=u*c+l,p=p*c+l,f=f*c+l);for(let t=0;t<3;t++){let i,n,l;a?(i=s[d[t]](u),n=s[d[t]](p),l=s[d[t]](f)):(i=h[u+t],n=h[p+t],l=h[f+t]);let c=i;n<c&&(c=n),l<c&&(c=l);let m=i;n>m&&(m=n),l>m&&(m=l);const g=(m-c)/2,_=2*t;o[r+_+0]=c+g,o[r+_+1]=g+(Math.abs(c)+g)*Mt,c<e[t]&&(e[t]=c),m>e[t+3]&&(e[t+3]=m)}}return o}(i,u),m=e.indirect?qt:Qt,g=[],_=e.indirect?Ut(i):Nt(i);if(1===_.length){const t=_[0],e=new Gt;e.boundingData=u,function(t,e,i,s){let n=1/0,r=1/0,o=1/0,a=-1/0,h=-1/0,l=-1/0;for(let s=6*e,c=6*(e+i);s<c;s+=6){const e=t[s+0];e<n&&(n=e),e>a&&(a=e);const i=t[s+2];i<r&&(r=i),i>h&&(h=i);const c=t[s+4];c<o&&(o=c),c>l&&(l=c)}s[0]=n,s[1]=r,s[2]=o,s[3]=a,s[4]=h,s[5]=l}(f,t.offset,t.count,p),w(e,t.offset,t.count,p),g.push(e)}else for(let t of _){const e=new Gt;e.boundingData=new Float32Array(6),Ht(f,t.offset,t.count,e.boundingData,p),w(e,t.offset,t.count,p),g.push(e)}return g;function y(t){h&&h(t/l)}function w(t,e,h,l=null,u=0){if(!d&&u>=n&&(d=!0,r&&(console.warn(`MeshBVH: Max depth of ${n} reached when generating BVH. Consider increasing maxDepth.`),console.warn(i))),h<=o||u>=n)return y(e+h),t.offset=e,t.count=h,t;const g=function(t,e,i,s,n,r){let o=-1,a=0;if(0===r)o=Rt(e),-1!==o&&(a=(e[o]+e[o+3])/2);else if(1===r)o=Rt(t),-1!==o&&(a=function(t,e,i,s){let n=0;for(let r=e,o=e+i;r<o;r++)n+=t[6*r+2*s];return n/i}(i,s,n,o));else if(2===r){const r=jt(t);let h=kt*n;const l=6*s,c=6*(s+n);for(let t=0;t<3;t++){const s=e[t],d=(e[t+3]-s)/Yt;if(n<8){const e=[...$t];e.length=n;let s=0;for(let n=l;n<c;n+=6,s++){const r=e[s];r.candidate=i[n+2*t],r.count=0;const{bounds:o,leftCacheBounds:a,rightCacheBounds:h}=r;for(let t=0;t<3;t++)h[t]=1/0,h[t+3]=-1/0,a[t]=1/0,a[t+3]=-1/0,o[t]=1/0,o[t+3]=-1/0;Zt(n,i,o)}e.sort(Wt);let d=n;for(let t=0;t<d;t++){const i=e[t];for(;t+1<d&&e[t+1].candidate===i.candidate;)e.splice(t+1,1),d--}for(let s=l;s<c;s+=6){const n=i[s+2*t];for(let t=0;t<d;t++){const r=e[t];n>=r.candidate?Zt(s,i,r.rightCacheBounds):(Zt(s,i,r.leftCacheBounds),r.count++)}}for(let i=0;i<d;i++){const s=e[i],l=s.count,c=n-s.count,d=s.leftCacheBounds,u=s.rightCacheBounds;let p=0;0!==l&&(p=jt(d)/r);let f=0;0!==c&&(f=jt(u)/r);const m=1+kt*(p*l+f*c);m<h&&(o=t,h=m,a=s.candidate)}}else{for(let t=0;t<Yt;t++){const e=$t[t];e.count=0,e.candidate=s+d+t*d;const i=e.bounds;for(let t=0;t<3;t++)i[t]=1/0,i[t+3]=-1/0}for(let e=l;e<c;e+=6){let n=~~((i[e+2*t]-s)/d);n>=Yt&&(n=31);const r=$t[n];r.count++,Zt(e,i,r.bounds)}const e=$t[31];Ft(e.bounds,e.rightCacheBounds);for(let t=30;t>=0;t--){const e=$t[t],i=$t[t+1];Vt(e.bounds,i.rightCacheBounds,e.rightCacheBounds)}let u=0;for(let e=0;e<31;e++){const i=$t[e],s=i.count,l=i.bounds,c=$t[e+1].rightCacheBounds;0!==s&&(0===u?Ft(l,Xt):Vt(l,Xt,Xt)),u+=s;let d=0,p=0;0!==u&&(d=jt(Xt)/r);const f=n-u;0!==f&&(p=jt(c)/r);const m=1+kt*(d*u+p*f);m<h&&(o=t,h=m,a=i.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${r} used.`);return{axis:o,pos:a}}(t.boundingData,l,f,e,h,a);if(-1===g.axis)return y(e+h),t.offset=e,t.count=h,t;const _=m(c,s,f,e,h,g);if(_===e||_===e+h)y(e+h),t.offset=e,t.count=h;else{t.splitAxis=g.axis;const i=new Gt,s=e,n=_-e;t.left=i,i.boundingData=new Float32Array(6),Ht(f,s,n,i.boundingData,p),w(i,s,n,p,u+1);const r=new Gt,o=_,a=h-n;t.right=r,r.boundingData=new Float32Array(6),Ht(f,o,a,r.boundingData,p),w(r,o,a,p,u+1)}return t}}function Jt(t,e){const i=t.geometry;e.indirect&&(t._indirectBuffer=function(t,e){const i=(t.index?t.index.count:t.attributes.position.count)/3,s=i>65536,n=s?4:2,r=e?new SharedArrayBuffer(i*n):new ArrayBuffer(i*n),o=s?new Uint32Array(r):new Uint16Array(r);for(let t=0,e=o.length;t<e;t++)o[t]=t;return o}(i,e.useSharedArrayBuffer),function(t){if(0===t.groups.length)return!1;const e=Dt(t),i=Nt(t).sort(((t,e)=>t.offset-e.offset)),s=i[i.length-1];s.count=Math.min(e-s.offset,s.count);let n=0;return i.forEach((({count:t})=>n+=t)),e!==n}(i)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),t._indirectBuffer||It(i,e);const s=Kt(t,e);let n,r,o;const a=[],h=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let t=0;t<s.length;t++){const e=s[t];const i=new h(32*l(e));n=new Float32Array(i),r=new Uint32Array(i),o=new Uint16Array(i),c(0,e),a.push(i)}return void(t._roots=a);function l(t){return t.count?1:1+l(t.left)+l(t.right)}function c(t,e){const i=t/4,s=t/2,a=!!e.count,h=e.boundingData;for(let t=0;t<6;t++)n[i+t]=h[t];if(a){const n=e.offset,a=e.count;return r[i+6]=n,o[s+14]=a,o[s+15]=zt,t+32}{const s=e.left,n=e.right,o=e.splitAxis;let a;if(a=c(t+32,s),a/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return r[i+6]=a/4,a=c(a,n),r[i+7]=o,a}}}class te{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let i=1/0,s=-1/0;for(let n=0,r=t.length;n<r;n++){const r=t[n][e];i=r<i?r:i,s=r>s?r:s}this.min=i,this.max=s}setFromPoints(t,e){let i=1/0,s=-1/0;for(let n=0,r=e.length;n<r;n++){const r=e[n],o=t.dot(r);i=o<i?o:i,s=o>s?o:s}this.min=i,this.max=s}isSeparated(t){return this.min>t.max||t.min>this.max}}te.prototype.setFromBox=function(){const t=new i.Vector3;return function(e,i){const s=i.min,n=i.max;let r=1/0,o=-1/0;for(let i=0;i<=1;i++)for(let a=0;a<=1;a++)for(let h=0;h<=1;h++){t.x=s.x*i+n.x*(1-i),t.y=s.y*a+n.y*(1-a),t.z=s.z*h+n.z*(1-h);const l=e.dot(t);r=Math.min(l,r),o=Math.max(l,o)}this.min=r,this.max=o}}();const ee=function(){const t=new i.Vector3,e=new i.Vector3,s=new i.Vector3;return function(i,n,r){const o=i.start,a=t,h=n.start,l=e;s.subVectors(o,h),t.subVectors(i.end,i.start),e.subVectors(n.end,n.start);const c=s.dot(l),d=l.dot(a),u=l.dot(l),p=s.dot(a),f=a.dot(a)*u-d*d;let m,g;m=0!==f?(c*d-p*u)/f:0,g=(c+m*d)/u,r.x=m,r.y=g}}(),ie=function(){const t=new i.Vector2,e=new i.Vector3,s=new i.Vector3;return function(i,n,r,o){ee(i,n,t);let a=t.x,h=t.y;if(a>=0&&a<=1&&h>=0&&h<=1)return i.at(a,r),void n.at(h,o);if(a>=0&&a<=1)return h<0?n.at(0,o):n.at(1,o),void i.closestPointToPoint(o,!0,r);if(h>=0&&h<=1)return a<0?i.at(0,r):i.at(1,r),void n.closestPointToPoint(r,!0,o);{let t,l;t=a<0?i.start:i.end,l=h<0?n.start:n.end;const c=e,d=s;return i.closestPointToPoint(l,!0,e),n.closestPointToPoint(t,!0,s),c.distanceToSquared(l)<=d.distanceToSquared(t)?(r.copy(c),void o.copy(l)):(r.copy(t),void o.copy(d))}}}(),se=function(){const t=new i.Vector3,e=new i.Vector3,s=new i.Plane,n=new i.Line3;return function(i,r){const{radius:o,center:a}=i,{a:h,b:l,c:c}=r;n.start=h,n.end=l;if(n.closestPointToPoint(a,!0,t).distanceTo(a)<=o)return!0;n.start=h,n.end=c;if(n.closestPointToPoint(a,!0,t).distanceTo(a)<=o)return!0;n.start=l,n.end=c;if(n.closestPointToPoint(a,!0,t).distanceTo(a)<=o)return!0;const d=r.getPlane(s);if(Math.abs(d.distanceToPoint(a))<=o){const t=d.projectPoint(a,e);if(r.containsPoint(t))return!0}return!1}}();function ne(t){return Math.abs(t)<1e-15}class re extends i.Triangle{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new i.Vector3)),this.satBounds=new Array(4).fill().map((()=>new te)),this.points=[this.a,this.b,this.c],this.sphere=new i.Sphere,this.plane=new i.Plane,this.needsUpdate=!0}intersectsSphere(t){return se(t,this)}update(){const t=this.a,e=this.b,i=this.c,s=this.points,n=this.satAxes,r=this.satBounds,o=n[0],a=r[0];this.getNormal(o),a.setFromPoints(o,s);const h=n[1],l=r[1];h.subVectors(t,e),l.setFromPoints(h,s);const c=n[2],d=r[2];c.subVectors(e,i),d.setFromPoints(c,s);const u=n[3],p=r[3];u.subVectors(i,t),p.setFromPoints(u,s),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,t),this.needsUpdate=!1}}re.prototype.closestPointToSegment=function(){const t=new i.Vector3,e=new i.Vector3,s=new i.Line3;return function(i,n=null,r=null){const{start:o,end:a}=i,h=this.points;let l,c=1/0;for(let o=0;o<3;o++){const a=(o+1)%3;s.start.copy(h[o]),s.end.copy(h[a]),ie(s,i,t,e),l=t.distanceToSquared(e),l<c&&(c=l,n&&n.copy(t),r&&r.copy(e))}return this.closestPointToPoint(o,t),l=o.distanceToSquared(t),l<c&&(c=l,n&&n.copy(t),r&&r.copy(o)),this.closestPointToPoint(a,t),l=a.distanceToSquared(t),l<c&&(c=l,n&&n.copy(t),r&&r.copy(a)),Math.sqrt(c)}}(),re.prototype.intersectsTriangle=function(){const t=new re,e=new Array(3),s=new Array(3),n=new te,r=new te,o=new i.Vector3,a=new i.Vector3,h=new i.Vector3,l=new i.Vector3,c=new i.Vector3,d=new i.Line3,u=new i.Line3,p=new i.Line3,f=new i.Vector3;function m(t,e,i){const s=t.points;let n=0,r=-1;for(let t=0;t<3;t++){const{start:o,end:h}=d;o.copy(s[t]),h.copy(s[(t+1)%3]),d.delta(a);const l=ne(e.distanceToPoint(o));if(ne(e.normal.dot(a))&&l){i.copy(d),n=2;break}const c=e.intersectLine(d,f);if(!c&&l&&f.copy(o),(c||l)&&!ne(f.distanceTo(h))){if(n<=1){(1===n?i.start:i.end).copy(f),l&&(r=n)}else if(n>=2){(1===r?i.start:i.end).copy(f),n=2;break}if(n++,2===n&&-1===r)break}}return n}return function(i,a=null,d=!1){this.needsUpdate&&this.update(),i.isExtendedTriangle?i.needsUpdate&&i.update():(t.copy(i),t.update(),i=t);const f=this.plane,g=i.plane;if(Math.abs(f.normal.dot(g.normal))>1-1e-10){const t=this.satBounds,h=this.satAxes;s[0]=i.a,s[1]=i.b,s[2]=i.c;for(let e=0;e<4;e++){const i=t[e],r=h[e];if(n.setFromPoints(r,s),i.isSeparated(n))return!1}const l=i.satBounds,c=i.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let t=0;t<4;t++){const i=l[t],s=c[t];if(n.setFromPoints(s,e),i.isSeparated(n))return!1}for(let t=0;t<4;t++){const i=h[t];for(let t=0;t<4;t++){const a=c[t];if(o.crossVectors(i,a),n.setFromPoints(o,e),r.setFromPoints(o,s),n.isSeparated(r))return!1}}return a&&(d||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),a.start.set(0,0,0),a.end.set(0,0,0)),!0}{const t=m(this,g,u);if(1===t&&i.containsPoint(u.end))return a&&(a.start.copy(u.end),a.end.copy(u.end)),!0;if(2!==t)return!1;const e=m(i,f,p);if(1===e&&this.containsPoint(p.end))return a&&(a.start.copy(p.end),a.end.copy(p.end)),!0;if(2!==e)return!1;if(u.delta(h),p.delta(l),h.dot(l)<0){let t=p.start;p.start=p.end,p.end=t}const s=u.start.dot(h),n=u.end.dot(h),r=p.start.dot(h),o=p.end.dot(h);return(s===o||r===n||n<r!==s<o)&&(a&&(c.subVectors(u.start,p.start),c.dot(h)>0?a.start.copy(u.start):a.start.copy(p.start),c.subVectors(u.end,p.end),c.dot(h)<0?a.end.copy(u.end):a.end.copy(p.end)),!0)}}}(),re.prototype.distanceToPoint=function(){const t=new i.Vector3;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),re.prototype.distanceToTriangle=function(){const t=new i.Vector3,e=new i.Vector3,s=["a","b","c"],n=new i.Line3,r=new i.Line3;return function(i,o=null,a=null){const h=o||a?n:null;if(this.intersectsTriangle(i,h))return(o||a)&&(o&&h.getCenter(o),a&&h.getCenter(a)),0;let l=1/0;for(let e=0;e<3;e++){let n;const r=s[e],h=i[r];this.closestPointToPoint(h,t),n=h.distanceToSquared(t),n<l&&(l=n,o&&o.copy(t),a&&a.copy(h));const c=this[r];i.closestPointToPoint(c,t),n=c.distanceToSquared(t),n<l&&(l=n,o&&o.copy(c),a&&a.copy(t))}for(let h=0;h<3;h++){const c=s[h],d=s[(h+1)%3];n.set(this[c],this[d]);for(let h=0;h<3;h++){const c=s[h],d=s[(h+1)%3];r.set(i[c],i[d]),ie(n,r,t,e);const u=t.distanceToSquared(e);u<l&&(l=u,o&&o.copy(t),a&&a.copy(e))}}return Math.sqrt(l)}}();class oe{constructor(t,e,s){this.isOrientedBox=!0,this.min=new i.Vector3,this.max=new i.Vector3,this.matrix=new i.Matrix4,this.invMatrix=new i.Matrix4,this.points=new Array(8).fill().map((()=>new i.Vector3)),this.satAxes=new Array(3).fill().map((()=>new i.Vector3)),this.satBounds=new Array(3).fill().map((()=>new te)),this.alignedSatBounds=new Array(3).fill().map((()=>new te)),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),s&&this.matrix.copy(s)}set(t,e,i){this.min.copy(t),this.max.copy(e),this.matrix.copy(i),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}oe.prototype.update=function(){return function(){const t=this.matrix,e=this.min,i=this.max,s=this.points;for(let n=0;n<=1;n++)for(let r=0;r<=1;r++)for(let o=0;o<=1;o++){const a=s[1*n|2*r|4*o];a.x=n?i.x:e.x,a.y=r?i.y:e.y,a.z=o?i.z:e.z,a.applyMatrix4(t)}const n=this.satBounds,r=this.satAxes,o=s[0];for(let t=0;t<3;t++){const e=r[t],i=n[t],a=s[1<<t];e.subVectors(o,a),i.setFromPoints(e,s)}const a=this.alignedSatBounds;a[0].setFromPointsField(s,"x"),a[1].setFromPointsField(s,"y"),a[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}(),oe.prototype.intersectsBox=function(){const t=new te;return function(e){this.needsUpdate&&this.update();const i=e.min,s=e.max,n=this.satBounds,r=this.satAxes,o=this.alignedSatBounds;if(t.min=i.x,t.max=s.x,o[0].isSeparated(t))return!1;if(t.min=i.y,t.max=s.y,o[1].isSeparated(t))return!1;if(t.min=i.z,t.max=s.z,o[2].isSeparated(t))return!1;for(let i=0;i<3;i++){const s=r[i],o=n[i];if(t.setFromBox(s,e),o.isSeparated(t))return!1}return!0}}(),oe.prototype.intersectsTriangle=function(){const t=new re,e=new Array(3),s=new te,n=new te,r=new i.Vector3;return function(i){this.needsUpdate&&this.update(),i.isExtendedTriangle?i.needsUpdate&&i.update():(t.copy(i),t.update(),i=t);const o=this.satBounds,a=this.satAxes;e[0]=i.a,e[1]=i.b,e[2]=i.c;for(let t=0;t<3;t++){const i=o[t],n=a[t];if(s.setFromPoints(n,e),i.isSeparated(s))return!1}const h=i.satBounds,l=i.satAxes,c=this.points;for(let t=0;t<3;t++){const e=h[t],i=l[t];if(s.setFromPoints(i,c),e.isSeparated(s))return!1}for(let t=0;t<3;t++){const i=a[t];for(let t=0;t<4;t++){const o=l[t];if(r.crossVectors(i,o),s.setFromPoints(r,e),n.setFromPoints(r,c),s.isSeparated(n))return!1}}return!0}}(),oe.prototype.closestPointToPoint=function(){return function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e}}(),oe.prototype.distanceToPoint=function(){const t=new i.Vector3;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),oe.prototype.distanceToBox=function(){const t=["x","y","z"],e=new Array(12).fill().map((()=>new i.Line3)),s=new Array(12).fill().map((()=>new i.Line3)),n=new i.Vector3,r=new i.Vector3;return function(i,o=0,a=null,h=null){if(this.needsUpdate&&this.update(),this.intersectsBox(i))return(a||h)&&(i.getCenter(r),this.closestPointToPoint(r,n),i.closestPointToPoint(n,r),a&&a.copy(n),h&&h.copy(r)),0;const l=o*o,c=i.min,d=i.max,u=this.points;let p=1/0;for(let t=0;t<8;t++){const e=u[t];r.copy(e).clamp(c,d);const i=e.distanceToSquared(r);if(i<p&&(p=i,a&&a.copy(e),h&&h.copy(r),i<l))return Math.sqrt(i)}let f=0;for(let i=0;i<3;i++)for(let n=0;n<=1;n++)for(let r=0;r<=1;r++){const o=(i+1)%3,a=(i+2)%3,h=1<<i|n<<o|r<<a,l=u[n<<o|r<<a],p=u[h];e[f].set(l,p);const m=t[i],g=t[o],_=t[a],y=s[f],w=y.start,v=y.end;w[m]=c[m],w[g]=n?c[g]:d[g],w[_]=r?c[_]:d[g],v[m]=d[m],v[g]=n?c[g]:d[g],v[_]=r?c[_]:d[g],f++}for(let t=0;t<=1;t++)for(let e=0;e<=1;e++)for(let i=0;i<=1;i++){r.x=t?d.x:c.x,r.y=e?d.y:c.y,r.z=i?d.z:c.z,this.closestPointToPoint(r,n);const s=r.distanceToSquared(n);if(s<p&&(p=s,a&&a.copy(n),h&&h.copy(r),s<l))return Math.sqrt(s)}for(let t=0;t<12;t++){const i=e[t];for(let t=0;t<12;t++){const e=s[t];ie(i,e,n,r);const o=n.distanceToSquared(r);if(o<p&&(p=o,a&&a.copy(n),h&&h.copy(r),o<l))return Math.sqrt(o)}}return Math.sqrt(p)}}();class ae{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return 0===t.length?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class he extends ae{constructor(){super((()=>new re))}}const le=new he;function ce(t,e){return 65535===e[t+15]}function de(t,e){return e[t+6]}function ue(t,e){return e[t+14]}function pe(t){return t+8}function fe(t,e){return e[t+6]}function me(t,e){return e[t+7]}const ge=new class{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=i=>{e&&t.push(e),e=i,this.float32Array=new Float32Array(i),this.uint16Array=new Uint16Array(i),this.uint32Array=new Uint32Array(i)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==t.length&&this.setBuffer(t.pop())}}};let _e,ye;const we=[],ve=new ae((()=>new i.Box3));function be(t,e,i,s,n,r){_e=ve.getPrimitive(),ye=ve.getPrimitive(),we.push(_e,ye),ge.setBuffer(t._roots[e]);const o=xe(0,t.geometry,i,s,n,r);ge.clearBuffer(),ve.releasePrimitive(_e),ve.releasePrimitive(ye),we.pop(),we.pop();const a=we.length;return a>0&&(ye=we[a-1],_e=we[a-2]),o}function xe(t,e,i,s,n=null,r=0,o=0){const{float32Array:a,uint16Array:h,uint32Array:l}=ge;let c=2*t;if(ce(c,h)){const e=de(t,l),i=ue(c,h);return Lt(t,a,_e),s(e,i,!1,o,r+t,_e)}{let c=function(t){const{uint16Array:e,uint32Array:i}=ge;let s=2*t;for(;!ce(s,e);)s=2*(t=pe(t));return de(t,i)},d=function(t){const{uint16Array:e,uint32Array:i}=ge;let s=2*t;for(;!ce(s,e);)s=2*(t=fe(t,i));return de(t,i)+ue(s,e)};const u=pe(t),p=fe(t,l);let f,m,g,_,y=u,w=p;if(n&&(g=_e,_=ye,Lt(y,a,g),Lt(w,a,_),f=n(g),m=n(_),m<f)){y=p,w=u;const t=f;f=m,m=t,g=_}g||(g=_e,Lt(y,a,g));const v=i(g,ce(2*y,h),f,o+1,r+y);let b;if(2===v){const t=c(y);b=s(t,d(y)-t,!0,o+1,r+y,g)}else b=v&&xe(y,e,i,s,n,r,o+1);if(b)return!0;_=ye,Lt(w,a,_);const x=i(_,ce(2*w,h),m,o+1,r+w);let T;if(2===x){const t=c(w);T=s(t,d(w)-t,!0,o+1,r+w,_)}else T=x&&xe(w,e,i,s,n,r,o+1);return!!T}}const Te=new i.Vector3,Ee=new i.Vector3;const Ce=new i.Vector3,Oe=new i.Vector3,Ae=new i.Vector3,Se=new i.Vector2,Pe=new i.Vector2,ke=new i.Vector2,ze=new i.Vector3,Me=new i.Vector3,Be=new i.Vector3,De=new i.Vector3;function Ie(t,e,s,n,r,o,a,h,l){Ce.fromBufferAttribute(e,o),Oe.fromBufferAttribute(e,a),Ae.fromBufferAttribute(e,h);const c=function(t,e,s,n,r,o){let a;return a=o===i.BackSide?t.intersectTriangle(n,s,e,!0,r):t.intersectTriangle(e,s,n,o!==i.DoubleSide,r),null===a?null:{distance:t.origin.distanceTo(r),point:r.clone()}}(t,Ce,Oe,Ae,De,l);if(c){n&&(Se.fromBufferAttribute(n,o),Pe.fromBufferAttribute(n,a),ke.fromBufferAttribute(n,h),c.uv=i.Triangle.getInterpolation(De,Ce,Oe,Ae,Se,Pe,ke,new i.Vector2)),r&&(Se.fromBufferAttribute(r,o),Pe.fromBufferAttribute(r,a),ke.fromBufferAttribute(r,h),c.uv1=i.Triangle.getInterpolation(De,Ce,Oe,Ae,Se,Pe,ke,new i.Vector2)),s&&(ze.fromBufferAttribute(s,o),Me.fromBufferAttribute(s,a),Be.fromBufferAttribute(s,h),c.normal=i.Triangle.getInterpolation(De,Ce,Oe,Ae,ze,Me,Be,new i.Vector3),c.normal.dot(t.direction)>0&&c.normal.multiplyScalar(-1));const e={a:o,b:a,c:h,normal:new i.Vector3,materialIndex:0};i.Triangle.getNormal(Ce,Oe,Ae,e.normal),c.face=e,c.faceIndex=o}return c}function Ue(t,e,i,s,n){const r=3*s;let o=r+0,a=r+1,h=r+2;const l=t.index;t.index&&(o=l.getX(o),a=l.getX(a),h=l.getX(h));const{position:c,normal:d,uv:u,uv1:p}=t.attributes,f=Ie(i,c,d,u,p,o,a,h,e);return f?(f.faceIndex=s,n&&n.push(f),f):null}function Ne(t,e,i,s){const n=t.a,r=t.b,o=t.c;let a=e,h=e+1,l=e+2;i&&(a=i.getX(a),h=i.getX(h),l=i.getX(l)),n.x=s.getX(a),n.y=s.getY(a),n.z=s.getZ(a),r.x=s.getX(h),r.y=s.getY(h),r.z=s.getZ(h),o.x=s.getX(l),o.y=s.getY(l),o.z=s.getZ(l)}function Le(t,e,i,s,n,r,o){const{geometry:a}=i,{index:h}=a,l=a.attributes.position;for(let i=t,a=e+t;i<a;i++){let t;if(t=i,Ne(o,3*t,h,l),o.needsUpdate=!0,s(o,t,n,r))return!0}return!1}function Re(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const i=t.geometry,s=i.index?i.index.array:null,n=i.attributes.position;let r,o,a,h,l=0;const c=t._roots;for(let t=0,e=c.length;t<e;t++)r=c[t],o=new Uint32Array(r),a=new Uint16Array(r),h=new Float32Array(r),d(0,l),l+=r.byteLength;function d(t,i,r=!1){const l=2*t;if(a[l+15]===zt){const e=o[t+6];let i=1/0,r=1/0,c=1/0,d=-1/0,u=-1/0,p=-1/0;for(let t=3*e,o=3*(e+a[l+14]);t<o;t++){let e=s[t];const o=n.getX(e),a=n.getY(e),h=n.getZ(e);o<i&&(i=o),o>d&&(d=o),a<r&&(r=a),a>u&&(u=a),h<c&&(c=h),h>p&&(p=h)}return(h[t+0]!==i||h[t+1]!==r||h[t+2]!==c||h[t+3]!==d||h[t+4]!==u||h[t+5]!==p)&&(h[t+0]=i,h[t+1]=r,h[t+2]=c,h[t+3]=d,h[t+4]=u,h[t+5]=p,!0)}{const s=t+8,n=o[t+6],a=s+i,l=n+i;let c=r,u=!1,p=!1;e?c||(u=e.has(a),p=e.has(l),c=!u&&!p):(u=!0,p=!0);const f=c||p;let m=!1;(c||u)&&(m=d(s,i,c));let g=!1;f&&(g=d(n,i,c));const _=m||g;if(_)for(let e=0;e<3;e++){const i=s+e,r=n+e,o=h[i],a=h[i+3],l=h[r],c=h[r+3];h[t+e]=o<l?o:l,h[t+e+3]=a>c?a:c}return _}}}const Fe=new i.Box3;function Ve(t,e,i,s){return Lt(t,e,Fe),i.intersectBox(Fe,s)}function Ze(t,e,i,s,n,r,o){const{geometry:a}=i,{index:h}=a,l=a.attributes.position;for(let a=t,c=e+t;a<c;a++){let t;if(t=i.resolveTriangleIndex(a),Ne(o,3*t,h,l),o.needsUpdate=!0,s(o,t,n,r))return!0}return!1}const je=new i.Vector3;function He(t,e,i,s,n){ge.setBuffer(t._roots[e]),Ye(0,t,i,s,n),ge.clearBuffer()}function Ye(t,e,i,s,n){const{float32Array:r,uint16Array:o,uint32Array:a}=ge,h=2*t;if(ce(h,o)){!function(t,e,i,s,n,r){const{geometry:o,_indirectBuffer:a}=t;for(let t=s,a=s+n;t<a;t++)Ue(o,e,i,t,r)}(e,i,s,de(t,a),ue(h,o),n)}else{const o=pe(t);Ve(o,r,s,je)&&Ye(o,e,i,s,n);const h=fe(t,a);Ve(h,r,s,je)&&Ye(h,e,i,s,n)}}const We=new i.Vector3,$e=["x","y","z"];function Xe(t,e,i,s){ge.setBuffer(t._roots[e]);const n=Ge(0,t,i,s);return ge.clearBuffer(),n}function Ge(t,e,i,s){const{float32Array:n,uint16Array:r,uint32Array:o}=ge;let a=2*t;if(ce(a,r)){return function(t,e,i,s,n){const{geometry:r,_indirectBuffer:o}=t;let a=1/0,h=null;for(let t=s,o=s+n;t<o;t++){let s;s=Ue(r,e,i,t),s&&s.distance<a&&(h=s,a=s.distance)}return h}(e,i,s,de(t,o),ue(a,r))}{const r=me(t,o),a=$e[r],h=s.direction[a]>=0;let l,c;h?(l=pe(t),c=fe(t,o)):(l=fe(t,o),c=pe(t));const d=Ve(l,n,s,We)?Ge(l,e,i,s):null;if(d){const t=d.point[a];if(h?t<=n[c+r]:t>=n[c+r+3])return d}const u=Ve(c,n,s,We)?Ge(c,e,i,s):null;return d&&u?d.distance<=u.distance?d:u:d||u||null}}const Qe=new i.Box3,qe=new re,Ke=new re,Je=new i.Matrix4,ti=new oe,ei=new oe;function ii(t,e,i,s){ge.setBuffer(t._roots[e]);const n=si(0,t,i,s);return ge.clearBuffer(),n}function si(t,e,i,s,n=null){const{float32Array:r,uint16Array:o,uint32Array:a}=ge;let h=2*t;null===n&&(i.boundingBox||i.computeBoundingBox(),ti.set(i.boundingBox.min,i.boundingBox.max,s),n=ti);if(!ce(h,o)){const o=t+8,h=a[t+6];Lt(o,r,Qe);if(n.intersectsBox(Qe)&&si(o,e,i,s,n))return!0;Lt(h,r,Qe);return!!(n.intersectsBox(Qe)&&si(h,e,i,s,n))}{const n=e.geometry,l=n.index,c=n.attributes.position,d=i.index,u=i.attributes.position,p=de(t,a),f=ue(h,o);if(Je.copy(s).invert(),i.boundsTree){Lt(t,r,ei),ei.matrix.copy(Je),ei.needsUpdate=!0;return i.boundsTree.shapecast({intersectsBounds:t=>ei.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(s),t.b.applyMatrix4(s),t.c.applyMatrix4(s),t.needsUpdate=!0;for(let e=3*p,i=3*(f+p);e<i;e+=3)if(Ne(Ke,e,l,c),Ke.needsUpdate=!0,t.intersectsTriangle(Ke))return!0;return!1}})}for(let t=3*p,e=3*(f+p);t<e;t+=3){Ne(qe,t,l,c),qe.a.applyMatrix4(Je),qe.b.applyMatrix4(Je),qe.c.applyMatrix4(Je),qe.needsUpdate=!0;for(let t=0,e=d.count;t<e;t+=3)if(Ne(Ke,t,d,u),Ke.needsUpdate=!0,qe.intersectsTriangle(Ke))return!0}}}const ni=new i.Matrix4,ri=new oe,oi=new oe,ai=new i.Vector3,hi=new i.Vector3,li=new i.Vector3,ci=new i.Vector3;function di(t,e,i,s={},n={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),ri.set(e.boundingBox.min,e.boundingBox.max,i),ri.needsUpdate=!0;const a=t.geometry,h=a.attributes.position,l=a.index,c=e.attributes.position,d=e.index,u=le.getPrimitive(),p=le.getPrimitive();let f=ai,m=hi,g=null,_=null;n&&(g=li,_=ci);let y=1/0,w=null,v=null;return ni.copy(i).invert(),oi.matrix.copy(ni),t.shapecast({boundsTraverseOrder:t=>ri.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o&&(e&&(oi.min.copy(t.min),oi.max.copy(t.max),oi.needsUpdate=!0),!0),intersectsRange:(t,s)=>{if(e.boundsTree){return e.boundsTree.shapecast({boundsTraverseOrder:t=>oi.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o,intersectsRange:(e,n)=>{for(let o=e,a=e+n;o<a;o++){Ne(p,3*o,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=t,i=t+s;e<i;e++){Ne(u,3*e,l,h),u.needsUpdate=!0;const t=u.distanceToTriangle(p,f,g);if(t<y&&(m.copy(f),_&&_.copy(g),y=t,w=e,v=o),t<r)return!0}}}})}for(let n=0,o=Dt(e);n<o;n++){Ne(p,3*n,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=t,i=t+s;e<i;e++){Ne(u,3*e,l,h),u.needsUpdate=!0;const t=u.distanceToTriangle(p,f,g);if(t<y&&(m.copy(f),_&&_.copy(g),y=t,w=e,v=n),t<r)return!0}}}}),le.releasePrimitive(u),le.releasePrimitive(p),y===1/0?null:(s.point?s.point.copy(m):s.point=m.clone(),s.distance=y,s.faceIndex=w,n&&(n.point?n.point.copy(_):n.point=_.clone(),n.point.applyMatrix4(ni),m.applyMatrix4(ni),n.distance=m.sub(n.point).length(),n.faceIndex=v),s)}function ui(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const i=t.geometry,s=i.index?i.index.array:null,n=i.attributes.position;let r,o,a,h,l=0;const c=t._roots;for(let t=0,e=c.length;t<e;t++)r=c[t],o=new Uint32Array(r),a=new Uint16Array(r),h=new Float32Array(r),d(0,l),l+=r.byteLength;function d(i,r,l=!1){const c=2*i;if(a[c+15]===zt){const e=o[i+6];let r=1/0,l=1/0,d=1/0,u=-1/0,p=-1/0,f=-1/0;for(let i=e,o=e+a[c+14];i<o;i++){const e=3*t.resolveTriangleIndex(i);for(let t=0;t<3;t++){let i=e+t;i=s?s[i]:i;const o=n.getX(i),a=n.getY(i),h=n.getZ(i);o<r&&(r=o),o>u&&(u=o),a<l&&(l=a),a>p&&(p=a),h<d&&(d=h),h>f&&(f=h)}}return(h[i+0]!==r||h[i+1]!==l||h[i+2]!==d||h[i+3]!==u||h[i+4]!==p||h[i+5]!==f)&&(h[i+0]=r,h[i+1]=l,h[i+2]=d,h[i+3]=u,h[i+4]=p,h[i+5]=f,!0)}{const t=i+8,s=o[i+6],n=t+r,a=s+r;let c=l,u=!1,p=!1;e?c||(u=e.has(n),p=e.has(a),c=!u&&!p):(u=!0,p=!0);const f=c||p;let m=!1;(c||u)&&(m=d(t,r,c));let g=!1;f&&(g=d(s,r,c));const _=m||g;if(_)for(let e=0;e<3;e++){const n=t+e,r=s+e,o=h[n],a=h[n+3],l=h[r],c=h[r+3];h[i+e]=o<l?o:l,h[i+e+3]=a>c?a:c}return _}}}const pi=new i.Vector3;function fi(t,e,i,s,n){ge.setBuffer(t._roots[e]),mi(0,t,i,s,n),ge.clearBuffer()}function mi(t,e,i,s,n){const{float32Array:r,uint16Array:o,uint32Array:a}=ge,h=2*t;if(ce(h,o)){!function(t,e,i,s,n,r){const{geometry:o,_indirectBuffer:a}=t;for(let t=s,h=s+n;t<h;t++)Ue(o,e,i,a?a[t]:t,r)}(e,i,s,de(t,a),ue(h,o),n)}else{const o=pe(t);Ve(o,r,s,pi)&&mi(o,e,i,s,n);const h=fe(t,a);Ve(h,r,s,pi)&&mi(h,e,i,s,n)}}const gi=new i.Vector3,_i=["x","y","z"];function yi(t,e,i,s){ge.setBuffer(t._roots[e]);const n=wi(0,t,i,s);return ge.clearBuffer(),n}function wi(t,e,i,s){const{float32Array:n,uint16Array:r,uint32Array:o}=ge;let a=2*t;if(ce(a,r)){return function(t,e,i,s,n){const{geometry:r,_indirectBuffer:o}=t;let a=1/0,h=null;for(let t=s,l=s+n;t<l;t++){let s;s=Ue(r,e,i,o?o[t]:t),s&&s.distance<a&&(h=s,a=s.distance)}return h}(e,i,s,de(t,o),ue(a,r))}{const r=me(t,o),a=_i[r],h=s.direction[a]>=0;let l,c;h?(l=pe(t),c=fe(t,o)):(l=fe(t,o),c=pe(t));const d=Ve(l,n,s,gi)?wi(l,e,i,s):null;if(d){const t=d.point[a];if(h?t<=n[c+r]:t>=n[c+r+3])return d}const u=Ve(c,n,s,gi)?wi(c,e,i,s):null;return d&&u?d.distance<=u.distance?d:u:d||u||null}}const vi=new i.Box3,bi=new re,xi=new re,Ti=new i.Matrix4,Ei=new oe,Ci=new oe;function Oi(t,e,i,s){ge.setBuffer(t._roots[e]);const n=Ai(0,t,i,s);return ge.clearBuffer(),n}function Ai(t,e,i,s,n=null){const{float32Array:r,uint16Array:o,uint32Array:a}=ge;let h=2*t;null===n&&(i.boundingBox||i.computeBoundingBox(),Ei.set(i.boundingBox.min,i.boundingBox.max,s),n=Ei);if(!ce(h,o)){const o=t+8,h=a[t+6];Lt(o,r,vi);if(n.intersectsBox(vi)&&Ai(o,e,i,s,n))return!0;Lt(h,r,vi);return!!(n.intersectsBox(vi)&&Ai(h,e,i,s,n))}{const n=e.geometry,l=n.index,c=n.attributes.position,d=i.index,u=i.attributes.position,p=de(t,a),f=ue(h,o);if(Ti.copy(s).invert(),i.boundsTree){Lt(t,r,Ci),Ci.matrix.copy(Ti),Ci.needsUpdate=!0;return i.boundsTree.shapecast({intersectsBounds:t=>Ci.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(s),t.b.applyMatrix4(s),t.c.applyMatrix4(s),t.needsUpdate=!0;for(let i=p,s=f+p;i<s;i++)if(Ne(xi,3*e.resolveTriangleIndex(i),l,c),xi.needsUpdate=!0,t.intersectsTriangle(xi))return!0;return!1}})}for(let t=p,i=f+p;t<i;t++){const i=e.resolveTriangleIndex(t);Ne(bi,3*i,l,c),bi.a.applyMatrix4(Ti),bi.b.applyMatrix4(Ti),bi.c.applyMatrix4(Ti),bi.needsUpdate=!0;for(let t=0,e=d.count;t<e;t+=3)if(Ne(xi,t,d,u),xi.needsUpdate=!0,bi.intersectsTriangle(xi))return!0}}}const Si=new i.Matrix4,Pi=new oe,ki=new oe,zi=new i.Vector3,Mi=new i.Vector3,Bi=new i.Vector3,Di=new i.Vector3;function Ii(t,e,i,s={},n={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),Pi.set(e.boundingBox.min,e.boundingBox.max,i),Pi.needsUpdate=!0;const a=t.geometry,h=a.attributes.position,l=a.index,c=e.attributes.position,d=e.index,u=le.getPrimitive(),p=le.getPrimitive();let f=zi,m=Mi,g=null,_=null;n&&(g=Bi,_=Di);let y=1/0,w=null,v=null;return Si.copy(i).invert(),ki.matrix.copy(Si),t.shapecast({boundsTraverseOrder:t=>Pi.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o&&(e&&(ki.min.copy(t.min),ki.max.copy(t.max),ki.needsUpdate=!0),!0),intersectsRange:(s,n)=>{if(e.boundsTree){const a=e.boundsTree;return a.shapecast({boundsTraverseOrder:t=>ki.distanceToBox(t),intersectsBounds:(t,e,i)=>i<y&&i<o,intersectsRange:(e,o)=>{for(let b=e,x=e+o;b<x;b++){const e=a.resolveTriangleIndex(b);Ne(p,3*e,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=s,i=s+n;e<i;e++){const i=t.resolveTriangleIndex(e);Ne(u,3*i,l,h),u.needsUpdate=!0;const s=u.distanceToTriangle(p,f,g);if(s<y&&(m.copy(f),_&&_.copy(g),y=s,w=e,v=b),s<r)return!0}}}})}for(let o=0,a=Dt(e);o<a;o++){Ne(p,3*o,d,c),p.a.applyMatrix4(i),p.b.applyMatrix4(i),p.c.applyMatrix4(i),p.needsUpdate=!0;for(let e=s,i=s+n;e<i;e++){const i=t.resolveTriangleIndex(e);Ne(u,3*i,l,h),u.needsUpdate=!0;const s=u.distanceToTriangle(p,f,g);if(s<y&&(m.copy(f),_&&_.copy(g),y=s,w=e,v=o),s<r)return!0}}}}),le.releasePrimitive(u),le.releasePrimitive(p),y===1/0?null:(s.point?s.point.copy(m):s.point=m.clone(),s.distance=y,s.faceIndex=w,n&&(n.point?n.point.copy(_):n.point=_.clone(),n.point.applyMatrix4(Si),m.applyMatrix4(Si),n.distance=m.sub(n.point).length(),n.faceIndex=v),s)}const Ui=new ge.constructor,Ni=new ge.constructor,Li=new ae((()=>new i.Box3)),Ri=new i.Box3,Fi=new i.Box3,Vi=new i.Box3,Zi=new i.Box3;let ji=!1;function Hi(t,e,i,s,n,r=0,o=0,a=0,h=0,l=null,c=!1){let d,u;c?(d=Ni,u=Ui):(d=Ui,u=Ni);const p=d.float32Array,f=d.uint32Array,m=d.uint16Array,g=u.float32Array,_=u.uint32Array,y=u.uint16Array,w=2*e,v=ce(2*t,m),b=ce(w,y);let x=!1;if(b&&v)x=c?n(de(e,_),ue(2*e,y),de(t,f),ue(2*t,m),h,o+e,a,r+t):n(de(t,f),ue(2*t,m),de(e,_),ue(2*e,y),a,r+t,h,o+e);else if(b){const l=Li.getPrimitive();Lt(e,g,l),l.applyMatrix4(i);const d=pe(t),u=fe(t,f);Lt(d,p,Ri),Lt(u,p,Fi);const m=l.intersectsBox(Ri),_=l.intersectsBox(Fi);x=m&&Hi(e,d,s,i,n,o,r,h,a+1,l,!c)||_&&Hi(e,u,s,i,n,o,r,h,a+1,l,!c),Li.releasePrimitive(l)}else{const d=pe(e),u=fe(e,_);Lt(d,g,Vi),Lt(u,g,Zi);const m=l.intersectsBox(Vi),y=l.intersectsBox(Zi);if(m&&y)x=Hi(t,d,i,s,n,r,o,a,h+1,l,c)||Hi(t,u,i,s,n,r,o,a,h+1,l,c);else if(m)if(v)x=Hi(t,d,i,s,n,r,o,a,h+1,l,c);else{const e=Li.getPrimitive();e.copy(Vi).applyMatrix4(i);const l=pe(t),u=fe(t,f);Lt(l,p,Ri),Lt(u,p,Fi);const m=e.intersectsBox(Ri),g=e.intersectsBox(Fi);x=m&&Hi(d,l,s,i,n,o,r,h,a+1,e,!c)||g&&Hi(d,u,s,i,n,o,r,h,a+1,e,!c),Li.releasePrimitive(e)}else if(y)if(v)x=Hi(t,u,i,s,n,r,o,a,h+1,l,c);else{const e=Li.getPrimitive();e.copy(Zi).applyMatrix4(i);const l=pe(t),d=fe(t,f);Lt(l,p,Ri),Lt(d,p,Fi);const m=e.intersectsBox(Ri),g=e.intersectsBox(Fi);x=m&&Hi(u,l,s,i,n,o,r,h,a+1,e,!c)||g&&Hi(u,d,s,i,n,o,r,h,a+1,e,!c),Li.releasePrimitive(e)}}return x}const Yi=new oe,Wi=new i.Box3;class $i{static serialize(t,e={}){e={cloneBuffers:!0,...e};const i=t.geometry,s=t._roots,n=t._indirectBuffer,r=i.getIndex();let o;return o=e.cloneBuffers?{roots:s.map((t=>t.slice())),index:r.array.slice(),indirectBuffer:n?n.slice():null}:{roots:s,index:r.array,indirectBuffer:n},o}static deserialize(t,e,s={}){s={setIndex:!0,indirect:Boolean(t.indirectBuffer),...s};const{index:n,roots:r,indirectBuffer:o}=t,a=new $i(e,{...s,[Bt]:!0});if(a._roots=r,a._indirectBuffer=o||null,s.setIndex){const s=e.getIndex();if(null===s){const s=new i.BufferAttribute(t.index,1,!1);e.setIndex(s)}else s.array!==n&&(s.array.set(n),s.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(t,e={}){if(!t.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((e=Object.assign({strategy:0,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[Bt]:!1},e)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=t,this._roots=null,this._indirectBuffer=null,e[Bt]||(Jt(this,e),!t.boundingBox&&e.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new i.Box3)));const{_indirectBuffer:s}=this;this.resolveTriangleIndex=e.indirect?t=>s[t]:t=>t}refit(t=null){return(this.indirect?ui:Re)(this,t)}traverse(t,e=0){const i=this._roots[e],s=new Uint32Array(i),n=new Uint16Array(i);!function e(r,o=0){const a=2*r,h=n[a+15]===zt;if(h){const e=s[r+6],l=n[a+14];t(o,h,new Float32Array(i,4*r,6),e,l)}else{const n=r+8,a=s[r+6],l=s[r+7];t(o,h,new Float32Array(i,4*r,6),l)||(e(n,o+1),e(a,o+1))}}(0)}raycast(t,e=i.FrontSide){const s=this._roots,n=this.geometry,r=[],o=e.isMaterial,a=Array.isArray(e),h=n.groups,l=o?e.side:e,c=this.indirect?fi:He;for(let i=0,n=s.length;i<n;i++){const s=a?e[h[i].materialIndex].side:l,n=r.length;if(c(this,i,s,t,r),a){const t=h[i].materialIndex;for(let e=n,i=r.length;e<i;e++)r[e].face.materialIndex=t}}return r}raycastFirst(t,e=i.FrontSide){const s=this._roots,n=this.geometry,r=e.isMaterial,o=Array.isArray(e);let a=null;const h=n.groups,l=r?e.side:e,c=this.indirect?yi:Xe;for(let i=0,n=s.length;i<n;i++){const s=c(this,i,o?e[h[i].materialIndex].side:l,t);null!=s&&(null==a||s.distance<a.distance)&&(a=s,o&&(s.face.materialIndex=h[i].materialIndex))}return a}intersectsGeometry(t,e){let i=!1;const s=this._roots,n=this.indirect?Oi:ii;for(let r=0,o=s.length;r<o&&(i=n(this,r,t,e),!i);r++);return i}shapecast(t){const e=le.getPrimitive(),i=this.indirect?Ze:Le;let{boundsTraverseOrder:s,intersectsBounds:n,intersectsRange:r,intersectsTriangle:o}=t;if(r&&o){const t=r;r=(s,n,r,a,h)=>!!t(s,n,r,a,h)||i(s,n,this,o,r,a,e)}else r||(r=o?(t,s,n,r)=>i(t,s,this,o,n,r,e):(t,e,i)=>i);let a=!1,h=0;const l=this._roots;for(let t=0,e=l.length;t<e;t++){const e=l[t];if(a=be(this,t,n,r,s,h),a)break;h+=e.byteLength}return le.releasePrimitive(e),a}bvhcast(t,e,s){let{intersectsRanges:n,intersectsTriangles:r}=s;const o=le.getPrimitive(),a=this.geometry.index,h=this.geometry.attributes.position,l=this.indirect?t=>{const e=this.resolveTriangleIndex(t);Ne(o,3*e,a,h)}:t=>{Ne(o,3*t,a,h)},c=le.getPrimitive(),d=t.geometry.index,u=t.geometry.attributes.position,p=t.indirect?e=>{const i=t.resolveTriangleIndex(e);Ne(c,3*i,d,u)}:t=>{Ne(c,3*t,d,u)};if(r){const t=(t,i,s,n,a,h,d,u)=>{for(let f=s,m=s+n;f<m;f++){p(f),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let e=t,s=t+i;e<s;e++)if(l(e),o.needsUpdate=!0,r(o,c,e,f,a,h,d,u))return!0}return!1};if(n){const e=n;n=function(i,s,n,r,o,a,h,l){return!!e(i,s,n,r,o,a,h,l)||t(i,s,n,r,o,a,h,l)}}else n=t}return function(t,e,s,n){if(ji)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");ji=!0;const r=t._roots,o=e._roots;let a,h=0,l=0;const c=(new i.Matrix4).copy(s).invert();for(let t=0,e=r.length;t<e;t++){Ui.setBuffer(r[t]),l=0;const e=Li.getPrimitive();Lt(0,Ui.float32Array,e),e.applyMatrix4(c);for(let i=0,r=o.length;i<r&&(Ni.setBuffer(o[t]),a=Hi(0,0,s,c,n,h,l,0,0,e),Ni.clearBuffer(),l+=o[i].length,!a);i++);if(Li.releasePrimitive(e),Ui.clearBuffer(),h+=r[t].length,a)break}return ji=!1,a}(this,t,e,n)}intersectsBox(t,e){return Yi.set(t.min,t.max,e),Yi.needsUpdate=!0,this.shapecast({intersectsBounds:t=>Yi.intersectsBox(t),intersectsTriangle:t=>Yi.intersectsTriangle(t)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,i={},s={},n=0,r=1/0){return(this.indirect?Ii:di)(this,t,e,i,s,n,r)}closestPointToPoint(t,e={},i=0,s=1/0){return function(t,e,i={},s=0,n=1/0){const r=s*s,o=n*n;let a=1/0,h=null;if(t.shapecast({boundsTraverseOrder:t=>(Te.copy(e).clamp(t.min,t.max),Te.distanceToSquared(e)),intersectsBounds:(t,e,i)=>i<a&&i<o,intersectsTriangle:(t,i)=>{t.closestPointToPoint(e,Te);const s=e.distanceToSquared(Te);return s<a&&(Ee.copy(Te),a=s,h=i),s<r}}),a===1/0)return null;const l=Math.sqrt(a);return i.point?i.point.copy(Ee):i.point=Ee.clone(),i.distance=l,i.faceIndex=h,i}(this,t,e,i,s)}getBoundingBox(t){t.makeEmpty();return this._roots.forEach((e=>{Lt(0,new Float32Array(e),Wi),t.union(Wi)})),t}}function Xi(t,e,i){return null===t?null:(t.point.applyMatrix4(e.matrixWorld),t.distance=t.point.distanceTo(i.ray.origin),t.object=e,t.distance<i.near||t.distance>i.far?null:t)}const Gi=new i.Ray,Qi=new i.Matrix4,qi=i.Mesh.prototype.raycast;function Ki(t,e){if(this.geometry.boundsTree){if(void 0===this.material)return;Qi.copy(this.matrixWorld).invert(),Gi.copy(t.ray).applyMatrix4(Qi);const i=this.geometry.boundsTree;if(!0===t.firstHitOnly){const s=Xi(i.raycastFirst(Gi,this.material),this,t);s&&e.push(s)}else{const s=i.raycast(Gi,this.material);for(let i=0,n=s.length;i<n;i++){const n=Xi(s[i],this,t);n&&e.push(n)}}}else qi.call(this,t,e)}function Ji(t){return this.boundsTree=new $i(this,t),this.boundsTree}function ts(){this.boundsTree=null}const es=class t{constructor(){e(this,"onDisposed",new o),e(this,"list",new Map),e(this,"enabled",!1),e(this,"_clock"),e(this,"onInit",new o),e(this,"update",(()=>{if(!this.enabled)return;const t=this._clock.getDelta();for(const[e,i]of this.list)i.enabled&&i.isUpdateable()&&i.update(t);requestAnimationFrame(this.update)})),this._clock=new r.Clock,t.setupBVH()}add(t,e){if(this.list.has(t))throw new Error("You're trying to add a component that already exists in the components instance. Use Components.get() instead.");w.validate(t),this.list.set(t,e)}get(t){const e=t.uuid;if(!this.list.has(e)){const i=new t(this);return this.list.has(e)||this.add(e,i),i}return this.list.get(e)}init(){this.enabled=!0,this._clock.start(),this.update(),this.onInit.trigger()}dispose(){this.enabled=!1;for(const[t,e]of this.list)e.enabled=!1,e.isDisposeable()&&e.dispose();this._clock.stop(),this.onDisposed.trigger(),this.onDisposed.reset()}static setupBVH(){r.BufferGeometry.prototype.computeBoundsTree=Ji,r.BufferGeometry.prototype.disposeBoundsTree=ts,r.Mesh.prototype.raycast=Ki}};e(es,"release","2.4.3");let is=es;class ss{constructor(t){e(this,"_event"),e(this,"_position",new r.Vector2),e(this,"onDisposed",new o),e(this,"updateMouseInfo",(t=>{this._event=t})),this.dom=t,this.setupEvents(!0)}get position(){return this.updatePosition(!1),this._position.clone()}get rawPosition(){return this.updatePosition(!0),this._position.clone()}dispose(){this.setupEvents(!1),this.onDisposed.trigger(),this.onDisposed.reset()}updatePosition(t){if(this._event){const e=this.dom.getBoundingClientRect();this._position.x=this.getPositionX(e,this._event,t),this._position.y=this.getPositionY(e,this._event,t)}}getPositionY(t,e,i){const s=this.getDataObject(e);return i?s.clientY:-(s.clientY-t.top)/(t.bottom-t.top)*2+1}getPositionX(t,e,i){const s=this.getDataObject(e);return i?s.clientX:(s.clientX-t.left)/(t.right-t.left)*2-1}getDataObject(t){return t instanceof MouseEvent?t:t.touches[0]}setupEvents(t){t?(this.dom.addEventListener("pointermove",this.updateMouseInfo),this.dom.addEventListener("touchstart",this.updateMouseInfo)):(this.dom.removeEventListener("pointermove",this.updateMouseInfo),this.dom.removeEventListener("touchstart",this.updateMouseInfo))}}const ns=class t extends h{constructor(i){super(i),e(this,"onDisposed",new o),e(this,"onFragmentsLoaded",new o),e(this,"onFragmentsDisposed",new o),e(this,"baseCoordinationModel",""),e(this,"baseCoordinationMatrix",new r.Matrix4),e(this,"enabled",!0),e(this,"initialized",!1),e(this,"_core"),this.components.add(t.uuid,this)}get list(){return this.core.models.list}get core(){if(!this._core)throw new Error("FragmentsManager not initialized. Call init() first.");return this._core}dispose(){this.core.dispose(),this.baseCoordinationModel="",this.onFragmentsLoaded.reset(),this.onFragmentsDisposed.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}init(t){this._core=new s.FragmentsModels(t),this.initialized=!0}};e(ns,"uuid","fef46874-46a3-461b-8c44-2922ab77c806");let rs=ns;class os{constructor(t,i){e(this,"enabled",!0),e(this,"components"),e(this,"onDisposed",new o),e(this,"mouse"),e(this,"three",new r.Raycaster),e(this,"world");const s=i.renderer;if(!s)throw new Error("A renderer is needed for the raycaster to work!");this.world=i,this.mouse=new ss(s.three.domElement),this.components=t}dispose(){this.mouse.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}async castRay(t=Array.from(this.world.meshes),e=this.mouse.position){if(!this.world)throw new Error("A world is needed to cast rays!");const i=this.world.camera.three,s=this.components.get(rs),n=this.world.renderer.three.domElement,r=this.mouse.rawPosition;let o=null;if(s.initialized&&(o=await s.core.pick({camera:i,dom:n,mouse:r}),0===t.length))return o;this.three.setFromCamera(e,i);const a=this.intersect(t);return o?a&&a.distance<o.distance?a:o:a}intersect(t=Array.from(this.world.meshes)){const e=this.three.intersectObjects(t),i=this.filterClippingPlanes(e);return i.length>0?i[0]:null}filterClippingPlanes(t){if(!this.world.renderer)throw new Error("Renderer not found!");const e=this.world.renderer.three;if(!e.clippingPlanes)return t;const i=e.clippingPlanes;return t.length<=0||!i||(null==i?void 0:i.length)<=0?t:t.filter((t=>i.every((e=>e.distanceToPoint(t.point)>0))))}}const as=class t extends h{constructor(i){super(i),e(this,"enabled",!0),e(this,"list",new Map),e(this,"onDisposed",new o),i.add(t.uuid,this)}get(t){if(this.list.has(t.uuid))return this.list.get(t.uuid);const e=new os(this.components,t);return this.list.set(t.uuid,e),t.onDisposed.add((()=>{this.delete(t)})),e}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}};e(as,"uuid","d5d8bdf0-db25-4952-b951-b643af207ace");let hs=as;class ls{constructor(t){e(this,"enabled",!1),e(this,"id","FirstPerson"),this.camera=t}set(t){if(this.enabled=t,t){if("Perspective"!==this.camera.projection.current)return void this.camera.set("Orbit");this.setupFirstPersonCamera()}}setupFirstPersonCamera(){const t=this.camera.controls,e=new r.Vector3;t.distance--,t.getPosition(e),t.minDistance=1,t.maxDistance=1,t.distance=1,t.moveTo(e.x,e.y,e.z),t.truckSpeed=50,t.mouseButtons.wheel=xt.ACTION.DOLLY,t.touches.two=xt.ACTION.TOUCH_ZOOM_TRUCK}}class cs{constructor(t){e(this,"enabled",!0),e(this,"id","Orbit"),this.camera=t,this.activateOrbitControls()}set(t){this.enabled=t,t&&this.activateOrbitControls()}activateOrbitControls(){const t=this.camera.controls;t.minDistance=1,t.maxDistance=300;const e=new r.Vector3;t.getPosition(e);const i=e.length();t.distance=i,t.truckSpeed=2;const{rotation:s}=this.camera.three,n=new r.Vector3(0,0,-1).applyEuler(s),o=e.addScaledVector(n,i);t.moveTo(o.x,o.y,o.z)}}class ds{constructor(t){e(this,"enabled",!1),e(this,"id","Plan"),e(this,"mouseAction1"),e(this,"mouseAction2"),e(this,"mouseInitialized",!1),e(this,"defaultAzimuthSpeed"),e(this,"defaultPolarSpeed"),this.camera=t,this.defaultAzimuthSpeed=t.controls.azimuthRotateSpeed,this.defaultPolarSpeed=t.controls.polarRotateSpeed}set(t){this.enabled=t;const e=this.camera.controls;e.azimuthRotateSpeed=t?0:this.defaultAzimuthSpeed,e.polarRotateSpeed=t?0:this.defaultPolarSpeed,this.mouseInitialized||(this.mouseAction1=e.touches.one,this.mouseAction2=e.touches.two,this.mouseInitialized=!0),t?(e.mouseButtons.left=xt.ACTION.TRUCK,e.touches.one=xt.ACTION.TOUCH_TRUCK,e.touches.two=xt.ACTION.TOUCH_ZOOM):(e.mouseButtons.left=xt.ACTION.ROTATE,e.touches.one=this.mouseAction1,e.touches.two=this.mouseAction2)}}class us{constructor(t){e(this,"onChanged",new o),e(this,"current","Perspective"),e(this,"camera"),e(this,"matchOrthoDistanceEnabled",!1),e(this,"_component"),e(this,"_previousDistance",-1),this._component=t,this.camera=t.three}async set(t){this.current!==t&&("Orthographic"===t?this.setOrthoCamera():await this.setPerspectiveCamera(),this.onChanged.trigger(this.camera))}async toggle(){const t="Perspective"===this.current?"Orthographic":"Perspective";await this.set(t)}setOrthoCamera(){if(null===this._component.mode)return;if("FirstPerson"===this._component.mode.id)return;this._previousDistance=this._component.controls.distance,this._component.controls.distance=200;const t=this.getPerspectiveDims();if(!t)return;const{width:e,height:i}=t;this.setupOrthoCamera(i,e),this.camera=this._component.threeOrtho,this.current="Orthographic"}getPerspectiveDims(){const t=this._component.currentWorld;if(!t||!t.renderer)return null;const e=new r.Vector3;this._component.threePersp.getWorldDirection(e);const i=new r.Vector3;this._component.controls.getTarget(i);const s=i.clone().sub(this._component.threePersp.position).dot(e),n=t.renderer.getSize(),o=n.x/n.y,a=this._component.threePersp,h=2*s*Math.atan(a.fov*(Math.PI/180)/2);return{width:h*o,height:h}}setupOrthoCamera(t,e){this._component.controls.mouseButtons.wheel=xt.ACTION.ZOOM,this._component.controls.mouseButtons.middle=xt.ACTION.ZOOM;const i=this._component.threePersp,s=this._component.threeOrtho;s.zoom=1,s.left=e/-2,s.right=e/2,s.top=t/2,s.bottom=t/-2,s.updateProjectionMatrix(),s.position.copy(i.position),s.quaternion.copy(i.quaternion),this._component.controls.camera=s}getDistance(){const t=this._component.threePersp,e=this._component.threeOrtho;return(e.top-e.bottom)/e.zoom/(2*Math.atan(t.fov*(Math.PI/180)/2))}async setPerspectiveCamera(){this._component.controls.mouseButtons.wheel=xt.ACTION.DOLLY,this._component.controls.mouseButtons.middle=xt.ACTION.DOLLY;const t=this._component.threePersp,e=this._component.threeOrtho;t.position.copy(e.position),t.quaternion.copy(e.quaternion),this._component.controls.mouseButtons.wheel=xt.ACTION.DOLLY,this.matchOrthoDistanceEnabled?this._component.controls.distance=this.getDistance():this._component.controls.distance=this._previousDistance,await this._component.controls.zoomTo(1),t.updateProjectionMatrix(),this._component.controls.camera=t,this.camera=t,this.current="Perspective"}}class ps extends Tt{constructor(t){super(t),e(this,"projection"),e(this,"threeOrtho"),e(this,"threePersp"),e(this,"_userInputButtons",{}),e(this,"_frustumSize",50),e(this,"_navigationModes",new Map),e(this,"_mode",null),e(this,"previousSize",null),this.threePersp=this.three,this.threeOrtho=this.newOrthoCamera(),this.projection=new us(this),this.onAspectUpdated.add((()=>{this.setOrthoPerspCameraAspect()})),this.projection.onChanged.add((t=>{this.three=t,this.updateAspect()})),this.onWorldChanged.add((({action:t})=>{"added"===t&&(this._navigationModes.clear(),this._navigationModes.set("Orbit",new cs(this)),this._navigationModes.set("FirstPerson",new ls(this)),this._navigationModes.set("Plan",new ds(this)),this._mode=this._navigationModes.get("Orbit"),this.mode.set(!0,{preventTargetAdjustment:!0}),this.currentWorld&&this.currentWorld.renderer&&(this.previousSize=this.currentWorld.renderer.getSize().clone()))}))}get mode(){if(!this._mode)throw new Error("Mode not found, camera not initialized");return this._mode}dispose(){super.dispose(),this.threeOrtho.removeFromParent()}set(t){if(null!==this.mode&&this.mode.id!==t){if(this.mode.set(!1),!this._navigationModes.has(t))throw new Error("The specified mode does not exist!");this._mode=this._navigationModes.get(t),this.mode.set(!0)}}async fit(t,e=1.5){if(!this.enabled)return;const i=Number.MAX_VALUE,s=Number.MIN_VALUE,n=new r.Vector3(i,i,i),o=new r.Vector3(s,s,s);for(const e of t){const t=(new r.Box3).setFromObject(e);t.min.x<n.x&&(n.x=t.min.x),t.min.y<n.y&&(n.y=t.min.y),t.min.z<n.z&&(n.z=t.min.z),t.max.x>o.x&&(o.x=t.max.x),t.max.y>o.y&&(o.y=t.max.y),t.max.z>o.z&&(o.z=t.max.z)}const a=new r.Box3(n,o),h=new r.Vector3;a.getSize(h);const l=new r.Vector3;a.getCenter(l);const c=Math.max(h.x,h.y,h.z)*e,d=new r.Sphere(l,c);await this.controls.fitToSphere(d,!0)}setUserInput(t){t?this.enableUserInput():this.disableUserInput()}disableUserInput(){this._userInputButtons.left=this.controls.mouseButtons.left,this._userInputButtons.right=this.controls.mouseButtons.right,this._userInputButtons.middle=this.controls.mouseButtons.middle,this._userInputButtons.wheel=this.controls.mouseButtons.wheel,this.controls.mouseButtons.left=0,this.controls.mouseButtons.right=0,this.controls.mouseButtons.middle=0,this.controls.mouseButtons.wheel=0}enableUserInput(){0!==Object.keys(this._userInputButtons).length&&(this.controls.mouseButtons.left=this._userInputButtons.left,this.controls.mouseButtons.right=this._userInputButtons.right,this.controls.mouseButtons.middle=this._userInputButtons.middle,this.controls.mouseButtons.wheel=this._userInputButtons.wheel)}newOrthoCamera(){const t=window.innerWidth/window.innerHeight;return new r.OrthographicCamera(this._frustumSize*t/-2,this._frustumSize*t/2,this._frustumSize/2,this._frustumSize/-2,.1,1e3)}setOrthoPerspCameraAspect(){if(!this.currentWorld||!this.currentWorld.renderer)return;if(!this.previousSize)return;const t=this.currentWorld.renderer.getSize(),e=this.threeOrtho.top,i=this.threeOrtho.right,s=e*(t.y/this.previousSize.y),n=i*(t.x/this.previousSize.x);this.threeOrtho.left=-n,this.threeOrtho.right=n,this.threeOrtho.top=s,this.threeOrtho.bottom=-s,this.threeOrtho.updateProjectionMatrix(),this.previousSize.copy(t)}}var fs="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function ms(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function gs(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var _s={exports:{}};
/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/const ys=ms(_s.exports=function t(e,i,s){function n(o,a){if(!i[o]){if(!e[o]){if(!a&&gs)return gs(o);if(r)return r(o,!0);var h=new Error("Cannot find module '"+o+"'");throw h.code="MODULE_NOT_FOUND",h}var l=i[o]={exports:{}};e[o][0].call(l.exports,(function(t){return n(e[o][1][t]||t)}),l,l.exports,t,e,i,s)}return i[o].exports}for(var r=gs,o=0;o<s.length;o++)n(s[o]);return n}({1:[function(t,e,i){var s=t("./utils"),n=t("./support"),r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";i.encode=function(t){for(var e,i,n,o,a,h,l,c=[],d=0,u=t.length,p=u,f="string"!==s.getTypeOf(t);d<t.length;)p=u-d,n=f?(e=t[d++],i=d<u?t[d++]:0,d<u?t[d++]:0):(e=t.charCodeAt(d++),i=d<u?t.charCodeAt(d++):0,d<u?t.charCodeAt(d++):0),o=e>>2,a=(3&e)<<4|i>>4,h=1<p?(15&i)<<2|n>>6:64,l=2<p?63&n:64,c.push(r.charAt(o)+r.charAt(a)+r.charAt(h)+r.charAt(l));return c.join("")},i.decode=function(t){var e,i,s,o,a,h,l=0,c=0,d="data:";if(t.substr(0,d.length)===d)throw new Error("Invalid base64 input, it looks like a data url.");var u,p=3*(t=t.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(t.charAt(t.length-1)===r.charAt(64)&&p--,t.charAt(t.length-2)===r.charAt(64)&&p--,p%1!=0)throw new Error("Invalid base64 input, bad content length.");for(u=n.uint8array?new Uint8Array(0|p):new Array(0|p);l<t.length;)e=r.indexOf(t.charAt(l++))<<2|(o=r.indexOf(t.charAt(l++)))>>4,i=(15&o)<<4|(a=r.indexOf(t.charAt(l++)))>>2,s=(3&a)<<6|(h=r.indexOf(t.charAt(l++))),u[c++]=e,64!==a&&(u[c++]=i),64!==h&&(u[c++]=s);return u}},{"./support":30,"./utils":32}],2:[function(t,e,i){var s=t("./external"),n=t("./stream/DataWorker"),r=t("./stream/Crc32Probe"),o=t("./stream/DataLengthProbe");function a(t,e,i,s,n){this.compressedSize=t,this.uncompressedSize=e,this.crc32=i,this.compression=s,this.compressedContent=n}a.prototype={getContentWorker:function(){var t=new n(s.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new o("data_length")),e=this;return t.on("end",(function(){if(this.streamInfo.data_length!==e.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")})),t},getCompressedWorker:function(){return new n(s.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},a.createWorkerFrom=function(t,e,i){return t.pipe(new r).pipe(new o("uncompressedSize")).pipe(e.compressWorker(i)).pipe(new o("compressedSize")).withStreamInfo("compression",e)},e.exports=a},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,e,i){var s=t("./stream/GenericWorker");i.STORE={magic:"\0\0",compressWorker:function(){return new s("STORE compression")},uncompressWorker:function(){return new s("STORE decompression")}},i.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,e,i){var s=t("./utils"),n=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var s=0;s<8;s++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();e.exports=function(t,e){return void 0!==t&&t.length?"string"!==s.getTypeOf(t)?function(t,e,i,s){var r=n,o=s+i;t^=-1;for(var a=s;a<o;a++)t=t>>>8^r[255&(t^e[a])];return~t}(0|e,t,t.length,0):function(t,e,i,s){var r=n,o=s+i;t^=-1;for(var a=s;a<o;a++)t=t>>>8^r[255&(t^e.charCodeAt(a))];return~t}(0|e,t,t.length,0):0}},{"./utils":32}],5:[function(t,e,i){i.base64=!1,i.binary=!1,i.dir=!1,i.createFolders=!0,i.date=null,i.compression=null,i.compressionOptions=null,i.comment=null,i.unixPermissions=null,i.dosPermissions=null},{}],6:[function(t,e,i){var s=null;s="undefined"!=typeof Promise?Promise:t("lie"),e.exports={Promise:s}},{lie:37}],7:[function(t,e,i){var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,n=t("pako"),r=t("./utils"),o=t("./stream/GenericWorker"),a=s?"uint8array":"array";function h(t,e){o.call(this,"FlateWorker/"+t),this._pako=null,this._pakoAction=t,this._pakoOptions=e,this.meta={}}i.magic="\b\0",r.inherits(h,o),h.prototype.processChunk=function(t){this.meta=t.meta,null===this._pako&&this._createPako(),this._pako.push(r.transformTo(a,t.data),!1)},h.prototype.flush=function(){o.prototype.flush.call(this),null===this._pako&&this._createPako(),this._pako.push([],!0)},h.prototype.cleanUp=function(){o.prototype.cleanUp.call(this),this._pako=null},h.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var t=this;this._pako.onData=function(e){t.push({data:e,meta:t.meta})}},i.compressWorker=function(t){return new h("Deflate",t)},i.uncompressWorker=function(){return new h("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,e,i){function s(t,e){var i,s="";for(i=0;i<e;i++)s+=String.fromCharCode(255&t),t>>>=8;return s}function n(t,e,i,n,o,c){var d,u,p=t.file,f=t.compression,m=c!==a.utf8encode,g=r.transformTo("string",c(p.name)),_=r.transformTo("string",a.utf8encode(p.name)),y=p.comment,w=r.transformTo("string",c(y)),v=r.transformTo("string",a.utf8encode(y)),b=_.length!==p.name.length,x=v.length!==y.length,T="",E="",C="",O=p.dir,A=p.date,S={crc32:0,compressedSize:0,uncompressedSize:0};e&&!i||(S.crc32=t.crc32,S.compressedSize=t.compressedSize,S.uncompressedSize=t.uncompressedSize);var P=0;e&&(P|=8),m||!b&&!x||(P|=2048);var k,z,M,B=0,D=0;O&&(B|=16),"UNIX"===o?(D=798,B|=(k=p.unixPermissions,z=O,M=k,k||(M=z?16893:33204),(65535&M)<<16)):(D=20,B|=function(t){return 63&(t||0)}(p.dosPermissions)),d=A.getUTCHours(),d<<=6,d|=A.getUTCMinutes(),d<<=5,d|=A.getUTCSeconds()/2,u=A.getUTCFullYear()-1980,u<<=4,u|=A.getUTCMonth()+1,u<<=5,u|=A.getUTCDate(),b&&(E=s(1,1)+s(h(g),4)+_,T+="up"+s(E.length,2)+E),x&&(C=s(1,1)+s(h(w),4)+v,T+="uc"+s(C.length,2)+C);var I="";return I+="\n\0",I+=s(P,2),I+=f.magic,I+=s(d,2),I+=s(u,2),I+=s(S.crc32,4),I+=s(S.compressedSize,4),I+=s(S.uncompressedSize,4),I+=s(g.length,2),I+=s(T.length,2),{fileRecord:l.LOCAL_FILE_HEADER+I+g+T,dirRecord:l.CENTRAL_FILE_HEADER+s(D,2)+I+s(w.length,2)+"\0\0\0\0"+s(B,4)+s(n,4)+g+T+w}}var r=t("../utils"),o=t("../stream/GenericWorker"),a=t("../utf8"),h=t("../crc32"),l=t("../signature");function c(t,e,i,s){o.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=e,this.zipPlatform=i,this.encodeFileName=s,this.streamFiles=t,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}r.inherits(c,o),c.prototype.push=function(t){var e=t.meta.percent||0,i=this.entriesCount,s=this._sources.length;this.accumulate?this.contentBuffer.push(t):(this.bytesWritten+=t.data.length,o.prototype.push.call(this,{data:t.data,meta:{currentFile:this.currentFile,percent:i?(e+100*(i-s-1))/i:100}}))},c.prototype.openedSource=function(t){this.currentSourceOffset=this.bytesWritten,this.currentFile=t.file.name;var e=this.streamFiles&&!t.file.dir;if(e){var i=n(t,e,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:i.fileRecord,meta:{percent:0}})}else this.accumulate=!0},c.prototype.closedSource=function(t){this.accumulate=!1;var e,i=this.streamFiles&&!t.file.dir,r=n(t,i,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(r.dirRecord),i)this.push({data:(e=t,l.DATA_DESCRIPTOR+s(e.crc32,4)+s(e.compressedSize,4)+s(e.uncompressedSize,4)),meta:{percent:100}});else for(this.push({data:r.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},c.prototype.flush=function(){for(var t=this.bytesWritten,e=0;e<this.dirRecords.length;e++)this.push({data:this.dirRecords[e],meta:{percent:100}});var i,n,o,a,h,c,d=this.bytesWritten-t,u=(i=this.dirRecords.length,n=d,o=t,a=this.zipComment,h=this.encodeFileName,c=r.transformTo("string",h(a)),l.CENTRAL_DIRECTORY_END+"\0\0\0\0"+s(i,2)+s(i,2)+s(n,4)+s(o,4)+s(c.length,2)+c);this.push({data:u,meta:{percent:100}})},c.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},c.prototype.registerPrevious=function(t){this._sources.push(t);var e=this;return t.on("data",(function(t){e.processChunk(t)})),t.on("end",(function(){e.closedSource(e.previous.streamInfo),e._sources.length?e.prepareNextSource():e.end()})),t.on("error",(function(t){e.error(t)})),this},c.prototype.resume=function(){return!!o.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},c.prototype.error=function(t){var e=this._sources;if(!o.prototype.error.call(this,t))return!1;for(var i=0;i<e.length;i++)try{e[i].error(t)}catch(t){}return!0},c.prototype.lock=function(){o.prototype.lock.call(this);for(var t=this._sources,e=0;e<t.length;e++)t[e].lock()},e.exports=c},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,e,i){var s=t("../compressions"),n=t("./ZipFileWorker");i.generateWorker=function(t,e,i){var r=new n(e.streamFiles,i,e.platform,e.encodeFileName),o=0;try{t.forEach((function(t,i){o++;var n=function(t,e){var i=t||e,n=s[i];if(!n)throw new Error(i+" is not a valid compression method !");return n}(i.options.compression,e.compression),a=i.options.compressionOptions||e.compressionOptions||{},h=i.dir,l=i.date;i._compressWorker(n,a).withStreamInfo("file",{name:t,dir:h,date:l,comment:i.comment||"",unixPermissions:i.unixPermissions,dosPermissions:i.dosPermissions}).pipe(r)})),r.entriesCount=o}catch(t){r.error(t)}return r}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,e,i){function s(){if(!(this instanceof s))return new s;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var t=new s;for(var e in this)"function"!=typeof this[e]&&(t[e]=this[e]);return t}}(s.prototype=t("./object")).loadAsync=t("./load"),s.support=t("./support"),s.defaults=t("./defaults"),s.version="3.10.1",s.loadAsync=function(t,e){return(new s).loadAsync(t,e)},s.external=t("./external"),e.exports=s},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,e,i){var s=t("./utils"),n=t("./external"),r=t("./utf8"),o=t("./zipEntries"),a=t("./stream/Crc32Probe"),h=t("./nodejsUtils");function l(t){return new n.Promise((function(e,i){var s=t.decompressed.getContentWorker().pipe(new a);s.on("error",(function(t){i(t)})).on("end",(function(){s.streamInfo.crc32!==t.decompressed.crc32?i(new Error("Corrupted zip : CRC32 mismatch")):e()})).resume()}))}e.exports=function(t,e){var i=this;return e=s.extend(e||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:r.utf8decode}),h.isNode&&h.isStream(t)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):s.prepareContent("the loaded zip file",t,!0,e.optimizedBinaryString,e.base64).then((function(t){var i=new o(e);return i.load(t),i})).then((function(t){var i=[n.Promise.resolve(t)],s=t.files;if(e.checkCRC32)for(var r=0;r<s.length;r++)i.push(l(s[r]));return n.Promise.all(i)})).then((function(t){for(var n=t.shift(),r=n.files,o=0;o<r.length;o++){var a=r[o],h=a.fileNameStr,l=s.resolve(a.fileNameStr);i.file(l,a.decompressed,{binary:!0,optimizedBinaryString:!0,date:a.date,dir:a.dir,comment:a.fileCommentStr.length?a.fileCommentStr:null,unixPermissions:a.unixPermissions,dosPermissions:a.dosPermissions,createFolders:e.createFolders}),a.dir||(i.file(l).unsafeOriginalName=h)}return n.zipComment.length&&(i.comment=n.zipComment),i}))}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,e,i){var s=t("../utils"),n=t("../stream/GenericWorker");function r(t,e){n.call(this,"Nodejs stream input adapter for "+t),this._upstreamEnded=!1,this._bindStream(e)}s.inherits(r,n),r.prototype._bindStream=function(t){var e=this;(this._stream=t).pause(),t.on("data",(function(t){e.push({data:t,meta:{percent:0}})})).on("error",(function(t){e.isPaused?this.generatedError=t:e.error(t)})).on("end",(function(){e.isPaused?e._upstreamEnded=!0:e.end()}))},r.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0)},r.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},e.exports=r},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,e,i){var s=t("readable-stream").Readable;function n(t,e,i){s.call(this,e),this._helper=t;var n=this;t.on("data",(function(t,e){n.push(t)||n._helper.pause(),i&&i(e)})).on("error",(function(t){n.emit("error",t)})).on("end",(function(){n.push(null)}))}t("../utils").inherits(n,s),n.prototype._read=function(){this._helper.resume()},e.exports=n},{"../utils":32,"readable-stream":16}],14:[function(t,e,i){e.exports={isNode:"undefined"!=typeof Buffer,newBufferFrom:function(t,e){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(t,e);if("number"==typeof t)throw new Error('The "data" argument must not be a number');return new Buffer(t,e)},allocBuffer:function(t){if(Buffer.alloc)return Buffer.alloc(t);var e=new Buffer(t);return e.fill(0),e},isBuffer:function(t){return Buffer.isBuffer(t)},isStream:function(t){return t&&"function"==typeof t.on&&"function"==typeof t.pause&&"function"==typeof t.resume}}},{}],15:[function(t,e,i){function s(t,e,i){var s,n=r.getTypeOf(e),a=r.extend(i||{},h);a.date=a.date||new Date,null!==a.compression&&(a.compression=a.compression.toUpperCase()),"string"==typeof a.unixPermissions&&(a.unixPermissions=parseInt(a.unixPermissions,8)),a.unixPermissions&&16384&a.unixPermissions&&(a.dir=!0),a.dosPermissions&&16&a.dosPermissions&&(a.dir=!0),a.dir&&(t=m(t)),a.createFolders&&(s=f(t))&&g.call(this,s,!0);var d="string"===n&&!1===a.binary&&!1===a.base64;i&&void 0!==i.binary||(a.binary=!d),(e instanceof l&&0===e.uncompressedSize||a.dir||!e||0===e.length)&&(a.base64=!1,a.binary=!0,e="",a.compression="STORE",n="string");var _=null;_=e instanceof l||e instanceof o?e:u.isNode&&u.isStream(e)?new p(t,e):r.prepareContent(t,e,a.binary,a.optimizedBinaryString,a.base64);var y=new c(t,_,a);this.files[t]=y}var n=t("./utf8"),r=t("./utils"),o=t("./stream/GenericWorker"),a=t("./stream/StreamHelper"),h=t("./defaults"),l=t("./compressedObject"),c=t("./zipObject"),d=t("./generate"),u=t("./nodejsUtils"),p=t("./nodejs/NodejsStreamInputAdapter"),f=function(t){"/"===t.slice(-1)&&(t=t.substring(0,t.length-1));var e=t.lastIndexOf("/");return 0<e?t.substring(0,e):""},m=function(t){return"/"!==t.slice(-1)&&(t+="/"),t},g=function(t,e){return e=void 0!==e?e:h.createFolders,t=m(t),this.files[t]||s.call(this,t,null,{dir:!0,createFolders:e}),this.files[t]};function _(t){return"[object RegExp]"===Object.prototype.toString.call(t)}var y={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(t){var e,i,s;for(e in this.files)s=this.files[e],(i=e.slice(this.root.length,e.length))&&e.slice(0,this.root.length)===this.root&&t(i,s)},filter:function(t){var e=[];return this.forEach((function(i,s){t(i,s)&&e.push(s)})),e},file:function(t,e,i){if(1!==arguments.length)return t=this.root+t,s.call(this,t,e,i),this;if(_(t)){var n=t;return this.filter((function(t,e){return!e.dir&&n.test(t)}))}var r=this.files[this.root+t];return r&&!r.dir?r:null},folder:function(t){if(!t)return this;if(_(t))return this.filter((function(e,i){return i.dir&&t.test(e)}));var e=this.root+t,i=g.call(this,e),s=this.clone();return s.root=i.name,s},remove:function(t){t=this.root+t;var e=this.files[t];if(e||("/"!==t.slice(-1)&&(t+="/"),e=this.files[t]),e&&!e.dir)delete this.files[t];else for(var i=this.filter((function(e,i){return i.name.slice(0,t.length)===t})),s=0;s<i.length;s++)delete this.files[i[s].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(t){var e,i={};try{if((i=r.extend(t||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=i.type.toLowerCase(),i.compression=i.compression.toUpperCase(),"binarystring"===i.type&&(i.type="string"),!i.type)throw new Error("No output type specified.");r.checkSupport(i.type),"darwin"!==i.platform&&"freebsd"!==i.platform&&"linux"!==i.platform&&"sunos"!==i.platform||(i.platform="UNIX"),"win32"===i.platform&&(i.platform="DOS");var s=i.comment||this.comment||"";e=d.generateWorker(this,i,s)}catch(t){(e=new o("error")).error(t)}return new a(e,i.type||"string",i.mimeType)},generateAsync:function(t,e){return this.generateInternalStream(t).accumulate(e)},generateNodeStream:function(t,e){return(t=t||{}).type||(t.type="nodebuffer"),this.generateInternalStream(t).toNodejsStream(e)}};e.exports=y},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,e,i){e.exports=t("stream")},{stream:void 0}],17:[function(t,e,i){var s=t("./DataReader");function n(t){s.call(this,t);for(var e=0;e<this.data.length;e++)t[e]=255&t[e]}t("../utils").inherits(n,s),n.prototype.byteAt=function(t){return this.data[this.zero+t]},n.prototype.lastIndexOfSignature=function(t){for(var e=t.charCodeAt(0),i=t.charCodeAt(1),s=t.charCodeAt(2),n=t.charCodeAt(3),r=this.length-4;0<=r;--r)if(this.data[r]===e&&this.data[r+1]===i&&this.data[r+2]===s&&this.data[r+3]===n)return r-this.zero;return-1},n.prototype.readAndCheckSignature=function(t){var e=t.charCodeAt(0),i=t.charCodeAt(1),s=t.charCodeAt(2),n=t.charCodeAt(3),r=this.readData(4);return e===r[0]&&i===r[1]&&s===r[2]&&n===r[3]},n.prototype.readData=function(t){if(this.checkOffset(t),0===t)return[];var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./DataReader":18}],18:[function(t,e,i){var s=t("../utils");function n(t){this.data=t,this.length=t.length,this.index=0,this.zero=0}n.prototype={checkOffset:function(t){this.checkIndex(this.index+t)},checkIndex:function(t){if(this.length<this.zero+t||t<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+t+"). Corrupted zip ?")},setIndex:function(t){this.checkIndex(t),this.index=t},skip:function(t){this.setIndex(this.index+t)},byteAt:function(){},readInt:function(t){var e,i=0;for(this.checkOffset(t),e=this.index+t-1;e>=this.index;e--)i=(i<<8)+this.byteAt(e);return this.index+=t,i},readString:function(t){return s.transformTo("string",this.readData(t))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var t=this.readInt(4);return new Date(Date.UTC(1980+(t>>25&127),(t>>21&15)-1,t>>16&31,t>>11&31,t>>5&63,(31&t)<<1))}},e.exports=n},{"../utils":32}],19:[function(t,e,i){var s=t("./Uint8ArrayReader");function n(t){s.call(this,t)}t("../utils").inherits(n,s),n.prototype.readData=function(t){this.checkOffset(t);var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,e,i){var s=t("./DataReader");function n(t){s.call(this,t)}t("../utils").inherits(n,s),n.prototype.byteAt=function(t){return this.data.charCodeAt(this.zero+t)},n.prototype.lastIndexOfSignature=function(t){return this.data.lastIndexOf(t)-this.zero},n.prototype.readAndCheckSignature=function(t){return t===this.readData(4)},n.prototype.readData=function(t){this.checkOffset(t);var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./DataReader":18}],21:[function(t,e,i){var s=t("./ArrayReader");function n(t){s.call(this,t)}t("../utils").inherits(n,s),n.prototype.readData=function(t){if(this.checkOffset(t),0===t)return new Uint8Array(0);var e=this.data.subarray(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},e.exports=n},{"../utils":32,"./ArrayReader":17}],22:[function(t,e,i){var s=t("../utils"),n=t("../support"),r=t("./ArrayReader"),o=t("./StringReader"),a=t("./NodeBufferReader"),h=t("./Uint8ArrayReader");e.exports=function(t){var e=s.getTypeOf(t);return s.checkSupport(e),"string"!==e||n.uint8array?"nodebuffer"===e?new a(t):n.uint8array?new h(s.transformTo("uint8array",t)):new r(s.transformTo("array",t)):new o(t)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,e,i){i.LOCAL_FILE_HEADER="PK",i.CENTRAL_FILE_HEADER="PK",i.CENTRAL_DIRECTORY_END="PK",i.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",i.ZIP64_CENTRAL_DIRECTORY_END="PK",i.DATA_DESCRIPTOR="PK\b"},{}],24:[function(t,e,i){var s=t("./GenericWorker"),n=t("../utils");function r(t){s.call(this,"ConvertWorker to "+t),this.destType=t}n.inherits(r,s),r.prototype.processChunk=function(t){this.push({data:n.transformTo(this.destType,t.data),meta:t.meta})},e.exports=r},{"../utils":32,"./GenericWorker":28}],25:[function(t,e,i){var s=t("./GenericWorker"),n=t("../crc32");function r(){s.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(r,s),r.prototype.processChunk=function(t){this.streamInfo.crc32=n(t.data,this.streamInfo.crc32||0),this.push(t)},e.exports=r},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,e,i){var s=t("../utils"),n=t("./GenericWorker");function r(t){n.call(this,"DataLengthProbe for "+t),this.propName=t,this.withStreamInfo(t,0)}s.inherits(r,n),r.prototype.processChunk=function(t){if(t){var e=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=e+t.data.length}n.prototype.processChunk.call(this,t)},e.exports=r},{"../utils":32,"./GenericWorker":28}],27:[function(t,e,i){var s=t("../utils"),n=t("./GenericWorker");function r(t){n.call(this,"DataWorker");var e=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,t.then((function(t){e.dataIsReady=!0,e.data=t,e.max=t&&t.length||0,e.type=s.getTypeOf(t),e.isPaused||e._tickAndRepeat()}),(function(t){e.error(t)}))}s.inherits(r,n),r.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null},r.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,s.delay(this._tickAndRepeat,[],this)),!0)},r.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(s.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},r.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var t=null,e=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":t=this.data.substring(this.index,e);break;case"uint8array":t=this.data.subarray(this.index,e);break;case"array":case"nodebuffer":t=this.data.slice(this.index,e)}return this.index=e,this.push({data:t,meta:{percent:this.max?this.index/this.max*100:0}})},e.exports=r},{"../utils":32,"./GenericWorker":28}],28:[function(t,e,i){function s(t){this.name=t||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}s.prototype={push:function(t){this.emit("data",t)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(t){this.emit("error",t)}return!0},error:function(t){return!this.isFinished&&(this.isPaused?this.generatedError=t:(this.isFinished=!0,this.emit("error",t),this.previous&&this.previous.error(t),this.cleanUp()),!0)},on:function(t,e){return this._listeners[t].push(e),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(t,e){if(this._listeners[t])for(var i=0;i<this._listeners[t].length;i++)this._listeners[t][i].call(this,e)},pipe:function(t){return t.registerPrevious(this)},registerPrevious:function(t){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=t.streamInfo,this.mergeStreamInfo(),this.previous=t;var e=this;return t.on("data",(function(t){e.processChunk(t)})),t.on("end",(function(){e.end()})),t.on("error",(function(t){e.error(t)})),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var t=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),t=!0),this.previous&&this.previous.resume(),!t},flush:function(){},processChunk:function(t){this.push(t)},withStreamInfo:function(t,e){return this.extraStreamInfo[t]=e,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var t in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,t)&&(this.streamInfo[t]=this.extraStreamInfo[t])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var t="Worker "+this.name;return this.previous?this.previous+" -> "+t:t}},e.exports=s},{}],29:[function(t,e,i){var s=t("../utils"),n=t("./ConvertWorker"),r=t("./GenericWorker"),o=t("../base64"),a=t("../support"),h=t("../external"),l=null;if(a.nodestream)try{l=t("../nodejs/NodejsStreamOutputAdapter")}catch(t){}function c(t,e){return new h.Promise((function(i,n){var r=[],a=t._internalType,h=t._outputType,l=t._mimeType;t.on("data",(function(t,i){r.push(t),e&&e(i)})).on("error",(function(t){r=[],n(t)})).on("end",(function(){try{var t=function(t,e,i){switch(t){case"blob":return s.newBlob(s.transformTo("arraybuffer",e),i);case"base64":return o.encode(e);default:return s.transformTo(t,e)}}(h,function(t,e){var i,s=0,n=null,r=0;for(i=0;i<e.length;i++)r+=e[i].length;switch(t){case"string":return e.join("");case"array":return Array.prototype.concat.apply([],e);case"uint8array":for(n=new Uint8Array(r),i=0;i<e.length;i++)n.set(e[i],s),s+=e[i].length;return n;case"nodebuffer":return Buffer.concat(e);default:throw new Error("concat : unsupported type '"+t+"'")}}(a,r),l);i(t)}catch(t){n(t)}r=[]})).resume()}))}function d(t,e,i){var o=e;switch(e){case"blob":case"arraybuffer":o="uint8array";break;case"base64":o="string"}try{this._internalType=o,this._outputType=e,this._mimeType=i,s.checkSupport(o),this._worker=t.pipe(new n(o)),t.lock()}catch(t){this._worker=new r("error"),this._worker.error(t)}}d.prototype={accumulate:function(t){return c(this,t)},on:function(t,e){var i=this;return"data"===t?this._worker.on(t,(function(t){e.call(i,t.data,t.meta)})):this._worker.on(t,(function(){s.delay(e,arguments,i)})),this},resume:function(){return s.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(t){if(s.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new l(this,{objectMode:"nodebuffer"!==this._outputType},t)}},e.exports=d},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,e,i){if(i.base64=!0,i.array=!0,i.string=!0,i.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,i.nodebuffer="undefined"!=typeof Buffer,i.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)i.blob=!1;else{var s=new ArrayBuffer(0);try{i.blob=0===new Blob([s],{type:"application/zip"}).size}catch(t){try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);n.append(s),i.blob=0===n.getBlob("application/zip").size}catch(t){i.blob=!1}}}try{i.nodestream=!!t("readable-stream").Readable}catch(t){i.nodestream=!1}},{"readable-stream":16}],31:[function(t,e,i){for(var s=t("./utils"),n=t("./support"),r=t("./nodejsUtils"),o=t("./stream/GenericWorker"),a=new Array(256),h=0;h<256;h++)a[h]=252<=h?6:248<=h?5:240<=h?4:224<=h?3:192<=h?2:1;function l(){o.call(this,"utf-8 decode"),this.leftOver=null}function c(){o.call(this,"utf-8 encode")}a[254]=a[254]=1,i.utf8encode=function(t){return n.nodebuffer?r.newBufferFrom(t,"utf-8"):function(t){var e,i,s,r,o,a=t.length,h=0;for(r=0;r<a;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(s=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(s-56320),r++),h+=i<128?1:i<2048?2:i<65536?3:4;for(e=n.uint8array?new Uint8Array(h):new Array(h),r=o=0;o<h;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(s=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(s-56320),r++),i<128?e[o++]=i:(i<2048?e[o++]=192|i>>>6:(i<65536?e[o++]=224|i>>>12:(e[o++]=240|i>>>18,e[o++]=128|i>>>12&63),e[o++]=128|i>>>6&63),e[o++]=128|63&i);return e}(t)},i.utf8decode=function(t){return n.nodebuffer?s.transformTo("nodebuffer",t).toString("utf-8"):function(t){var e,i,n,r,o=t.length,h=new Array(2*o);for(e=i=0;e<o;)if((n=t[e++])<128)h[i++]=n;else if(4<(r=a[n]))h[i++]=65533,e+=r-1;else{for(n&=2===r?31:3===r?15:7;1<r&&e<o;)n=n<<6|63&t[e++],r--;1<r?h[i++]=65533:n<65536?h[i++]=n:(n-=65536,h[i++]=55296|n>>10&1023,h[i++]=56320|1023&n)}return h.length!==i&&(h.subarray?h=h.subarray(0,i):h.length=i),s.applyFromCharCode(h)}(t=s.transformTo(n.uint8array?"uint8array":"array",t))},s.inherits(l,o),l.prototype.processChunk=function(t){var e=s.transformTo(n.uint8array?"uint8array":"array",t.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var r=e;(e=new Uint8Array(r.length+this.leftOver.length)).set(this.leftOver,0),e.set(r,this.leftOver.length)}else e=this.leftOver.concat(e);this.leftOver=null}var o=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;0<=i&&128==(192&t[i]);)i--;return i<0||0===i?e:i+a[t[i]]>e?i:e}(e),h=e;o!==e.length&&(n.uint8array?(h=e.subarray(0,o),this.leftOver=e.subarray(o,e.length)):(h=e.slice(0,o),this.leftOver=e.slice(o,e.length))),this.push({data:i.utf8decode(h),meta:t.meta})},l.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:i.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},i.Utf8DecodeWorker=l,s.inherits(c,o),c.prototype.processChunk=function(t){this.push({data:i.utf8encode(t.data),meta:t.meta})},i.Utf8EncodeWorker=c},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,e,i){var s=t("./support"),n=t("./base64"),r=t("./nodejsUtils"),o=t("./external");function a(t){return t}function h(t,e){for(var i=0;i<t.length;++i)e[i]=255&t.charCodeAt(i);return e}t("setimmediate"),i.newBlob=function(t,e){i.checkSupport("blob");try{return new Blob([t],{type:e})}catch(i){try{var s=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return s.append(t),s.getBlob(e)}catch(t){throw new Error("Bug : can't construct the Blob.")}}};var l={stringifyByChunk:function(t,e,i){var s=[],n=0,r=t.length;if(r<=i)return String.fromCharCode.apply(null,t);for(;n<r;)"array"===e||"nodebuffer"===e?s.push(String.fromCharCode.apply(null,t.slice(n,Math.min(n+i,r)))):s.push(String.fromCharCode.apply(null,t.subarray(n,Math.min(n+i,r)))),n+=i;return s.join("")},stringifyByChar:function(t){for(var e="",i=0;i<t.length;i++)e+=String.fromCharCode(t[i]);return e},applyCanBeUsed:{uint8array:function(){try{return s.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch(t){return!1}}(),nodebuffer:function(){try{return s.nodebuffer&&1===String.fromCharCode.apply(null,r.allocBuffer(1)).length}catch(t){return!1}}()}};function c(t){var e=65536,s=i.getTypeOf(t),n=!0;if("uint8array"===s?n=l.applyCanBeUsed.uint8array:"nodebuffer"===s&&(n=l.applyCanBeUsed.nodebuffer),n)for(;1<e;)try{return l.stringifyByChunk(t,s,e)}catch(t){e=Math.floor(e/2)}return l.stringifyByChar(t)}function d(t,e){for(var i=0;i<t.length;i++)e[i]=t[i];return e}i.applyFromCharCode=c;var u={};u.string={string:a,array:function(t){return h(t,new Array(t.length))},arraybuffer:function(t){return u.string.uint8array(t).buffer},uint8array:function(t){return h(t,new Uint8Array(t.length))},nodebuffer:function(t){return h(t,r.allocBuffer(t.length))}},u.array={string:c,array:a,arraybuffer:function(t){return new Uint8Array(t).buffer},uint8array:function(t){return new Uint8Array(t)},nodebuffer:function(t){return r.newBufferFrom(t)}},u.arraybuffer={string:function(t){return c(new Uint8Array(t))},array:function(t){return d(new Uint8Array(t),new Array(t.byteLength))},arraybuffer:a,uint8array:function(t){return new Uint8Array(t)},nodebuffer:function(t){return r.newBufferFrom(new Uint8Array(t))}},u.uint8array={string:c,array:function(t){return d(t,new Array(t.length))},arraybuffer:function(t){return t.buffer},uint8array:a,nodebuffer:function(t){return r.newBufferFrom(t)}},u.nodebuffer={string:c,array:function(t){return d(t,new Array(t.length))},arraybuffer:function(t){return u.nodebuffer.uint8array(t).buffer},uint8array:function(t){return d(t,new Uint8Array(t.length))},nodebuffer:a},i.transformTo=function(t,e){if(e=e||"",!t)return e;i.checkSupport(t);var s=i.getTypeOf(e);return u[s][t](e)},i.resolve=function(t){for(var e=t.split("/"),i=[],s=0;s<e.length;s++){var n=e[s];"."===n||""===n&&0!==s&&s!==e.length-1||(".."===n?i.pop():i.push(n))}return i.join("/")},i.getTypeOf=function(t){return"string"==typeof t?"string":"[object Array]"===Object.prototype.toString.call(t)?"array":s.nodebuffer&&r.isBuffer(t)?"nodebuffer":s.uint8array&&t instanceof Uint8Array?"uint8array":s.arraybuffer&&t instanceof ArrayBuffer?"arraybuffer":void 0},i.checkSupport=function(t){if(!s[t.toLowerCase()])throw new Error(t+" is not supported by this platform")},i.MAX_VALUE_16BITS=65535,i.MAX_VALUE_32BITS=-1,i.pretty=function(t){var e,i,s="";for(i=0;i<(t||"").length;i++)s+="\\x"+((e=t.charCodeAt(i))<16?"0":"")+e.toString(16).toUpperCase();return s},i.delay=function(t,e,i){setImmediate((function(){t.apply(i||null,e||[])}))},i.inherits=function(t,e){function i(){}i.prototype=e.prototype,t.prototype=new i},i.extend=function(){var t,e,i={};for(t=0;t<arguments.length;t++)for(e in arguments[t])Object.prototype.hasOwnProperty.call(arguments[t],e)&&void 0===i[e]&&(i[e]=arguments[t][e]);return i},i.prepareContent=function(t,e,r,a,l){return o.Promise.resolve(e).then((function(t){return s.blob&&(t instanceof Blob||-1!==["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(t)))&&"undefined"!=typeof FileReader?new o.Promise((function(e,i){var s=new FileReader;s.onload=function(t){e(t.target.result)},s.onerror=function(t){i(t.target.error)},s.readAsArrayBuffer(t)})):t})).then((function(e){var c,d=i.getTypeOf(e);return d?("arraybuffer"===d?e=i.transformTo("uint8array",e):"string"===d&&(l?e=n.decode(e):r&&!0!==a&&(e=h(c=e,s.uint8array?new Uint8Array(c.length):new Array(c.length)))),e):o.Promise.reject(new Error("Can't read the data of '"+t+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))}))}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,e,i){var s=t("./reader/readerFor"),n=t("./utils"),r=t("./signature"),o=t("./zipEntry"),a=t("./support");function h(t){this.files=[],this.loadOptions=t}h.prototype={checkSignature:function(t){if(!this.reader.readAndCheckSignature(t)){this.reader.index-=4;var e=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(e)+", expected "+n.pretty(t)+")")}},isSignature:function(t,e){var i=this.reader.index;this.reader.setIndex(t);var s=this.reader.readString(4)===e;return this.reader.setIndex(i),s},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var t=this.reader.readData(this.zipCommentLength),e=a.uint8array?"uint8array":"array",i=n.transformTo(e,t);this.zipComment=this.loadOptions.decodeFileName(i)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var t,e,i,s=this.zip64EndOfCentralSize-44;0<s;)t=this.reader.readInt(2),e=this.reader.readInt(4),i=this.reader.readData(e),this.zip64ExtensibleData[t]={id:t,length:e,value:i}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var t,e;for(t=0;t<this.files.length;t++)e=this.files[t],this.reader.setIndex(e.localHeaderOffset),this.checkSignature(r.LOCAL_FILE_HEADER),e.readLocalPart(this.reader),e.handleUTF8(),e.processAttributes()},readCentralDir:function(){var t;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(r.CENTRAL_FILE_HEADER);)(t=new o({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(t);if(this.centralDirRecords!==this.files.length&&0!==this.centralDirRecords&&0===this.files.length)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var t=this.reader.lastIndexOfSignature(r.CENTRAL_DIRECTORY_END);if(t<0)throw this.isSignature(0,r.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(t);var e=t;if(this.checkSignature(r.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(t=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(t),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,r.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var i=this.centralDirOffset+this.centralDirSize;this.zip64&&(i+=20,i+=12+this.zip64EndOfCentralSize);var s=e-i;if(0<s)this.isSignature(e,r.CENTRAL_FILE_HEADER)||(this.reader.zero=s);else if(s<0)throw new Error("Corrupted zip: missing "+Math.abs(s)+" bytes.")},prepareReader:function(t){this.reader=s(t)},load:function(t){this.prepareReader(t),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},e.exports=h},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,e,i){var s=t("./reader/readerFor"),n=t("./utils"),r=t("./compressedObject"),o=t("./crc32"),a=t("./utf8"),h=t("./compressions"),l=t("./support");function c(t,e){this.options=t,this.loadOptions=e}c.prototype={isEncrypted:function(){return!(1&~this.bitFlag)},useUTF8:function(){return!(2048&~this.bitFlag)},readLocalPart:function(t){var e,i;if(t.skip(22),this.fileNameLength=t.readInt(2),i=t.readInt(2),this.fileName=t.readData(this.fileNameLength),t.skip(i),-1===this.compressedSize||-1===this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if(null===(e=function(t){for(var e in h)if(Object.prototype.hasOwnProperty.call(h,e)&&h[e].magic===t)return h[e];return null}(this.compressionMethod)))throw new Error("Corrupted zip : compression "+n.pretty(this.compressionMethod)+" unknown (inner file : "+n.transformTo("string",this.fileName)+")");this.decompressed=new r(this.compressedSize,this.uncompressedSize,this.crc32,e,t.readData(this.compressedSize))},readCentralPart:function(t){this.versionMadeBy=t.readInt(2),t.skip(2),this.bitFlag=t.readInt(2),this.compressionMethod=t.readString(2),this.date=t.readDate(),this.crc32=t.readInt(4),this.compressedSize=t.readInt(4),this.uncompressedSize=t.readInt(4);var e=t.readInt(2);if(this.extraFieldsLength=t.readInt(2),this.fileCommentLength=t.readInt(2),this.diskNumberStart=t.readInt(2),this.internalFileAttributes=t.readInt(2),this.externalFileAttributes=t.readInt(4),this.localHeaderOffset=t.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");t.skip(e),this.readExtraFields(t),this.parseZIP64ExtraField(t),this.fileComment=t.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var t=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),0==t&&(this.dosPermissions=63&this.externalFileAttributes),3==t&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileNameStr.slice(-1)||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var t=s(this.extraFields[1].value);this.uncompressedSize===n.MAX_VALUE_32BITS&&(this.uncompressedSize=t.readInt(8)),this.compressedSize===n.MAX_VALUE_32BITS&&(this.compressedSize=t.readInt(8)),this.localHeaderOffset===n.MAX_VALUE_32BITS&&(this.localHeaderOffset=t.readInt(8)),this.diskNumberStart===n.MAX_VALUE_32BITS&&(this.diskNumberStart=t.readInt(4))}},readExtraFields:function(t){var e,i,s,n=t.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});t.index+4<n;)e=t.readInt(2),i=t.readInt(2),s=t.readData(i),this.extraFields[e]={id:e,length:i,value:s};t.setIndex(n)},handleUTF8:function(){var t=l.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=a.utf8decode(this.fileName),this.fileCommentStr=a.utf8decode(this.fileComment);else{var e=this.findExtraFieldUnicodePath();if(null!==e)this.fileNameStr=e;else{var i=n.transformTo(t,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(i)}var s=this.findExtraFieldUnicodeComment();if(null!==s)this.fileCommentStr=s;else{var r=n.transformTo(t,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(r)}}},findExtraFieldUnicodePath:function(){var t=this.extraFields[28789];if(t){var e=s(t.value);return 1!==e.readInt(1)||o(this.fileName)!==e.readInt(4)?null:a.utf8decode(e.readData(t.length-5))}return null},findExtraFieldUnicodeComment:function(){var t=this.extraFields[25461];if(t){var e=s(t.value);return 1!==e.readInt(1)||o(this.fileComment)!==e.readInt(4)?null:a.utf8decode(e.readData(t.length-5))}return null}},e.exports=c},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,e,i){function s(t,e,i){this.name=t,this.dir=i.dir,this.date=i.date,this.comment=i.comment,this.unixPermissions=i.unixPermissions,this.dosPermissions=i.dosPermissions,this._data=e,this._dataBinary=i.binary,this.options={compression:i.compression,compressionOptions:i.compressionOptions}}var n=t("./stream/StreamHelper"),r=t("./stream/DataWorker"),o=t("./utf8"),a=t("./compressedObject"),h=t("./stream/GenericWorker");s.prototype={internalStream:function(t){var e=null,i="string";try{if(!t)throw new Error("No output type specified.");var s="string"===(i=t.toLowerCase())||"text"===i;"binarystring"!==i&&"text"!==i||(i="string"),e=this._decompressWorker();var r=!this._dataBinary;r&&!s&&(e=e.pipe(new o.Utf8EncodeWorker)),!r&&s&&(e=e.pipe(new o.Utf8DecodeWorker))}catch(t){(e=new h("error")).error(t)}return new n(e,i,"")},async:function(t,e){return this.internalStream(t).accumulate(e)},nodeStream:function(t,e){return this.internalStream(t||"nodebuffer").toNodejsStream(e)},_compressWorker:function(t,e){if(this._data instanceof a&&this._data.compression.magic===t.magic)return this._data.getCompressedWorker();var i=this._decompressWorker();return this._dataBinary||(i=i.pipe(new o.Utf8EncodeWorker)),a.createWorkerFrom(i,t,e)},_decompressWorker:function(){return this._data instanceof a?this._data.getContentWorker():this._data instanceof h?this._data:new r(this._data)}};for(var l=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],c=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},d=0;d<l.length;d++)s.prototype[l[d]]=c;e.exports=s},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,e,i){(function(t){var i,s,n=t.MutationObserver||t.WebKitMutationObserver;if(n){var r=0,o=new n(c),a=t.document.createTextNode("");o.observe(a,{characterData:!0}),i=function(){a.data=r=++r%2}}else if(t.setImmediate||void 0===t.MessageChannel)i="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var e=t.document.createElement("script");e.onreadystatechange=function(){c(),e.onreadystatechange=null,e.parentNode.removeChild(e),e=null},t.document.documentElement.appendChild(e)}:function(){setTimeout(c,0)};else{var h=new t.MessageChannel;h.port1.onmessage=c,i=function(){h.port2.postMessage(0)}}var l=[];function c(){var t,e;s=!0;for(var i=l.length;i;){for(e=l,l=[],t=-1;++t<i;)e[t]();i=l.length}s=!1}e.exports=function(t){1!==l.push(t)||s||i()}}).call(this,void 0!==fs?fs:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],37:[function(t,e,i){var s=t("immediate");function n(){}var r={},o=["REJECTED"],a=["FULFILLED"],h=["PENDING"];function l(t){if("function"!=typeof t)throw new TypeError("resolver must be a function");this.state=h,this.queue=[],this.outcome=void 0,t!==n&&p(this,t)}function c(t,e,i){this.promise=t,"function"==typeof e&&(this.onFulfilled=e,this.callFulfilled=this.otherCallFulfilled),"function"==typeof i&&(this.onRejected=i,this.callRejected=this.otherCallRejected)}function d(t,e,i){s((function(){var s;try{s=e(i)}catch(e){return r.reject(t,e)}s===t?r.reject(t,new TypeError("Cannot resolve promise with itself")):r.resolve(t,s)}))}function u(t){var e=t&&t.then;if(t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof e)return function(){e.apply(t,arguments)}}function p(t,e){var i=!1;function s(e){i||(i=!0,r.reject(t,e))}function n(e){i||(i=!0,r.resolve(t,e))}var o=f((function(){e(n,s)}));"error"===o.status&&s(o.value)}function f(t,e){var i={};try{i.value=t(e),i.status="success"}catch(t){i.status="error",i.value=t}return i}(e.exports=l).prototype.finally=function(t){if("function"!=typeof t)return this;var e=this.constructor;return this.then((function(i){return e.resolve(t()).then((function(){return i}))}),(function(i){return e.resolve(t()).then((function(){throw i}))}))},l.prototype.catch=function(t){return this.then(null,t)},l.prototype.then=function(t,e){if("function"!=typeof t&&this.state===a||"function"!=typeof e&&this.state===o)return this;var i=new this.constructor(n);return this.state!==h?d(i,this.state===a?t:e,this.outcome):this.queue.push(new c(i,t,e)),i},c.prototype.callFulfilled=function(t){r.resolve(this.promise,t)},c.prototype.otherCallFulfilled=function(t){d(this.promise,this.onFulfilled,t)},c.prototype.callRejected=function(t){r.reject(this.promise,t)},c.prototype.otherCallRejected=function(t){d(this.promise,this.onRejected,t)},r.resolve=function(t,e){var i=f(u,e);if("error"===i.status)return r.reject(t,i.value);var s=i.value;if(s)p(t,s);else{t.state=a,t.outcome=e;for(var n=-1,o=t.queue.length;++n<o;)t.queue[n].callFulfilled(e)}return t},r.reject=function(t,e){t.state=o,t.outcome=e;for(var i=-1,s=t.queue.length;++i<s;)t.queue[i].callRejected(e);return t},l.resolve=function(t){return t instanceof this?t:r.resolve(new this(n),t)},l.reject=function(t){var e=new this(n);return r.reject(e,t)},l.all=function(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var i=t.length,s=!1;if(!i)return this.resolve([]);for(var o=new Array(i),a=0,h=-1,l=new this(n);++h<i;)c(t[h],h);return l;function c(t,n){e.resolve(t).then((function(t){o[n]=t,++a!==i||s||(s=!0,r.resolve(l,o))}),(function(t){s||(s=!0,r.reject(l,t))}))}},l.race=function(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var i=t.length,s=!1;if(!i)return this.resolve([]);for(var o,a=-1,h=new this(n);++a<i;)o=t[a],e.resolve(o).then((function(t){s||(s=!0,r.resolve(h,t))}),(function(t){s||(s=!0,r.reject(h,t))}));return h}},{immediate:36}],38:[function(t,e,i){var s={};(0,t("./lib/utils/common").assign)(s,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),e.exports=s},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,e,i){var s=t("./zlib/deflate"),n=t("./utils/common"),r=t("./utils/strings"),o=t("./zlib/messages"),a=t("./zlib/zstream"),h=Object.prototype.toString,l=0,c=-1,d=0,u=8;function p(t){if(!(this instanceof p))return new p(t);this.options=n.assign({level:c,method:u,chunkSize:16384,windowBits:15,memLevel:8,strategy:d,to:""},t||{});var e=this.options;e.raw&&0<e.windowBits?e.windowBits=-e.windowBits:e.gzip&&0<e.windowBits&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new a,this.strm.avail_out=0;var i=s.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(i!==l)throw new Error(o[i]);if(e.header&&s.deflateSetHeader(this.strm,e.header),e.dictionary){var f;if(f="string"==typeof e.dictionary?r.string2buf(e.dictionary):"[object ArrayBuffer]"===h.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,(i=s.deflateSetDictionary(this.strm,f))!==l)throw new Error(o[i]);this._dict_set=!0}}function f(t,e){var i=new p(e);if(i.push(t,!0),i.err)throw i.msg||o[i.err];return i.result}p.prototype.push=function(t,e){var i,o,a=this.strm,c=this.options.chunkSize;if(this.ended)return!1;o=e===~~e?e:!0===e?4:0,"string"==typeof t?a.input=r.string2buf(t):"[object ArrayBuffer]"===h.call(t)?a.input=new Uint8Array(t):a.input=t,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new n.Buf8(c),a.next_out=0,a.avail_out=c),1!==(i=s.deflate(a,o))&&i!==l)return this.onEnd(i),!(this.ended=!0);0!==a.avail_out&&(0!==a.avail_in||4!==o&&2!==o)||("string"===this.options.to?this.onData(r.buf2binstring(n.shrinkBuf(a.output,a.next_out))):this.onData(n.shrinkBuf(a.output,a.next_out)))}while((0<a.avail_in||0===a.avail_out)&&1!==i);return 4===o?(i=s.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===l):2!==o||(this.onEnd(l),!(a.avail_out=0))},p.prototype.onData=function(t){this.chunks.push(t)},p.prototype.onEnd=function(t){t===l&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Deflate=p,i.deflate=f,i.deflateRaw=function(t,e){return(e=e||{}).raw=!0,f(t,e)},i.gzip=function(t,e){return(e=e||{}).gzip=!0,f(t,e)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,e,i){var s=t("./zlib/inflate"),n=t("./utils/common"),r=t("./utils/strings"),o=t("./zlib/constants"),a=t("./zlib/messages"),h=t("./zlib/zstream"),l=t("./zlib/gzheader"),c=Object.prototype.toString;function d(t){if(!(this instanceof d))return new d(t);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&0<=e.windowBits&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(0<=e.windowBits&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),15<e.windowBits&&e.windowBits<48&&!(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var i=s.inflateInit2(this.strm,e.windowBits);if(i!==o.Z_OK)throw new Error(a[i]);this.header=new l,s.inflateGetHeader(this.strm,this.header)}function u(t,e){var i=new d(e);if(i.push(t,!0),i.err)throw i.msg||a[i.err];return i.result}d.prototype.push=function(t,e){var i,a,h,l,d,u,p=this.strm,f=this.options.chunkSize,m=this.options.dictionary,g=!1;if(this.ended)return!1;a=e===~~e?e:!0===e?o.Z_FINISH:o.Z_NO_FLUSH,"string"==typeof t?p.input=r.binstring2buf(t):"[object ArrayBuffer]"===c.call(t)?p.input=new Uint8Array(t):p.input=t,p.next_in=0,p.avail_in=p.input.length;do{if(0===p.avail_out&&(p.output=new n.Buf8(f),p.next_out=0,p.avail_out=f),(i=s.inflate(p,o.Z_NO_FLUSH))===o.Z_NEED_DICT&&m&&(u="string"==typeof m?r.string2buf(m):"[object ArrayBuffer]"===c.call(m)?new Uint8Array(m):m,i=s.inflateSetDictionary(this.strm,u)),i===o.Z_BUF_ERROR&&!0===g&&(i=o.Z_OK,g=!1),i!==o.Z_STREAM_END&&i!==o.Z_OK)return this.onEnd(i),!(this.ended=!0);p.next_out&&(0!==p.avail_out&&i!==o.Z_STREAM_END&&(0!==p.avail_in||a!==o.Z_FINISH&&a!==o.Z_SYNC_FLUSH)||("string"===this.options.to?(h=r.utf8border(p.output,p.next_out),l=p.next_out-h,d=r.buf2string(p.output,h),p.next_out=l,p.avail_out=f-l,l&&n.arraySet(p.output,p.output,h,l,0),this.onData(d)):this.onData(n.shrinkBuf(p.output,p.next_out)))),0===p.avail_in&&0===p.avail_out&&(g=!0)}while((0<p.avail_in||0===p.avail_out)&&i!==o.Z_STREAM_END);return i===o.Z_STREAM_END&&(a=o.Z_FINISH),a===o.Z_FINISH?(i=s.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===o.Z_OK):a!==o.Z_SYNC_FLUSH||(this.onEnd(o.Z_OK),!(p.avail_out=0))},d.prototype.onData=function(t){this.chunks.push(t)},d.prototype.onEnd=function(t){t===o.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Inflate=d,i.inflate=u,i.inflateRaw=function(t,e){return(e=e||{}).raw=!0,u(t,e)},i.ungzip=u},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,e,i){var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;i.assign=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var i=e.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var s in i)i.hasOwnProperty(s)&&(t[s]=i[s])}}return t},i.shrinkBuf=function(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)};var n={arraySet:function(t,e,i,s,n){if(e.subarray&&t.subarray)t.set(e.subarray(i,i+s),n);else for(var r=0;r<s;r++)t[n+r]=e[i+r]},flattenChunks:function(t){var e,i,s,n,r,o;for(e=s=0,i=t.length;e<i;e++)s+=t[e].length;for(o=new Uint8Array(s),e=n=0,i=t.length;e<i;e++)r=t[e],o.set(r,n),n+=r.length;return o}},r={arraySet:function(t,e,i,s,n){for(var r=0;r<s;r++)t[n+r]=e[i+r]},flattenChunks:function(t){return[].concat.apply([],t)}};i.setTyped=function(t){t?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,n)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,r))},i.setTyped(s)},{}],42:[function(t,e,i){var s=t("./common"),n=!0,r=!0;try{String.fromCharCode.apply(null,[0])}catch(t){n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){r=!1}for(var o=new s.Buf8(256),a=0;a<256;a++)o[a]=252<=a?6:248<=a?5:240<=a?4:224<=a?3:192<=a?2:1;function h(t,e){if(e<65537&&(t.subarray&&r||!t.subarray&&n))return String.fromCharCode.apply(null,s.shrinkBuf(t,e));for(var i="",o=0;o<e;o++)i+=String.fromCharCode(t[o]);return i}o[254]=o[254]=1,i.string2buf=function(t){var e,i,n,r,o,a=t.length,h=0;for(r=0;r<a;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(n=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),h+=i<128?1:i<2048?2:i<65536?3:4;for(e=new s.Buf8(h),r=o=0;o<h;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(n=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),i<128?e[o++]=i:(i<2048?e[o++]=192|i>>>6:(i<65536?e[o++]=224|i>>>12:(e[o++]=240|i>>>18,e[o++]=128|i>>>12&63),e[o++]=128|i>>>6&63),e[o++]=128|63&i);return e},i.buf2binstring=function(t){return h(t,t.length)},i.binstring2buf=function(t){for(var e=new s.Buf8(t.length),i=0,n=e.length;i<n;i++)e[i]=t.charCodeAt(i);return e},i.buf2string=function(t,e){var i,s,n,r,a=e||t.length,l=new Array(2*a);for(i=s=0;i<a;)if((n=t[i++])<128)l[s++]=n;else if(4<(r=o[n]))l[s++]=65533,i+=r-1;else{for(n&=2===r?31:3===r?15:7;1<r&&i<a;)n=n<<6|63&t[i++],r--;1<r?l[s++]=65533:n<65536?l[s++]=n:(n-=65536,l[s++]=55296|n>>10&1023,l[s++]=56320|1023&n)}return h(l,s)},i.utf8border=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;0<=i&&128==(192&t[i]);)i--;return i<0||0===i?e:i+o[t[i]]>e?i:e}},{"./common":41}],43:[function(t,e,i){e.exports=function(t,e,i,s){for(var n=65535&t,r=t>>>16&65535,o=0;0!==i;){for(i-=o=2e3<i?2e3:i;r=r+(n=n+e[s++]|0)|0,--o;);n%=65521,r%=65521}return n|r<<16}},{}],44:[function(t,e,i){e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,e,i){var s=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var s=0;s<8;s++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();e.exports=function(t,e,i,n){var r=s,o=n+i;t^=-1;for(var a=n;a<o;a++)t=t>>>8^r[255&(t^e[a])];return~t}},{}],46:[function(t,e,i){var s,n=t("../utils/common"),r=t("./trees"),o=t("./adler32"),a=t("./crc32"),h=t("./messages"),l=0,c=4,d=0,u=-2,p=-1,f=4,m=2,g=8,_=9,y=286,w=30,v=19,b=2*y+1,x=15,T=3,E=258,C=E+T+1,O=42,A=113,S=1,P=2,k=3,z=4;function M(t,e){return t.msg=h[e],e}function B(t){return(t<<1)-(4<t?9:0)}function D(t){for(var e=t.length;0<=--e;)t[e]=0}function I(t){var e=t.state,i=e.pending;i>t.avail_out&&(i=t.avail_out),0!==i&&(n.arraySet(t.output,e.pending_buf,e.pending_out,i,t.next_out),t.next_out+=i,e.pending_out+=i,t.total_out+=i,t.avail_out-=i,e.pending-=i,0===e.pending&&(e.pending_out=0))}function U(t,e){r._tr_flush_block(t,0<=t.block_start?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,I(t.strm)}function N(t,e){t.pending_buf[t.pending++]=e}function L(t,e){t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e}function R(t,e){var i,s,n=t.max_chain_length,r=t.strstart,o=t.prev_length,a=t.nice_match,h=t.strstart>t.w_size-C?t.strstart-(t.w_size-C):0,l=t.window,c=t.w_mask,d=t.prev,u=t.strstart+E,p=l[r+o-1],f=l[r+o];t.prev_length>=t.good_match&&(n>>=2),a>t.lookahead&&(a=t.lookahead);do{if(l[(i=e)+o]===f&&l[i+o-1]===p&&l[i]===l[r]&&l[++i]===l[r+1]){r+=2,i++;do{}while(l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&l[++r]===l[++i]&&r<u);if(s=E-(u-r),r=u-E,o<s){if(t.match_start=e,a<=(o=s))break;p=l[r+o-1],f=l[r+o]}}}while((e=d[e&c])>h&&0!=--n);return o<=t.lookahead?o:t.lookahead}function F(t){var e,i,s,r,h,l,c,d,u,p,f=t.w_size;do{if(r=t.window_size-t.lookahead-t.strstart,t.strstart>=f+(f-C)){for(n.arraySet(t.window,t.window,f,f,0),t.match_start-=f,t.strstart-=f,t.block_start-=f,e=i=t.hash_size;s=t.head[--e],t.head[e]=f<=s?s-f:0,--i;);for(e=i=f;s=t.prev[--e],t.prev[e]=f<=s?s-f:0,--i;);r+=f}if(0===t.strm.avail_in)break;if(l=t.strm,c=t.window,d=t.strstart+t.lookahead,p=void 0,(u=r)<(p=l.avail_in)&&(p=u),i=0===p?0:(l.avail_in-=p,n.arraySet(c,l.input,l.next_in,p,d),1===l.state.wrap?l.adler=o(l.adler,c,p,d):2===l.state.wrap&&(l.adler=a(l.adler,c,p,d)),l.next_in+=p,l.total_in+=p,p),t.lookahead+=i,t.lookahead+t.insert>=T)for(h=t.strstart-t.insert,t.ins_h=t.window[h],t.ins_h=(t.ins_h<<t.hash_shift^t.window[h+1])&t.hash_mask;t.insert&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[h+T-1])&t.hash_mask,t.prev[h&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=h,h++,t.insert--,!(t.lookahead+t.insert<T)););}while(t.lookahead<C&&0!==t.strm.avail_in)}function V(t,e){for(var i,s;;){if(t.lookahead<C){if(F(t),t.lookahead<C&&e===l)return S;if(0===t.lookahead)break}if(i=0,t.lookahead>=T&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+T-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==i&&t.strstart-i<=t.w_size-C&&(t.match_length=R(t,i)),t.match_length>=T)if(s=r._tr_tally(t,t.strstart-t.match_start,t.match_length-T),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=T){for(t.match_length--;t.strstart++,t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+T-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart,0!=--t.match_length;);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask;else s=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(s&&(U(t,!1),0===t.strm.avail_out))return S}return t.insert=t.strstart<T-1?t.strstart:T-1,e===c?(U(t,!0),0===t.strm.avail_out?k:z):t.last_lit&&(U(t,!1),0===t.strm.avail_out)?S:P}function Z(t,e){for(var i,s,n;;){if(t.lookahead<C){if(F(t),t.lookahead<C&&e===l)return S;if(0===t.lookahead)break}if(i=0,t.lookahead>=T&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+T-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=T-1,0!==i&&t.prev_length<t.max_lazy_match&&t.strstart-i<=t.w_size-C&&(t.match_length=R(t,i),t.match_length<=5&&(1===t.strategy||t.match_length===T&&4096<t.strstart-t.match_start)&&(t.match_length=T-1)),t.prev_length>=T&&t.match_length<=t.prev_length){for(n=t.strstart+t.lookahead-T,s=r._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-T),t.lookahead-=t.prev_length-1,t.prev_length-=2;++t.strstart<=n&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+T-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!=--t.prev_length;);if(t.match_available=0,t.match_length=T-1,t.strstart++,s&&(U(t,!1),0===t.strm.avail_out))return S}else if(t.match_available){if((s=r._tr_tally(t,0,t.window[t.strstart-1]))&&U(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return S}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(s=r._tr_tally(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<T-1?t.strstart:T-1,e===c?(U(t,!0),0===t.strm.avail_out?k:z):t.last_lit&&(U(t,!1),0===t.strm.avail_out)?S:P}function j(t,e,i,s,n){this.good_length=t,this.max_lazy=e,this.nice_length=i,this.max_chain=s,this.func=n}function H(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=g,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*b),this.dyn_dtree=new n.Buf16(2*(2*w+1)),this.bl_tree=new n.Buf16(2*(2*v+1)),D(this.dyn_ltree),D(this.dyn_dtree),D(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(x+1),this.heap=new n.Buf16(2*y+1),D(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*y+1),D(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Y(t){var e;return t&&t.state?(t.total_in=t.total_out=0,t.data_type=m,(e=t.state).pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?O:A,t.adler=2===e.wrap?0:1,e.last_flush=l,r._tr_init(e),d):M(t,u)}function W(t){var e,i=Y(t);return i===d&&((e=t.state).window_size=2*e.w_size,D(e.head),e.max_lazy_match=s[e.level].max_lazy,e.good_match=s[e.level].good_length,e.nice_match=s[e.level].nice_length,e.max_chain_length=s[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=T-1,e.match_available=0,e.ins_h=0),i}function $(t,e,i,s,r,o){if(!t)return u;var a=1;if(e===p&&(e=6),s<0?(a=0,s=-s):15<s&&(a=2,s-=16),r<1||_<r||i!==g||s<8||15<s||e<0||9<e||o<0||f<o)return M(t,u);8===s&&(s=9);var h=new H;return(t.state=h).strm=t,h.wrap=a,h.gzhead=null,h.w_bits=s,h.w_size=1<<h.w_bits,h.w_mask=h.w_size-1,h.hash_bits=r+7,h.hash_size=1<<h.hash_bits,h.hash_mask=h.hash_size-1,h.hash_shift=~~((h.hash_bits+T-1)/T),h.window=new n.Buf8(2*h.w_size),h.head=new n.Buf16(h.hash_size),h.prev=new n.Buf16(h.w_size),h.lit_bufsize=1<<r+6,h.pending_buf_size=4*h.lit_bufsize,h.pending_buf=new n.Buf8(h.pending_buf_size),h.d_buf=1*h.lit_bufsize,h.l_buf=3*h.lit_bufsize,h.level=e,h.strategy=o,h.method=i,W(t)}s=[new j(0,0,0,0,(function(t,e){var i=65535;for(i>t.pending_buf_size-5&&(i=t.pending_buf_size-5);;){if(t.lookahead<=1){if(F(t),0===t.lookahead&&e===l)return S;if(0===t.lookahead)break}t.strstart+=t.lookahead,t.lookahead=0;var s=t.block_start+i;if((0===t.strstart||t.strstart>=s)&&(t.lookahead=t.strstart-s,t.strstart=s,U(t,!1),0===t.strm.avail_out))return S;if(t.strstart-t.block_start>=t.w_size-C&&(U(t,!1),0===t.strm.avail_out))return S}return t.insert=0,e===c?(U(t,!0),0===t.strm.avail_out?k:z):(t.strstart>t.block_start&&(U(t,!1),t.strm.avail_out),S)})),new j(4,4,8,4,V),new j(4,5,16,8,V),new j(4,6,32,32,V),new j(4,4,16,16,Z),new j(8,16,32,32,Z),new j(8,16,128,128,Z),new j(8,32,128,256,Z),new j(32,128,258,1024,Z),new j(32,258,258,4096,Z)],i.deflateInit=function(t,e){return $(t,e,g,15,8,0)},i.deflateInit2=$,i.deflateReset=W,i.deflateResetKeep=Y,i.deflateSetHeader=function(t,e){return t&&t.state?2!==t.state.wrap?u:(t.state.gzhead=e,d):u},i.deflate=function(t,e){var i,n,o,h;if(!t||!t.state||5<e||e<0)return t?M(t,u):u;if(n=t.state,!t.output||!t.input&&0!==t.avail_in||666===n.status&&e!==c)return M(t,0===t.avail_out?-5:u);if(n.strm=t,i=n.last_flush,n.last_flush=e,n.status===O)if(2===n.wrap)t.adler=0,N(n,31),N(n,139),N(n,8),n.gzhead?(N(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),N(n,255&n.gzhead.time),N(n,n.gzhead.time>>8&255),N(n,n.gzhead.time>>16&255),N(n,n.gzhead.time>>24&255),N(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),N(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(N(n,255&n.gzhead.extra.length),N(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=a(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69):(N(n,0),N(n,0),N(n,0),N(n,0),N(n,0),N(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),N(n,3),n.status=A);else{var p=g+(n.w_bits-8<<4)<<8;p|=(2<=n.strategy||n.level<2?0:n.level<6?1:6===n.level?2:3)<<6,0!==n.strstart&&(p|=32),p+=31-p%31,n.status=A,L(n,p),0!==n.strstart&&(L(n,t.adler>>>16),L(n,65535&t.adler)),t.adler=1}if(69===n.status)if(n.gzhead.extra){for(o=n.pending;n.gzindex<(65535&n.gzhead.extra.length)&&(n.pending!==n.pending_buf_size||(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),I(t),o=n.pending,n.pending!==n.pending_buf_size));)N(n,255&n.gzhead.extra[n.gzindex]),n.gzindex++;n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),n.gzindex===n.gzhead.extra.length&&(n.gzindex=0,n.status=73)}else n.status=73;if(73===n.status)if(n.gzhead.name){o=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),I(t),o=n.pending,n.pending===n.pending_buf_size)){h=1;break}h=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,N(n,h)}while(0!==h);n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),0===h&&(n.gzindex=0,n.status=91)}else n.status=91;if(91===n.status)if(n.gzhead.comment){o=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),I(t),o=n.pending,n.pending===n.pending_buf_size)){h=1;break}h=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,N(n,h)}while(0!==h);n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),0===h&&(n.status=103)}else n.status=103;if(103===n.status&&(n.gzhead.hcrc?(n.pending+2>n.pending_buf_size&&I(t),n.pending+2<=n.pending_buf_size&&(N(n,255&t.adler),N(n,t.adler>>8&255),t.adler=0,n.status=A)):n.status=A),0!==n.pending){if(I(t),0===t.avail_out)return n.last_flush=-1,d}else if(0===t.avail_in&&B(e)<=B(i)&&e!==c)return M(t,-5);if(666===n.status&&0!==t.avail_in)return M(t,-5);if(0!==t.avail_in||0!==n.lookahead||e!==l&&666!==n.status){var f=2===n.strategy?function(t,e){for(var i;;){if(0===t.lookahead&&(F(t),0===t.lookahead)){if(e===l)return S;break}if(t.match_length=0,i=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,i&&(U(t,!1),0===t.strm.avail_out))return S}return t.insert=0,e===c?(U(t,!0),0===t.strm.avail_out?k:z):t.last_lit&&(U(t,!1),0===t.strm.avail_out)?S:P}(n,e):3===n.strategy?function(t,e){for(var i,s,n,o,a=t.window;;){if(t.lookahead<=E){if(F(t),t.lookahead<=E&&e===l)return S;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=T&&0<t.strstart&&(s=a[n=t.strstart-1])===a[++n]&&s===a[++n]&&s===a[++n]){o=t.strstart+E;do{}while(s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&n<o);t.match_length=E-(o-n),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=T?(i=r._tr_tally(t,1,t.match_length-T),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(i=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),i&&(U(t,!1),0===t.strm.avail_out))return S}return t.insert=0,e===c?(U(t,!0),0===t.strm.avail_out?k:z):t.last_lit&&(U(t,!1),0===t.strm.avail_out)?S:P}(n,e):s[n.level].func(n,e);if(f!==k&&f!==z||(n.status=666),f===S||f===k)return 0===t.avail_out&&(n.last_flush=-1),d;if(f===P&&(1===e?r._tr_align(n):5!==e&&(r._tr_stored_block(n,0,0,!1),3===e&&(D(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),I(t),0===t.avail_out))return n.last_flush=-1,d}return e!==c?d:n.wrap<=0?1:(2===n.wrap?(N(n,255&t.adler),N(n,t.adler>>8&255),N(n,t.adler>>16&255),N(n,t.adler>>24&255),N(n,255&t.total_in),N(n,t.total_in>>8&255),N(n,t.total_in>>16&255),N(n,t.total_in>>24&255)):(L(n,t.adler>>>16),L(n,65535&t.adler)),I(t),0<n.wrap&&(n.wrap=-n.wrap),0!==n.pending?d:1)},i.deflateEnd=function(t){var e;return t&&t.state?(e=t.state.status)!==O&&69!==e&&73!==e&&91!==e&&103!==e&&e!==A&&666!==e?M(t,u):(t.state=null,e===A?M(t,-3):d):u},i.deflateSetDictionary=function(t,e){var i,s,r,a,h,l,c,p,f=e.length;if(!t||!t.state)return u;if(2===(a=(i=t.state).wrap)||1===a&&i.status!==O||i.lookahead)return u;for(1===a&&(t.adler=o(t.adler,e,f,0)),i.wrap=0,f>=i.w_size&&(0===a&&(D(i.head),i.strstart=0,i.block_start=0,i.insert=0),p=new n.Buf8(i.w_size),n.arraySet(p,e,f-i.w_size,i.w_size,0),e=p,f=i.w_size),h=t.avail_in,l=t.next_in,c=t.input,t.avail_in=f,t.next_in=0,t.input=e,F(i);i.lookahead>=T;){for(s=i.strstart,r=i.lookahead-(T-1);i.ins_h=(i.ins_h<<i.hash_shift^i.window[s+T-1])&i.hash_mask,i.prev[s&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=s,s++,--r;);i.strstart=s,i.lookahead=T-1,F(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=T-1,i.match_available=0,t.next_in=l,t.input=c,t.avail_in=h,i.wrap=a,d},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,e,i){e.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,e,i){e.exports=function(t,e){var i,s,n,r,o,a,h,l,c,d,u,p,f,m,g,_,y,w,v,b,x,T,E,C,O;i=t.state,s=t.next_in,C=t.input,n=s+(t.avail_in-5),r=t.next_out,O=t.output,o=r-(e-t.avail_out),a=r+(t.avail_out-257),h=i.dmax,l=i.wsize,c=i.whave,d=i.wnext,u=i.window,p=i.hold,f=i.bits,m=i.lencode,g=i.distcode,_=(1<<i.lenbits)-1,y=(1<<i.distbits)-1;t:do{f<15&&(p+=C[s++]<<f,f+=8,p+=C[s++]<<f,f+=8),w=m[p&_];e:for(;;){if(p>>>=v=w>>>24,f-=v,0==(v=w>>>16&255))O[r++]=65535&w;else{if(!(16&v)){if(!(64&v)){w=m[(65535&w)+(p&(1<<v)-1)];continue e}if(32&v){i.mode=12;break t}t.msg="invalid literal/length code",i.mode=30;break t}b=65535&w,(v&=15)&&(f<v&&(p+=C[s++]<<f,f+=8),b+=p&(1<<v)-1,p>>>=v,f-=v),f<15&&(p+=C[s++]<<f,f+=8,p+=C[s++]<<f,f+=8),w=g[p&y];i:for(;;){if(p>>>=v=w>>>24,f-=v,!(16&(v=w>>>16&255))){if(!(64&v)){w=g[(65535&w)+(p&(1<<v)-1)];continue i}t.msg="invalid distance code",i.mode=30;break t}if(x=65535&w,f<(v&=15)&&(p+=C[s++]<<f,(f+=8)<v&&(p+=C[s++]<<f,f+=8)),h<(x+=p&(1<<v)-1)){t.msg="invalid distance too far back",i.mode=30;break t}if(p>>>=v,f-=v,(v=r-o)<x){if(c<(v=x-v)&&i.sane){t.msg="invalid distance too far back",i.mode=30;break t}if(E=u,(T=0)===d){if(T+=l-v,v<b){for(b-=v;O[r++]=u[T++],--v;);T=r-x,E=O}}else if(d<v){if(T+=l+d-v,(v-=d)<b){for(b-=v;O[r++]=u[T++],--v;);if(T=0,d<b){for(b-=v=d;O[r++]=u[T++],--v;);T=r-x,E=O}}}else if(T+=d-v,v<b){for(b-=v;O[r++]=u[T++],--v;);T=r-x,E=O}for(;2<b;)O[r++]=E[T++],O[r++]=E[T++],O[r++]=E[T++],b-=3;b&&(O[r++]=E[T++],1<b&&(O[r++]=E[T++]))}else{for(T=r-x;O[r++]=O[T++],O[r++]=O[T++],O[r++]=O[T++],2<(b-=3););b&&(O[r++]=O[T++],1<b&&(O[r++]=O[T++]))}break}}break}}while(s<n&&r<a);s-=b=f>>3,p&=(1<<(f-=b<<3))-1,t.next_in=s,t.next_out=r,t.avail_in=s<n?n-s+5:5-(s-n),t.avail_out=r<a?a-r+257:257-(r-a),i.hold=p,i.bits=f}},{}],49:[function(t,e,i){var s=t("../utils/common"),n=t("./adler32"),r=t("./crc32"),o=t("./inffast"),a=t("./inftrees"),h=1,l=2,c=0,d=-2,u=1,p=852,f=592;function m(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function g(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function _(t){var e;return t&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=u,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new s.Buf32(p),e.distcode=e.distdyn=new s.Buf32(f),e.sane=1,e.back=-1,c):d}function y(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,_(t)):d}function w(t,e){var i,s;return t&&t.state?(s=t.state,e<0?(i=0,e=-e):(i=1+(e>>4),e<48&&(e&=15)),e&&(e<8||15<e)?d:(null!==s.window&&s.wbits!==e&&(s.window=null),s.wrap=i,s.wbits=e,y(t))):d}function v(t,e){var i,s;return t?(s=new g,(t.state=s).window=null,(i=w(t,e))!==c&&(t.state=null),i):d}var b,x,T=!0;function E(t){if(T){var e;for(b=new s.Buf32(512),x=new s.Buf32(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(a(h,t.lens,0,288,b,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;a(l,t.lens,0,32,x,0,t.work,{bits:5}),T=!1}t.lencode=b,t.lenbits=9,t.distcode=x,t.distbits=5}function C(t,e,i,n){var r,o=t.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new s.Buf8(o.wsize)),n>=o.wsize?(s.arraySet(o.window,e,i-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):(n<(r=o.wsize-o.wnext)&&(r=n),s.arraySet(o.window,e,i-n,r,o.wnext),(n-=r)?(s.arraySet(o.window,e,i-n,n,0),o.wnext=n,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0}i.inflateReset=y,i.inflateReset2=w,i.inflateResetKeep=_,i.inflateInit=function(t){return v(t,15)},i.inflateInit2=v,i.inflate=function(t,e){var i,p,f,g,_,y,w,v,b,x,T,O,A,S,P,k,z,M,B,D,I,U,N,L,R=0,F=new s.Buf8(4),V=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return d;12===(i=t.state).mode&&(i.mode=13),_=t.next_out,f=t.output,w=t.avail_out,g=t.next_in,p=t.input,y=t.avail_in,v=i.hold,b=i.bits,x=y,T=w,U=c;t:for(;;)switch(i.mode){case u:if(0===i.wrap){i.mode=13;break}for(;b<16;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(2&i.wrap&&35615===v){F[i.check=0]=255&v,F[1]=v>>>8&255,i.check=r(i.check,F,2,0),b=v=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&v)<<8)+(v>>8))%31){t.msg="incorrect header check",i.mode=30;break}if(8!=(15&v)){t.msg="unknown compression method",i.mode=30;break}if(b-=4,I=8+(15&(v>>>=4)),0===i.wbits)i.wbits=I;else if(I>i.wbits){t.msg="invalid window size",i.mode=30;break}i.dmax=1<<I,t.adler=i.check=1,i.mode=512&v?10:12,b=v=0;break;case 2:for(;b<16;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(i.flags=v,8!=(255&i.flags)){t.msg="unknown compression method",i.mode=30;break}if(57344&i.flags){t.msg="unknown header flags set",i.mode=30;break}i.head&&(i.head.text=v>>8&1),512&i.flags&&(F[0]=255&v,F[1]=v>>>8&255,i.check=r(i.check,F,2,0)),b=v=0,i.mode=3;case 3:for(;b<32;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.head&&(i.head.time=v),512&i.flags&&(F[0]=255&v,F[1]=v>>>8&255,F[2]=v>>>16&255,F[3]=v>>>24&255,i.check=r(i.check,F,4,0)),b=v=0,i.mode=4;case 4:for(;b<16;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.head&&(i.head.xflags=255&v,i.head.os=v>>8),512&i.flags&&(F[0]=255&v,F[1]=v>>>8&255,i.check=r(i.check,F,2,0)),b=v=0,i.mode=5;case 5:if(1024&i.flags){for(;b<16;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.length=v,i.head&&(i.head.extra_len=v),512&i.flags&&(F[0]=255&v,F[1]=v>>>8&255,i.check=r(i.check,F,2,0)),b=v=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&(y<(O=i.length)&&(O=y),O&&(i.head&&(I=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),s.arraySet(i.head.extra,p,g,O,I)),512&i.flags&&(i.check=r(i.check,p,O,g)),y-=O,g+=O,i.length-=O),i.length))break t;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===y)break t;for(O=0;I=p[g+O++],i.head&&I&&i.length<65536&&(i.head.name+=String.fromCharCode(I)),I&&O<y;);if(512&i.flags&&(i.check=r(i.check,p,O,g)),y-=O,g+=O,I)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===y)break t;for(O=0;I=p[g+O++],i.head&&I&&i.length<65536&&(i.head.comment+=String.fromCharCode(I)),I&&O<y;);if(512&i.flags&&(i.check=r(i.check,p,O,g)),y-=O,g+=O,I)break t}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;b<16;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(v!==(65535&i.check)){t.msg="header crc mismatch",i.mode=30;break}b=v=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=12;break;case 10:for(;b<32;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}t.adler=i.check=m(v),b=v=0,i.mode=11;case 11:if(0===i.havedict)return t.next_out=_,t.avail_out=w,t.next_in=g,t.avail_in=y,i.hold=v,i.bits=b,2;t.adler=i.check=1,i.mode=12;case 12:if(5===e||6===e)break t;case 13:if(i.last){v>>>=7&b,b-=7&b,i.mode=27;break}for(;b<3;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}switch(i.last=1&v,b-=1,3&(v>>>=1)){case 0:i.mode=14;break;case 1:if(E(i),i.mode=20,6!==e)break;v>>>=2,b-=2;break t;case 2:i.mode=17;break;case 3:t.msg="invalid block type",i.mode=30}v>>>=2,b-=2;break;case 14:for(v>>>=7&b,b-=7&b;b<32;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if((65535&v)!=(v>>>16^65535)){t.msg="invalid stored block lengths",i.mode=30;break}if(i.length=65535&v,b=v=0,i.mode=15,6===e)break t;case 15:i.mode=16;case 16:if(O=i.length){if(y<O&&(O=y),w<O&&(O=w),0===O)break t;s.arraySet(f,p,g,O,_),y-=O,g+=O,w-=O,_+=O,i.length-=O;break}i.mode=12;break;case 17:for(;b<14;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(i.nlen=257+(31&v),v>>>=5,b-=5,i.ndist=1+(31&v),v>>>=5,b-=5,i.ncode=4+(15&v),v>>>=4,b-=4,286<i.nlen||30<i.ndist){t.msg="too many length or distance symbols",i.mode=30;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;b<3;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.lens[V[i.have++]]=7&v,v>>>=3,b-=3}for(;i.have<19;)i.lens[V[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,N={bits:i.lenbits},U=a(0,i.lens,0,19,i.lencode,0,i.work,N),i.lenbits=N.bits,U){t.msg="invalid code lengths set",i.mode=30;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;k=(R=i.lencode[v&(1<<i.lenbits)-1])>>>16&255,z=65535&R,!((P=R>>>24)<=b);){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(z<16)v>>>=P,b-=P,i.lens[i.have++]=z;else{if(16===z){for(L=P+2;b<L;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(v>>>=P,b-=P,0===i.have){t.msg="invalid bit length repeat",i.mode=30;break}I=i.lens[i.have-1],O=3+(3&v),v>>>=2,b-=2}else if(17===z){for(L=P+3;b<L;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}b-=P,I=0,O=3+(7&(v>>>=P)),v>>>=3,b-=3}else{for(L=P+7;b<L;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}b-=P,I=0,O=11+(127&(v>>>=P)),v>>>=7,b-=7}if(i.have+O>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=30;break}for(;O--;)i.lens[i.have++]=I}}if(30===i.mode)break;if(0===i.lens[256]){t.msg="invalid code -- missing end-of-block",i.mode=30;break}if(i.lenbits=9,N={bits:i.lenbits},U=a(h,i.lens,0,i.nlen,i.lencode,0,i.work,N),i.lenbits=N.bits,U){t.msg="invalid literal/lengths set",i.mode=30;break}if(i.distbits=6,i.distcode=i.distdyn,N={bits:i.distbits},U=a(l,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,N),i.distbits=N.bits,U){t.msg="invalid distances set",i.mode=30;break}if(i.mode=20,6===e)break t;case 20:i.mode=21;case 21:if(6<=y&&258<=w){t.next_out=_,t.avail_out=w,t.next_in=g,t.avail_in=y,i.hold=v,i.bits=b,o(t,T),_=t.next_out,f=t.output,w=t.avail_out,g=t.next_in,p=t.input,y=t.avail_in,v=i.hold,b=i.bits,12===i.mode&&(i.back=-1);break}for(i.back=0;k=(R=i.lencode[v&(1<<i.lenbits)-1])>>>16&255,z=65535&R,!((P=R>>>24)<=b);){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(k&&!(240&k)){for(M=P,B=k,D=z;k=(R=i.lencode[D+((v&(1<<M+B)-1)>>M)])>>>16&255,z=65535&R,!(M+(P=R>>>24)<=b);){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}v>>>=M,b-=M,i.back+=M}if(v>>>=P,b-=P,i.back+=P,i.length=z,0===k){i.mode=26;break}if(32&k){i.back=-1,i.mode=12;break}if(64&k){t.msg="invalid literal/length code",i.mode=30;break}i.extra=15&k,i.mode=22;case 22:if(i.extra){for(L=i.extra;b<L;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.length+=v&(1<<i.extra)-1,v>>>=i.extra,b-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;k=(R=i.distcode[v&(1<<i.distbits)-1])>>>16&255,z=65535&R,!((P=R>>>24)<=b);){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(!(240&k)){for(M=P,B=k,D=z;k=(R=i.distcode[D+((v&(1<<M+B)-1)>>M)])>>>16&255,z=65535&R,!(M+(P=R>>>24)<=b);){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}v>>>=M,b-=M,i.back+=M}if(v>>>=P,b-=P,i.back+=P,64&k){t.msg="invalid distance code",i.mode=30;break}i.offset=z,i.extra=15&k,i.mode=24;case 24:if(i.extra){for(L=i.extra;b<L;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}i.offset+=v&(1<<i.extra)-1,v>>>=i.extra,b-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=30;break}i.mode=25;case 25:if(0===w)break t;if(O=T-w,i.offset>O){if((O=i.offset-O)>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=30;break}A=O>i.wnext?(O-=i.wnext,i.wsize-O):i.wnext-O,O>i.length&&(O=i.length),S=i.window}else S=f,A=_-i.offset,O=i.length;for(w<O&&(O=w),w-=O,i.length-=O;f[_++]=S[A++],--O;);0===i.length&&(i.mode=21);break;case 26:if(0===w)break t;f[_++]=i.length,w--,i.mode=21;break;case 27:if(i.wrap){for(;b<32;){if(0===y)break t;y--,v|=p[g++]<<b,b+=8}if(T-=w,t.total_out+=T,i.total+=T,T&&(t.adler=i.check=i.flags?r(i.check,f,T,_-T):n(i.check,f,T,_-T)),T=w,(i.flags?v:m(v))!==i.check){t.msg="incorrect data check",i.mode=30;break}b=v=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;b<32;){if(0===y)break t;y--,v+=p[g++]<<b,b+=8}if(v!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=30;break}b=v=0}i.mode=29;case 29:U=1;break t;case 30:U=-3;break t;case 31:return-4;default:return d}return t.next_out=_,t.avail_out=w,t.next_in=g,t.avail_in=y,i.hold=v,i.bits=b,(i.wsize||T!==t.avail_out&&i.mode<30&&(i.mode<27||4!==e))&&C(t,t.output,t.next_out,T-t.avail_out)?(i.mode=31,-4):(x-=t.avail_in,T-=t.avail_out,t.total_in+=x,t.total_out+=T,i.total+=T,i.wrap&&T&&(t.adler=i.check=i.flags?r(i.check,f,T,t.next_out-T):n(i.check,f,T,t.next_out-T)),t.data_type=i.bits+(i.last?64:0)+(12===i.mode?128:0)+(20===i.mode||15===i.mode?256:0),(0==x&&0===T||4===e)&&U===c&&(U=-5),U)},i.inflateEnd=function(t){if(!t||!t.state)return d;var e=t.state;return e.window&&(e.window=null),t.state=null,c},i.inflateGetHeader=function(t,e){var i;return t&&t.state&&2&(i=t.state).wrap?((i.head=e).done=!1,c):d},i.inflateSetDictionary=function(t,e){var i,s=e.length;return t&&t.state?0!==(i=t.state).wrap&&11!==i.mode?d:11===i.mode&&n(1,e,s,0)!==i.check?-3:C(t,e,s,s)?(i.mode=31,-4):(i.havedict=1,c):d},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,e,i){var s=t("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],a=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(t,e,i,h,l,c,d,u){var p,f,m,g,_,y,w,v,b,x=u.bits,T=0,E=0,C=0,O=0,A=0,S=0,P=0,k=0,z=0,M=0,B=null,D=0,I=new s.Buf16(16),U=new s.Buf16(16),N=null,L=0;for(T=0;T<=15;T++)I[T]=0;for(E=0;E<h;E++)I[e[i+E]]++;for(A=x,O=15;1<=O&&0===I[O];O--);if(O<A&&(A=O),0===O)return l[c++]=20971520,l[c++]=20971520,u.bits=1,0;for(C=1;C<O&&0===I[C];C++);for(A<C&&(A=C),T=k=1;T<=15;T++)if(k<<=1,(k-=I[T])<0)return-1;if(0<k&&(0===t||1!==O))return-1;for(U[1]=0,T=1;T<15;T++)U[T+1]=U[T]+I[T];for(E=0;E<h;E++)0!==e[i+E]&&(d[U[e[i+E]]++]=E);if(y=0===t?(B=N=d,19):1===t?(B=n,D-=257,N=r,L-=257,256):(B=o,N=a,-1),T=C,_=c,P=E=M=0,m=-1,g=(z=1<<(S=A))-1,1===t&&852<z||2===t&&592<z)return 1;for(;;){for(w=T-P,b=d[E]<y?(v=0,d[E]):d[E]>y?(v=N[L+d[E]],B[D+d[E]]):(v=96,0),p=1<<T-P,C=f=1<<S;l[_+(M>>P)+(f-=p)]=w<<24|v<<16|b,0!==f;);for(p=1<<T-1;M&p;)p>>=1;if(0!==p?(M&=p-1,M+=p):M=0,E++,0==--I[T]){if(T===O)break;T=e[i+d[E]]}if(A<T&&(M&g)!==m){for(0===P&&(P=A),_+=C,k=1<<(S=T-P);S+P<O&&!((k-=I[S+P])<=0);)S++,k<<=1;if(z+=1<<S,1===t&&852<z||2===t&&592<z)return 1;l[m=M&g]=A<<24|S<<16|_-c}}return 0!==M&&(l[_+M]=T-P<<24|64<<16),u.bits=A,0}},{"../utils/common":41}],51:[function(t,e,i){e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,e,i){var s=t("../utils/common"),n=0,r=1;function o(t){for(var e=t.length;0<=--e;)t[e]=0}var a=0,h=29,l=256,c=l+1+h,d=30,u=19,p=2*c+1,f=15,m=16,g=7,_=256,y=16,w=17,v=18,b=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],x=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],T=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],E=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],C=new Array(2*(c+2));o(C);var O=new Array(2*d);o(O);var A=new Array(512);o(A);var S=new Array(256);o(S);var P=new Array(h);o(P);var k,z,M,B=new Array(d);function D(t,e,i,s,n){this.static_tree=t,this.extra_bits=e,this.extra_base=i,this.elems=s,this.max_length=n,this.has_stree=t&&t.length}function I(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}function U(t){return t<256?A[t]:A[256+(t>>>7)]}function N(t,e){t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255}function L(t,e,i){t.bi_valid>m-i?(t.bi_buf|=e<<t.bi_valid&65535,N(t,t.bi_buf),t.bi_buf=e>>m-t.bi_valid,t.bi_valid+=i-m):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=i)}function R(t,e,i){L(t,i[2*e],i[2*e+1])}function F(t,e){for(var i=0;i|=1&t,t>>>=1,i<<=1,0<--e;);return i>>>1}function V(t,e,i){var s,n,r=new Array(f+1),o=0;for(s=1;s<=f;s++)r[s]=o=o+i[s-1]<<1;for(n=0;n<=e;n++){var a=t[2*n+1];0!==a&&(t[2*n]=F(r[a]++,a))}}function Z(t){var e;for(e=0;e<c;e++)t.dyn_ltree[2*e]=0;for(e=0;e<d;e++)t.dyn_dtree[2*e]=0;for(e=0;e<u;e++)t.bl_tree[2*e]=0;t.dyn_ltree[2*_]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0}function j(t){8<t.bi_valid?N(t,t.bi_buf):0<t.bi_valid&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0}function H(t,e,i,s){var n=2*e,r=2*i;return t[n]<t[r]||t[n]===t[r]&&s[e]<=s[i]}function Y(t,e,i){for(var s=t.heap[i],n=i<<1;n<=t.heap_len&&(n<t.heap_len&&H(e,t.heap[n+1],t.heap[n],t.depth)&&n++,!H(e,s,t.heap[n],t.depth));)t.heap[i]=t.heap[n],i=n,n<<=1;t.heap[i]=s}function W(t,e,i){var s,n,r,o,a=0;if(0!==t.last_lit)for(;s=t.pending_buf[t.d_buf+2*a]<<8|t.pending_buf[t.d_buf+2*a+1],n=t.pending_buf[t.l_buf+a],a++,0===s?R(t,n,e):(R(t,(r=S[n])+l+1,e),0!==(o=b[r])&&L(t,n-=P[r],o),R(t,r=U(--s),i),0!==(o=x[r])&&L(t,s-=B[r],o)),a<t.last_lit;);R(t,_,e)}function $(t,e){var i,s,n,r=e.dyn_tree,o=e.stat_desc.static_tree,a=e.stat_desc.has_stree,h=e.stat_desc.elems,l=-1;for(t.heap_len=0,t.heap_max=p,i=0;i<h;i++)0!==r[2*i]?(t.heap[++t.heap_len]=l=i,t.depth[i]=0):r[2*i+1]=0;for(;t.heap_len<2;)r[2*(n=t.heap[++t.heap_len]=l<2?++l:0)]=1,t.depth[n]=0,t.opt_len--,a&&(t.static_len-=o[2*n+1]);for(e.max_code=l,i=t.heap_len>>1;1<=i;i--)Y(t,r,i);for(n=h;i=t.heap[1],t.heap[1]=t.heap[t.heap_len--],Y(t,r,1),s=t.heap[1],t.heap[--t.heap_max]=i,t.heap[--t.heap_max]=s,r[2*n]=r[2*i]+r[2*s],t.depth[n]=(t.depth[i]>=t.depth[s]?t.depth[i]:t.depth[s])+1,r[2*i+1]=r[2*s+1]=n,t.heap[1]=n++,Y(t,r,1),2<=t.heap_len;);t.heap[--t.heap_max]=t.heap[1],function(t,e){var i,s,n,r,o,a,h=e.dyn_tree,l=e.max_code,c=e.stat_desc.static_tree,d=e.stat_desc.has_stree,u=e.stat_desc.extra_bits,m=e.stat_desc.extra_base,g=e.stat_desc.max_length,_=0;for(r=0;r<=f;r++)t.bl_count[r]=0;for(h[2*t.heap[t.heap_max]+1]=0,i=t.heap_max+1;i<p;i++)g<(r=h[2*h[2*(s=t.heap[i])+1]+1]+1)&&(r=g,_++),h[2*s+1]=r,l<s||(t.bl_count[r]++,o=0,m<=s&&(o=u[s-m]),a=h[2*s],t.opt_len+=a*(r+o),d&&(t.static_len+=a*(c[2*s+1]+o)));if(0!==_){do{for(r=g-1;0===t.bl_count[r];)r--;t.bl_count[r]--,t.bl_count[r+1]+=2,t.bl_count[g]--,_-=2}while(0<_);for(r=g;0!==r;r--)for(s=t.bl_count[r];0!==s;)l<(n=t.heap[--i])||(h[2*n+1]!==r&&(t.opt_len+=(r-h[2*n+1])*h[2*n],h[2*n+1]=r),s--)}}(t,e),V(r,l,t.bl_count)}function X(t,e,i){var s,n,r=-1,o=e[1],a=0,h=7,l=4;for(0===o&&(h=138,l=3),e[2*(i+1)+1]=65535,s=0;s<=i;s++)n=o,o=e[2*(s+1)+1],++a<h&&n===o||(a<l?t.bl_tree[2*n]+=a:0!==n?(n!==r&&t.bl_tree[2*n]++,t.bl_tree[2*y]++):a<=10?t.bl_tree[2*w]++:t.bl_tree[2*v]++,r=n,l=(a=0)===o?(h=138,3):n===o?(h=6,3):(h=7,4))}function G(t,e,i){var s,n,r=-1,o=e[1],a=0,h=7,l=4;for(0===o&&(h=138,l=3),s=0;s<=i;s++)if(n=o,o=e[2*(s+1)+1],!(++a<h&&n===o)){if(a<l)for(;R(t,n,t.bl_tree),0!=--a;);else 0!==n?(n!==r&&(R(t,n,t.bl_tree),a--),R(t,y,t.bl_tree),L(t,a-3,2)):a<=10?(R(t,w,t.bl_tree),L(t,a-3,3)):(R(t,v,t.bl_tree),L(t,a-11,7));r=n,l=(a=0)===o?(h=138,3):n===o?(h=6,3):(h=7,4)}}o(B);var Q=!1;function q(t,e,i,n){var r,o,h;L(t,(a<<1)+(n?1:0),3),o=e,h=i,j(r=t),N(r,h),N(r,~h),s.arraySet(r.pending_buf,r.window,o,h,r.pending),r.pending+=h}i._tr_init=function(t){Q||(function(){var t,e,i,s,n,r=new Array(f+1);for(s=i=0;s<h-1;s++)for(P[s]=i,t=0;t<1<<b[s];t++)S[i++]=s;for(S[i-1]=s,s=n=0;s<16;s++)for(B[s]=n,t=0;t<1<<x[s];t++)A[n++]=s;for(n>>=7;s<d;s++)for(B[s]=n<<7,t=0;t<1<<x[s]-7;t++)A[256+n++]=s;for(e=0;e<=f;e++)r[e]=0;for(t=0;t<=143;)C[2*t+1]=8,t++,r[8]++;for(;t<=255;)C[2*t+1]=9,t++,r[9]++;for(;t<=279;)C[2*t+1]=7,t++,r[7]++;for(;t<=287;)C[2*t+1]=8,t++,r[8]++;for(V(C,c+1,r),t=0;t<d;t++)O[2*t+1]=5,O[2*t]=F(t,5);k=new D(C,b,l+1,c,f),z=new D(O,x,0,d,f),M=new D(new Array(0),T,0,u,g)}(),Q=!0),t.l_desc=new I(t.dyn_ltree,k),t.d_desc=new I(t.dyn_dtree,z),t.bl_desc=new I(t.bl_tree,M),t.bi_buf=0,t.bi_valid=0,Z(t)},i._tr_stored_block=q,i._tr_flush_block=function(t,e,i,s){var o,a,h=0;0<t.level?(2===t.strm.data_type&&(t.strm.data_type=function(t){var e,i=4093624447;for(e=0;e<=31;e++,i>>>=1)if(1&i&&0!==t.dyn_ltree[2*e])return n;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return r;for(e=32;e<l;e++)if(0!==t.dyn_ltree[2*e])return r;return n}(t)),$(t,t.l_desc),$(t,t.d_desc),h=function(t){var e;for(X(t,t.dyn_ltree,t.l_desc.max_code),X(t,t.dyn_dtree,t.d_desc.max_code),$(t,t.bl_desc),e=u-1;3<=e&&0===t.bl_tree[2*E[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e}(t),o=t.opt_len+3+7>>>3,(a=t.static_len+3+7>>>3)<=o&&(o=a)):o=a=i+5,i+4<=o&&-1!==e?q(t,e,i,s):4===t.strategy||a===o?(L(t,2+(s?1:0),3),W(t,C,O)):(L(t,4+(s?1:0),3),function(t,e,i,s){var n;for(L(t,e-257,5),L(t,i-1,5),L(t,s-4,4),n=0;n<s;n++)L(t,t.bl_tree[2*E[n]+1],3);G(t,t.dyn_ltree,e-1),G(t,t.dyn_dtree,i-1)}(t,t.l_desc.max_code+1,t.d_desc.max_code+1,h+1),W(t,t.dyn_ltree,t.dyn_dtree)),Z(t),s&&j(t)},i._tr_tally=function(t,e,i){return t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&i,t.last_lit++,0===e?t.dyn_ltree[2*i]++:(t.matches++,e--,t.dyn_ltree[2*(S[i]+l+1)]++,t.dyn_dtree[2*U(e)]++),t.last_lit===t.lit_bufsize-1},i._tr_align=function(t){var e;L(t,2,3),R(t,_,C),16===(e=t).bi_valid?(N(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):8<=e.bi_valid&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}},{"../utils/common":41}],53:[function(t,e,i){e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,e,i){(function(t){!function(t,e){if(!t.setImmediate){var i,s,n,r,o=1,a={},h=!1,l=t.document,c=Object.getPrototypeOf&&Object.getPrototypeOf(t);c=c&&c.setTimeout?c:t,i="[object process]"==={}.toString.call(t.process)?function(t){process.nextTick((function(){u(t)}))}:function(){if(t.postMessage&&!t.importScripts){var e=!0,i=t.onmessage;return t.onmessage=function(){e=!1},t.postMessage("","*"),t.onmessage=i,e}}()?(r="setImmediate$"+Math.random()+"$",t.addEventListener?t.addEventListener("message",p,!1):t.attachEvent("onmessage",p),function(e){t.postMessage(r+e,"*")}):t.MessageChannel?((n=new MessageChannel).port1.onmessage=function(t){u(t.data)},function(t){n.port2.postMessage(t)}):l&&"onreadystatechange"in l.createElement("script")?(s=l.documentElement,function(t){var e=l.createElement("script");e.onreadystatechange=function(){u(t),e.onreadystatechange=null,s.removeChild(e),e=null},s.appendChild(e)}):function(t){setTimeout(u,0,t)},c.setImmediate=function(t){"function"!=typeof t&&(t=new Function(""+t));for(var e=new Array(arguments.length-1),s=0;s<e.length;s++)e[s]=arguments[s+1];var n={callback:t,args:e};return a[o]=n,i(o),o++},c.clearImmediate=d}function d(t){delete a[t]}function u(t){if(h)setTimeout(u,0,t);else{var i=a[t];if(i){h=!0;try{!function(t){var i=t.callback,s=t.args;switch(s.length){case 0:i();break;case 1:i(s[0]);break;case 2:i(s[0],s[1]);break;case 3:i(s[0],s[1],s[2]);break;default:i.apply(e,s)}}(i)}finally{d(t),h=!1}}}}function p(e){e.source===t&&"string"==typeof e.data&&0===e.data.indexOf(r)&&u(+e.data.slice(r.length))}}("undefined"==typeof self?void 0===t?this:t:self)}).call(this,void 0!==fs?fs:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[10])(10));var ws={},vs={};!function(t){const e=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",i="["+e+"]["+(e+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*",s=new RegExp("^"+i+"$");t.isExist=function(t){return void 0!==t},t.isEmptyObject=function(t){return 0===Object.keys(t).length},t.merge=function(t,e,i){if(e){const s=Object.keys(e),n=s.length;for(let r=0;r<n;r++)t[s[r]]="strict"===i?[e[s[r]]]:e[s[r]]}},t.getValue=function(e){return t.isExist(e)?e:""},t.isName=function(t){const e=s.exec(t);return!(null==e)},t.getAllMatches=function(t,e){const i=[];let s=e.exec(t);for(;s;){const n=[];n.startIndex=e.lastIndex-s[0].length;const r=s.length;for(let t=0;t<r;t++)n.push(s[t]);i.push(n),s=e.exec(t)}return i},t.nameRegexp=i}(vs);const bs=vs,xs={allowBooleanAttributes:!1,unpairedTags:[]};function Ts(t){return" "===t||"\t"===t||"\n"===t||"\r"===t}function Es(t,e){const i=e;for(;e<t.length;e++)if("?"!=t[e]&&" "!=t[e]);else{const s=t.substr(i,e-i);if(e>5&&"xml"===s)return Ms("InvalidXml","XML declaration allowed only at the start of the document.",Ds(t,e));if("?"==t[e]&&">"==t[e+1]){e++;break}}return e}function Cs(t,e){if(t.length>e+5&&"-"===t[e+1]&&"-"===t[e+2]){for(e+=3;e<t.length;e++)if("-"===t[e]&&"-"===t[e+1]&&">"===t[e+2]){e+=2;break}}else if(t.length>e+8&&"D"===t[e+1]&&"O"===t[e+2]&&"C"===t[e+3]&&"T"===t[e+4]&&"Y"===t[e+5]&&"P"===t[e+6]&&"E"===t[e+7]){let i=1;for(e+=8;e<t.length;e++)if("<"===t[e])i++;else if(">"===t[e]&&(i--,0===i))break}else if(t.length>e+9&&"["===t[e+1]&&"C"===t[e+2]&&"D"===t[e+3]&&"A"===t[e+4]&&"T"===t[e+5]&&"A"===t[e+6]&&"["===t[e+7])for(e+=8;e<t.length;e++)if("]"===t[e]&&"]"===t[e+1]&&">"===t[e+2]){e+=2;break}return e}ws.validate=function(t,e){e=Object.assign({},xs,e);const i=[];let s=!1,n=!1;"\ufeff"===t[0]&&(t=t.substr(1));for(let o=0;o<t.length;o++)if("<"===t[o]&&"?"===t[o+1]){if(o+=2,o=Es(t,o),o.err)return o}else{if("<"!==t[o]){if(Ts(t[o]))continue;return Ms("InvalidChar","char '"+t[o]+"' is not expected.",Ds(t,o))}{let a=o;if(o++,"!"===t[o]){o=Cs(t,o);continue}{let h=!1;"/"===t[o]&&(h=!0,o++);let l="";for(;o<t.length&&">"!==t[o]&&" "!==t[o]&&"\t"!==t[o]&&"\n"!==t[o]&&"\r"!==t[o];o++)l+=t[o];if(l=l.trim(),"/"===l[l.length-1]&&(l=l.substring(0,l.length-1),o--),r=l,!bs.isName(r)){let e;return e=0===l.trim().length?"Invalid space after '<'.":"Tag '"+l+"' is an invalid name.",Ms("InvalidTag",e,Ds(t,o))}const c=Ss(t,o);if(!1===c)return Ms("InvalidAttr","Attributes for '"+l+"' have open quote.",Ds(t,o));let d=c.value;if(o=c.index,"/"===d[d.length-1]){const i=o-d.length;d=d.substring(0,d.length-1);const n=ks(d,e);if(!0!==n)return Ms(n.err.code,n.err.msg,Ds(t,i+n.err.line));s=!0}else if(h){if(!c.tagClosed)return Ms("InvalidTag","Closing tag '"+l+"' doesn't have proper closing.",Ds(t,o));if(d.trim().length>0)return Ms("InvalidTag","Closing tag '"+l+"' can't have attributes or invalid starting.",Ds(t,a));if(0===i.length)return Ms("InvalidTag","Closing tag '"+l+"' has not been opened.",Ds(t,a));{const e=i.pop();if(l!==e.tagName){let i=Ds(t,e.tagStartPos);return Ms("InvalidTag","Expected closing tag '"+e.tagName+"' (opened in line "+i.line+", col "+i.col+") instead of closing tag '"+l+"'.",Ds(t,a))}0==i.length&&(n=!0)}}else{const r=ks(d,e);if(!0!==r)return Ms(r.err.code,r.err.msg,Ds(t,o-d.length+r.err.line));if(!0===n)return Ms("InvalidXml","Multiple possible root nodes found.",Ds(t,o));-1!==e.unpairedTags.indexOf(l)||i.push({tagName:l,tagStartPos:a}),s=!0}for(o++;o<t.length;o++)if("<"===t[o]){if("!"===t[o+1]){o++,o=Cs(t,o);continue}if("?"!==t[o+1])break;if(o=Es(t,++o),o.err)return o}else if("&"===t[o]){const e=zs(t,o);if(-1==e)return Ms("InvalidChar","char '&' is not expected.",Ds(t,o));o=e}else if(!0===n&&!Ts(t[o]))return Ms("InvalidXml","Extra text at the end",Ds(t,o));"<"===t[o]&&o--}}}var r;return s?1==i.length?Ms("InvalidTag","Unclosed tag '"+i[0].tagName+"'.",Ds(t,i[0].tagStartPos)):!(i.length>0)||Ms("InvalidXml","Invalid '"+JSON.stringify(i.map((t=>t.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):Ms("InvalidXml","Start tag expected.",1)};const Os='"',As="'";function Ss(t,e){let i="",s="",n=!1;for(;e<t.length;e++){if(t[e]===Os||t[e]===As)""===s?s=t[e]:s!==t[e]||(s="");else if(">"===t[e]&&""===s){n=!0;break}i+=t[e]}return""===s&&{value:i,index:e,tagClosed:n}}const Ps=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function ks(t,e){const i=bs.getAllMatches(t,Ps),s={};for(let t=0;t<i.length;t++){if(0===i[t][1].length)return Ms("InvalidAttr","Attribute '"+i[t][2]+"' has no space in starting.",Is(i[t]));if(void 0!==i[t][3]&&void 0===i[t][4])return Ms("InvalidAttr","Attribute '"+i[t][2]+"' is without value.",Is(i[t]));if(void 0===i[t][3]&&!e.allowBooleanAttributes)return Ms("InvalidAttr","boolean attribute '"+i[t][2]+"' is not allowed.",Is(i[t]));const n=i[t][2];if(!Bs(n))return Ms("InvalidAttr","Attribute '"+n+"' is an invalid name.",Is(i[t]));if(s.hasOwnProperty(n))return Ms("InvalidAttr","Attribute '"+n+"' is repeated.",Is(i[t]));s[n]=1}return!0}function zs(t,e){if(";"===t[++e])return-1;if("#"===t[e])return function(t,e){let i=/\d/;for("x"===t[e]&&(e++,i=/[\da-fA-F]/);e<t.length;e++){if(";"===t[e])return e;if(!t[e].match(i))break}return-1}(t,++e);let i=0;for(;e<t.length;e++,i++)if(!(t[e].match(/\w/)&&i<20)){if(";"===t[e])break;return-1}return e}function Ms(t,e,i){return{err:{code:t,msg:e,line:i.line||i,col:i.col}}}function Bs(t){return bs.isName(t)}function Ds(t,e){const i=t.substring(0,e).split(/\r?\n/);return{line:i.length,col:i[i.length-1].length+1}}function Is(t){return t.startIndex+t[1].length}var Us={};const Ns={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(t,e,i){return t}};Us.buildOptions=function(t){return Object.assign({},Ns,t)},Us.defaultOptions=Ns;const Ls=vs;function Rs(t,e){let i="";for(;e<t.length&&"'"!==t[e]&&'"'!==t[e];e++)i+=t[e];if(i=i.trim(),-1!==i.indexOf(" "))throw new Error("External entites are not supported");const s=t[e++];let n="";for(;e<t.length&&t[e]!==s;e++)n+=t[e];return[i,n,e]}function Fs(t,e){return"!"===t[e+1]&&"E"===t[e+2]&&"N"===t[e+3]&&"T"===t[e+4]&&"I"===t[e+5]&&"T"===t[e+6]&&"Y"===t[e+7]}function Vs(t,e){return"!"===t[e+1]&&"E"===t[e+2]&&"L"===t[e+3]&&"E"===t[e+4]&&"M"===t[e+5]&&"E"===t[e+6]&&"N"===t[e+7]&&"T"===t[e+8]}function Zs(t,e){return"!"===t[e+1]&&"A"===t[e+2]&&"T"===t[e+3]&&"T"===t[e+4]&&"L"===t[e+5]&&"I"===t[e+6]&&"S"===t[e+7]&&"T"===t[e+8]}function js(t,e){return"!"===t[e+1]&&"N"===t[e+2]&&"O"===t[e+3]&&"T"===t[e+4]&&"A"===t[e+5]&&"T"===t[e+6]&&"I"===t[e+7]&&"O"===t[e+8]&&"N"===t[e+9]}function Hs(t){if(Ls.isName(t))return t;throw new Error(`Invalid entity name ${t}`)}const Ys=/^[-+]?0x[a-fA-F0-9]+$/,Ws=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,$s={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};const Xs=vs,Gs=class{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,e){"__proto__"===t&&(t="#__proto__"),this.child.push({[t]:e})}addChild(t){"__proto__"===t.tagname&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,":@":t[":@"]}):this.child.push({[t.tagname]:t.child})}},Qs=function(t,e){const i={};if("O"!==t[e+3]||"C"!==t[e+4]||"T"!==t[e+5]||"Y"!==t[e+6]||"P"!==t[e+7]||"E"!==t[e+8])throw new Error("Invalid Tag instead of DOCTYPE");{e+=9;let s=1,n=!1,r=!1,o="";for(;e<t.length;e++)if("<"!==t[e]||r)if(">"===t[e]){if(r?"-"===t[e-1]&&"-"===t[e-2]&&(r=!1,s--):s--,0===s)break}else"["===t[e]?n=!0:o+=t[e];else n&&Fs(t,e)?(e+=7,[entityName,val,e]=Rs(t,e+1),-1===val.indexOf("&")&&(i[Hs(entityName)]={regx:RegExp(`&${entityName};`,"g"),val:val})):n&&Vs(t,e)||n&&Zs(t,e)?e+=8:n&&js(t,e)?e+=9:r=!0,s++,o="";if(0!==s)throw new Error("Unclosed DOCTYPE")}return{entities:i,i:e}},qs=function(t,e={}){if(e=Object.assign({},$s,e),!t||"string"!=typeof t)return t;let i=t.trim();if(void 0!==e.skipLike&&e.skipLike.test(i))return t;if("0"===t)return 0;if(e.hex&&Ys.test(i))return function(t,e){if(parseInt)return parseInt(t,e);if(Number.parseInt)return Number.parseInt(t,e);if(window&&window.parseInt)return window.parseInt(t,e);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(i,16);if(-1!==i.search(/[eE]/)){const s=i.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(s){if(e.leadingZeros)i=(s[1]||"")+s[3];else if("0"!==s[2]||"."!==s[3][0])return t;return e.eNotation?Number(i):t}return t}{const s=Ws.exec(i);if(s){const n=s[1],r=s[2];let o=function(t){if(t&&-1!==t.indexOf("."))return"."===(t=t.replace(/0+$/,""))?t="0":"."===t[0]?t="0"+t:"."===t[t.length-1]&&(t=t.substr(0,t.length-1)),t;return t}(s[3]);if(!e.leadingZeros&&r.length>0&&n&&"."!==i[2])return t;if(!e.leadingZeros&&r.length>0&&!n&&"."!==i[1])return t;if(e.leadingZeros&&r===t)return 0;{const s=Number(i),a=""+s;return-1!==a.search(/[eE]/)?e.eNotation?s:t:-1!==i.indexOf(".")?"0"===a&&""===o||a===o||n&&a==="-"+o?s:t:r?o===a||n+o===a?s:t:i===a||i===n+a?s:t}}return t}};function Ks(t){const e=Object.keys(t);for(let i=0;i<e.length;i++){const s=e[i];this.lastEntities[s]={regex:new RegExp("&"+s+";","g"),val:t[s]}}}function Js(t,e,i,s,n,r,o){if(void 0!==t&&(this.options.trimValues&&!s&&(t=t.trim()),t.length>0)){o||(t=this.replaceEntitiesValue(t));const s=this.options.tagValueProcessor(e,t,i,n,r);if(null==s)return t;if(typeof s!=typeof t||s!==t)return s;if(this.options.trimValues)return un(t,this.options.parseTagValue,this.options.numberParseOptions);return t.trim()===t?un(t,this.options.parseTagValue,this.options.numberParseOptions):t}}function tn(t){if(this.options.removeNSPrefix){const e=t.split(":"),i="/"===t.charAt(0)?"/":"";if("xmlns"===e[0])return"";2===e.length&&(t=i+e[1])}return t}const en=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function sn(t,e,i){if(!this.options.ignoreAttributes&&"string"==typeof t){const i=Xs.getAllMatches(t,en),s=i.length,n={};for(let t=0;t<s;t++){const s=this.resolveNameSpace(i[t][1]);let r=i[t][4],o=this.options.attributeNamePrefix+s;if(s.length)if(this.options.transformAttributeName&&(o=this.options.transformAttributeName(o)),"__proto__"===o&&(o="#__proto__"),void 0!==r){this.options.trimValues&&(r=r.trim()),r=this.replaceEntitiesValue(r);const t=this.options.attributeValueProcessor(s,r,e);n[o]=null==t?r:typeof t!=typeof r||t!==r?t:un(r,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(n[o]=!0)}if(!Object.keys(n).length)return;if(this.options.attributesGroupName){const t={};return t[this.options.attributesGroupName]=n,t}return n}}const nn=function(t){t=t.replace(/\r\n?/g,"\n");const e=new Gs("!xml");let i=e,s="",n="";for(let r=0;r<t.length;r++){if("<"===t[r])if("/"===t[r+1]){const e=ln(t,">",r,"Closing Tag is not closed.");let o=t.substring(r+2,e).trim();if(this.options.removeNSPrefix){const t=o.indexOf(":");-1!==t&&(o=o.substr(t+1))}this.options.transformTagName&&(o=this.options.transformTagName(o)),i&&(s=this.saveTextToParentTag(s,i,n));const a=n.substring(n.lastIndexOf(".")+1);if(o&&-1!==this.options.unpairedTags.indexOf(o))throw new Error(`Unpaired tag can not be used as closing tag: </${o}>`);let h=0;a&&-1!==this.options.unpairedTags.indexOf(a)?(h=n.lastIndexOf(".",n.lastIndexOf(".")-1),this.tagsNodeStack.pop()):h=n.lastIndexOf("."),n=n.substring(0,h),i=this.tagsNodeStack.pop(),s="",r=e}else if("?"===t[r+1]){let e=cn(t,r,!1,"?>");if(!e)throw new Error("Pi Tag is not closed.");if(s=this.saveTextToParentTag(s,i,n),this.options.ignoreDeclaration&&"?xml"===e.tagName||this.options.ignorePiTags);else{const t=new Gs(e.tagName);t.add(this.options.textNodeName,""),e.tagName!==e.tagExp&&e.attrExpPresent&&(t[":@"]=this.buildAttributesMap(e.tagExp,n,e.tagName)),this.addChild(i,t,n)}r=e.closeIndex+1}else if("!--"===t.substr(r+1,3)){const e=ln(t,"--\x3e",r+4,"Comment is not closed.");if(this.options.commentPropName){const o=t.substring(r+4,e-2);s=this.saveTextToParentTag(s,i,n),i.add(this.options.commentPropName,[{[this.options.textNodeName]:o}])}r=e}else if("!D"===t.substr(r+1,2)){const e=Qs(t,r);this.docTypeEntities=e.entities,r=e.i}else if("!["===t.substr(r+1,2)){const e=ln(t,"]]>",r,"CDATA is not closed.")-2,o=t.substring(r+9,e);s=this.saveTextToParentTag(s,i,n);let a=this.parseTextData(o,i.tagname,n,!0,!1,!0,!0);null==a&&(a=""),this.options.cdataPropName?i.add(this.options.cdataPropName,[{[this.options.textNodeName]:o}]):i.add(this.options.textNodeName,a),r=e+2}else{let o=cn(t,r,this.options.removeNSPrefix),a=o.tagName;const h=o.rawTagName;let l=o.tagExp,c=o.attrExpPresent,d=o.closeIndex;this.options.transformTagName&&(a=this.options.transformTagName(a)),i&&s&&"!xml"!==i.tagname&&(s=this.saveTextToParentTag(s,i,n,!1));const u=i;if(u&&-1!==this.options.unpairedTags.indexOf(u.tagname)&&(i=this.tagsNodeStack.pop(),n=n.substring(0,n.lastIndexOf("."))),a!==e.tagname&&(n+=n?"."+a:a),this.isItStopNode(this.options.stopNodes,n,a)){let e="";if(l.length>0&&l.lastIndexOf("/")===l.length-1)"/"===a[a.length-1]?(a=a.substr(0,a.length-1),n=n.substr(0,n.length-1),l=a):l=l.substr(0,l.length-1),r=o.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(a))r=o.closeIndex;else{const i=this.readStopNodeData(t,h,d+1);if(!i)throw new Error(`Unexpected end of ${h}`);r=i.i,e=i.tagContent}const s=new Gs(a);a!==l&&c&&(s[":@"]=this.buildAttributesMap(l,n,a)),e&&(e=this.parseTextData(e,a,n,!0,c,!0,!0)),n=n.substr(0,n.lastIndexOf(".")),s.add(this.options.textNodeName,e),this.addChild(i,s,n)}else{if(l.length>0&&l.lastIndexOf("/")===l.length-1){"/"===a[a.length-1]?(a=a.substr(0,a.length-1),n=n.substr(0,n.length-1),l=a):l=l.substr(0,l.length-1),this.options.transformTagName&&(a=this.options.transformTagName(a));const t=new Gs(a);a!==l&&c&&(t[":@"]=this.buildAttributesMap(l,n,a)),this.addChild(i,t,n),n=n.substr(0,n.lastIndexOf("."))}else{const t=new Gs(a);this.tagsNodeStack.push(i),a!==l&&c&&(t[":@"]=this.buildAttributesMap(l,n,a)),this.addChild(i,t,n),i=t}s="",r=d}}else s+=t[r]}return e.child};function rn(t,e,i){const s=this.options.updateTag(e.tagname,i,e[":@"]);!1===s||("string"==typeof s?(e.tagname=s,t.addChild(e)):t.addChild(e))}const on=function(t){if(this.options.processEntities){for(let e in this.docTypeEntities){const i=this.docTypeEntities[e];t=t.replace(i.regx,i.val)}for(let e in this.lastEntities){const i=this.lastEntities[e];t=t.replace(i.regex,i.val)}if(this.options.htmlEntities)for(let e in this.htmlEntities){const i=this.htmlEntities[e];t=t.replace(i.regex,i.val)}t=t.replace(this.ampEntity.regex,this.ampEntity.val)}return t};function an(t,e,i,s){return t&&(void 0===s&&(s=0===Object.keys(e.child).length),void 0!==(t=this.parseTextData(t,e.tagname,i,!1,!!e[":@"]&&0!==Object.keys(e[":@"]).length,s))&&""!==t&&e.add(this.options.textNodeName,t),t=""),t}function hn(t,e,i){const s="*."+i;for(const i in t){const n=t[i];if(s===n||e===n)return!0}return!1}function ln(t,e,i,s){const n=t.indexOf(e,i);if(-1===n)throw new Error(s);return n+e.length-1}function cn(t,e,i,s=">"){const n=function(t,e,i=">"){let s,n="";for(let r=e;r<t.length;r++){let e=t[r];if(s)e===s&&(s="");else if('"'===e||"'"===e)s=e;else if(e===i[0]){if(!i[1])return{data:n,index:r};if(t[r+1]===i[1])return{data:n,index:r}}else"\t"===e&&(e=" ");n+=e}}(t,e+1,s);if(!n)return;let r=n.data;const o=n.index,a=r.search(/\s/);let h=r,l=!0;-1!==a&&(h=r.substring(0,a),r=r.substring(a+1).trimStart());const c=h;if(i){const t=h.indexOf(":");-1!==t&&(h=h.substr(t+1),l=h!==n.data.substr(t+1))}return{tagName:h,tagExp:r,closeIndex:o,attrExpPresent:l,rawTagName:c}}function dn(t,e,i){const s=i;let n=1;for(;i<t.length;i++)if("<"===t[i])if("/"===t[i+1]){const r=ln(t,">",i,`${e} is not closed`);if(t.substring(i+2,r).trim()===e&&(n--,0===n))return{tagContent:t.substring(s,i),i:r};i=r}else if("?"===t[i+1]){i=ln(t,"?>",i+1,"StopNode is not closed.")}else if("!--"===t.substr(i+1,3)){i=ln(t,"--\x3e",i+3,"StopNode is not closed.")}else if("!["===t.substr(i+1,2)){i=ln(t,"]]>",i,"StopNode is not closed.")-2}else{const s=cn(t,i,">");if(s){(s&&s.tagName)===e&&"/"!==s.tagExp[s.tagExp.length-1]&&n++,i=s.closeIndex}}}function un(t,e,i){if(e&&"string"==typeof t){const e=t.trim();return"true"===e||"false"!==e&&qs(t,i)}return Xs.isExist(t)?t:""}var pn=class{constructor(t){this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(t,e)=>String.fromCharCode(Number.parseInt(e,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(t,e)=>String.fromCharCode(Number.parseInt(e,16))}},this.addExternalEntities=Ks,this.parseXml=nn,this.parseTextData=Js,this.resolveNameSpace=tn,this.buildAttributesMap=sn,this.isItStopNode=hn,this.replaceEntitiesValue=on,this.readStopNodeData=dn,this.saveTextToParentTag=an,this.addChild=rn}},fn={};function mn(t,e,i){let s;const n={};for(let r=0;r<t.length;r++){const o=t[r],a=gn(o);let h="";if(h=void 0===i?a:i+"."+a,a===e.textNodeName)void 0===s?s=o[a]:s+=""+o[a];else{if(void 0===a)continue;if(o[a]){let t=mn(o[a],e,h);const i=yn(t,e);o[":@"]?_n(t,o[":@"],h,e):1!==Object.keys(t).length||void 0===t[e.textNodeName]||e.alwaysCreateTextNode?0===Object.keys(t).length&&(e.alwaysCreateTextNode?t[e.textNodeName]="":t=""):t=t[e.textNodeName],void 0!==n[a]&&n.hasOwnProperty(a)?(Array.isArray(n[a])||(n[a]=[n[a]]),n[a].push(t)):e.isArray(a,h,i)?n[a]=[t]:n[a]=t}}}return"string"==typeof s?s.length>0&&(n[e.textNodeName]=s):void 0!==s&&(n[e.textNodeName]=s),n}function gn(t){const e=Object.keys(t);for(let t=0;t<e.length;t++){const i=e[t];if(":@"!==i)return i}}function _n(t,e,i,s){if(e){const n=Object.keys(e),r=n.length;for(let o=0;o<r;o++){const r=n[o];s.isArray(r,i+"."+r,!0,!0)?t[r]=[e[r]]:t[r]=e[r]}}}function yn(t,e){const{textNodeName:i}=e,s=Object.keys(t).length;return 0===s||!(1!==s||!t[i]&&"boolean"!=typeof t[i]&&0!==t[i])}fn.prettify=function(t,e){return mn(t,e)};const{buildOptions:wn}=Us,vn=pn,{prettify:bn}=fn,xn=ws;var Tn=class{constructor(t){this.externalEntities={},this.options=wn(t)}parse(t,e){if("string"==typeof t);else{if(!t.toString)throw new Error("XML data is accepted in String or Bytes[] form.");t=t.toString()}if(e){!0===e&&(e={});const i=xn.validate(t,e);if(!0!==i)throw Error(`${i.err.msg}:${i.err.line}:${i.err.col}`)}const i=new vn(this.options);i.addExternalEntities(this.externalEntities);const s=i.parseXml(t);return this.options.preserveOrder||void 0===s?s:bn(s,this.options)}addEntity(t,e){if(-1!==e.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==t.indexOf("&")||-1!==t.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===e)throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=e}};function En(t,e,i,s){let n="",r=!1;for(let o=0;o<t.length;o++){const a=t[o],h=Cn(a);if(void 0===h)continue;let l="";if(l=0===i.length?h:`${i}.${h}`,h===e.textNodeName){let t=a[h];An(l,e)||(t=e.tagValueProcessor(h,t),t=Sn(t,e)),r&&(n+=s),n+=t,r=!1;continue}if(h===e.cdataPropName){r&&(n+=s),n+=`<![CDATA[${a[h][0][e.textNodeName]}]]>`,r=!1;continue}if(h===e.commentPropName){n+=s+`\x3c!--${a[h][0][e.textNodeName]}--\x3e`,r=!0;continue}if("?"===h[0]){const t=On(a[":@"],e),i="?xml"===h?"":s;let o=a[h][0][e.textNodeName];o=0!==o.length?" "+o:"",n+=i+`<${h}${o}${t}?>`,r=!0;continue}let c=s;""!==c&&(c+=e.indentBy);const d=s+`<${h}${On(a[":@"],e)}`,u=En(a[h],e,l,c);-1!==e.unpairedTags.indexOf(h)?e.suppressUnpairedNode?n+=d+">":n+=d+"/>":u&&0!==u.length||!e.suppressEmptyNode?u&&u.endsWith(">")?n+=d+`>${u}${s}</${h}>`:(n+=d+">",u&&""!==s&&(u.includes("/>")||u.includes("</"))?n+=s+e.indentBy+u+s:n+=u,n+=`</${h}>`):n+=d+"/>",r=!0}return n}function Cn(t){const e=Object.keys(t);for(let i=0;i<e.length;i++){const s=e[i];if(t.hasOwnProperty(s)&&":@"!==s)return s}}function On(t,e){let i="";if(t&&!e.ignoreAttributes)for(let s in t){if(!t.hasOwnProperty(s))continue;let n=e.attributeValueProcessor(s,t[s]);n=Sn(n,e),!0===n&&e.suppressBooleanAttributes?i+=` ${s.substr(e.attributeNamePrefix.length)}`:i+=` ${s.substr(e.attributeNamePrefix.length)}="${n}"`}return i}function An(t,e){let i=(t=t.substr(0,t.length-e.textNodeName.length-1)).substr(t.lastIndexOf(".")+1);for(let s in e.stopNodes)if(e.stopNodes[s]===t||e.stopNodes[s]==="*."+i)return!0;return!1}function Sn(t,e){if(t&&t.length>0&&e.processEntities)for(let i=0;i<e.entities.length;i++){const s=e.entities[i];t=t.replace(s.regex,s.val)}return t}const Pn=function(t,e){let i="";return e.format&&e.indentBy.length>0&&(i="\n"),En(t,e,"",i)},kn={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(t,e){return e},attributeValueProcessor:function(t,e){return e},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function zn(t){this.options=Object.assign({},kn,t),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=Dn),this.processTextOrObjNode=Mn,this.options.format?(this.indentate=Bn,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function Mn(t,e,i){const s=this.j2x(t,i+1);return void 0!==t[this.options.textNodeName]&&1===Object.keys(t).length?this.buildTextValNode(t[this.options.textNodeName],e,s.attrStr,i):this.buildObjectNode(s.val,e,s.attrStr,i)}function Bn(t){return this.options.indentBy.repeat(t)}function Dn(t){return!(!t.startsWith(this.options.attributeNamePrefix)||t===this.options.textNodeName)&&t.substr(this.attrPrefixLen)}zn.prototype.build=function(t){return this.options.preserveOrder?Pn(t,this.options):(Array.isArray(t)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(t={[this.options.arrayNodeName]:t}),this.j2x(t,0).val)},zn.prototype.j2x=function(t,e){let i="",s="";for(let n in t)if(Object.prototype.hasOwnProperty.call(t,n))if(void 0===t[n])this.isAttribute(n)&&(s+="");else if(null===t[n])this.isAttribute(n)?s+="":"?"===n[0]?s+=this.indentate(e)+"<"+n+"?"+this.tagEndChar:s+=this.indentate(e)+"<"+n+"/"+this.tagEndChar;else if(t[n]instanceof Date)s+=this.buildTextValNode(t[n],n,"",e);else if("object"!=typeof t[n]){const r=this.isAttribute(n);if(r)i+=this.buildAttrPairStr(r,""+t[n]);else if(n===this.options.textNodeName){let e=this.options.tagValueProcessor(n,""+t[n]);s+=this.replaceEntitiesValue(e)}else s+=this.buildTextValNode(t[n],n,"",e)}else if(Array.isArray(t[n])){const i=t[n].length;let r="",o="";for(let a=0;a<i;a++){const i=t[n][a];if(void 0===i);else if(null===i)"?"===n[0]?s+=this.indentate(e)+"<"+n+"?"+this.tagEndChar:s+=this.indentate(e)+"<"+n+"/"+this.tagEndChar;else if("object"==typeof i)if(this.options.oneListGroup){const t=this.j2x(i,e+1);r+=t.val,this.options.attributesGroupName&&i.hasOwnProperty(this.options.attributesGroupName)&&(o+=t.attrStr)}else r+=this.processTextOrObjNode(i,n,e);else if(this.options.oneListGroup){let t=this.options.tagValueProcessor(n,i);t=this.replaceEntitiesValue(t),r+=t}else r+=this.buildTextValNode(i,n,"",e)}this.options.oneListGroup&&(r=this.buildObjectNode(r,n,o,e)),s+=r}else if(this.options.attributesGroupName&&n===this.options.attributesGroupName){const e=Object.keys(t[n]),s=e.length;for(let r=0;r<s;r++)i+=this.buildAttrPairStr(e[r],""+t[n][e[r]])}else s+=this.processTextOrObjNode(t[n],n,e);return{attrStr:i,val:s}},zn.prototype.buildAttrPairStr=function(t,e){return e=this.options.attributeValueProcessor(t,""+e),e=this.replaceEntitiesValue(e),this.options.suppressBooleanAttributes&&"true"===e?" "+t:" "+t+'="'+e+'"'},zn.prototype.buildObjectNode=function(t,e,i,s){if(""===t)return"?"===e[0]?this.indentate(s)+"<"+e+i+"?"+this.tagEndChar:this.indentate(s)+"<"+e+i+this.closeTag(e)+this.tagEndChar;{let n="</"+e+this.tagEndChar,r="";return"?"===e[0]&&(r="?",n=""),!i&&""!==i||-1!==t.indexOf("<")?!1!==this.options.commentPropName&&e===this.options.commentPropName&&0===r.length?this.indentate(s)+`\x3c!--${t}--\x3e`+this.newLine:this.indentate(s)+"<"+e+i+r+this.tagEndChar+t+this.indentate(s)+n:this.indentate(s)+"<"+e+i+r+">"+t+n}},zn.prototype.closeTag=function(t){let e="";return-1!==this.options.unpairedTags.indexOf(t)?this.options.suppressUnpairedNode||(e="/"):e=this.options.suppressEmptyNode?"/":`></${t}`,e},zn.prototype.buildTextValNode=function(t,e,i,s){if(!1!==this.options.cdataPropName&&e===this.options.cdataPropName)return this.indentate(s)+`<![CDATA[${t}]]>`+this.newLine;if(!1!==this.options.commentPropName&&e===this.options.commentPropName)return this.indentate(s)+`\x3c!--${t}--\x3e`+this.newLine;if("?"===e[0])return this.indentate(s)+"<"+e+i+"?"+this.tagEndChar;{let n=this.options.tagValueProcessor(e,t);return n=this.replaceEntitiesValue(n),""===n?this.indentate(s)+"<"+e+i+this.closeTag(e)+this.tagEndChar:this.indentate(s)+"<"+e+i+">"+n+"</"+e+this.tagEndChar}},zn.prototype.replaceEntitiesValue=function(t){if(t&&t.length>0&&this.options.processEntities)for(let e=0;e<this.options.entities.length;e++){const i=this.options.entities[e];t=t.replace(i.regex,i.val)}return t};var In={XMLParser:Tn,XMLValidator:ws,XMLBuilder:zn};class Un{constructor(t,i){e(this,"date",new Date),e(this,"author"),e(this,"guid",w.create()),e(this,"viewpoint"),e(this,"modifiedAuthor"),e(this,"modifiedDate"),e(this,"topic"),e(this,"_components"),e(this,"_comment",""),this._components=t,this._comment=i;const s=this._components.get(Zn);this.author=s.config.author}set comment(t){var e;const i=this._components.get(Zn);this._comment=t,this.modifiedDate=new Date,this.modifiedAuthor=i.config.author,null==(e=this.topic)||e.comments.set(this.guid,this)}get comment(){return this._comment}serialize(){let t=null;this.viewpoint&&(t=`<Viewpoint Guid="${this.viewpoint.guid}"/>`);let e=null;this.modifiedDate&&(e=`<ModifiedDate>${this.modifiedDate.toISOString()}</ModifiedDate>`);let i=null;return this.modifiedAuthor&&(i=`<ModifiedAuthor>${this.modifiedAuthor}</ModifiedAuthor>`),`\n      <Comment Guid="${this.guid}">\n        <Date>${this.date.toISOString()}</Date>\n        <Author>${this.author}</Author>\n        <Comment>${this.comment}</Comment>\n        ${t??""}\n        ${i??""}\n        ${e??""}\n      </Comment>\n    `}}const Nn=class t{constructor(i){e(this,"guid",w.create()),e(this,"title",t.default.title),e(this,"creationDate",new Date),e(this,"creationAuthor",""),e(this,"viewpoints",new m),e(this,"relatedTopics",new m),e(this,"comments",new g),e(this,"customData",{}),e(this,"description"),e(this,"serverAssignedId"),e(this,"dueDate"),e(this,"modifiedAuthor"),e(this,"modifiedDate"),e(this,"index"),e(this,"_type",t.default.type),e(this,"_status",t.default.status),e(this,"_priority",t.default.priority),e(this,"_stage",t.default.stage),e(this,"_assignedTo",t.default.assignedTo),e(this,"_labels",t.default.labels??new Set),e(this,"_components"),this._components=i;const s=i.get(Zn);this.creationAuthor=s.config.author,this.relatedTopics.guard=t=>t!==this.guid}set type(t){const e=this._components.get(Zn),{strict:i,types:s}=e.config;(!i||s.has(t))&&(this._type=t)}get type(){return this._type}set status(t){const e=this._components.get(Zn),{strict:i,statuses:s}=e.config;(!i||s.has(t))&&(this._status=t)}get status(){return this._status}set priority(t){const e=this._components.get(Zn);if(t){const{strict:i,priorities:s}=e.config;if(!(!i||s.has(t)))return;this._priority=t}else this._priority=t}get priority(){return this._priority}set stage(t){const e=this._components.get(Zn);if(t){const{strict:i,stages:s}=e.config;if(!(!i||s.has(t)))return;this._stage=t}else this._stage=t}get stage(){return this._stage}set assignedTo(t){const e=this._components.get(Zn);if(t){const{strict:i,users:s}=e.config;if(!(!i||s.has(t)))return;this._assignedTo=t}else this._assignedTo=t}get assignedTo(){return this._assignedTo}set labels(t){const e=this._components.get(Zn),{strict:i,labels:s}=e.config;if(i){const e=new Set;for(const n of t){(!i||s.has(n))&&e.add(n)}this._labels=e}else this._labels=t}get labels(){return this._labels}get _managerVersion(){return this._components.get(Zn).config.version}set(t){const e=t,i=this;for(const s in t){if("guid"===s)continue;const t=e[s];s in this&&(i[s]=t)}return this._components.get(Zn).list.set(this.guid,this),this}createComment(t,e){const i=new Un(this._components,t);return i.viewpoint=e,i.topic=this,this.comments.set(i.guid,i),i}createLabelTags(t=this._managerVersion){let e="Labels";"2.1"===t&&(e="Labels"),"3"===t&&(e="Label");let i=[...this.labels].map((t=>`<${e}>${t}</${e}>`)).join("\n");if(this._components.get(Zn).config.exportCustomDataAsLabels)for(const t in this.customData){const s=this.customData[t];"string"==typeof s&&(i+=`\n<${e}>${s}</${e}>`)}return"2.1"===t?i:"3"===t?0!==i.length?`<Labels>\n${i}\n</Labels>`:"<Labels/>":i}createCommentTags(t=this._managerVersion){const e=[...this.comments.values()].map((t=>t.serialize())).join("\n");return"2.1"===t?e:"3"===t?0!==e.length?`<Comments>\n${e}\n</Comments>`:"<Comments/>":e}createViewpointTags(t=this._managerVersion){let e="Viewpoints";"2.1"===t&&(e="Viewpoints"),"3"===t&&(e="ViewPoint");const i=this._components.get(Wn),s=[...this.viewpoints].map((t=>i.list.get(t))).filter((t=>t)).map((t=>`<${e} Guid="${t.guid}">\n          <Viewpoint>${t.guid}.bcfv</Viewpoint>\n          <Snapshot>${t.snapshot}.jpeg</Snapshot>\n        </${e}>\n      `)).join("\n");return"2.1"===t?s:"3"===t?0!==s.length?`<Viewpoints>\n${s}\n</Viewpoints>`:"<Viewpoints />":s}createRelatedTopicTags(t=this._managerVersion){const e=[...this.relatedTopics].map((t=>`<RelatedTopic Guid="${t}"></RelatedTopic>\n      `)).join("\n");return"2.1"===t?e:"3"===t?0!==e.length?`<RelatedTopics>\n${e}\n</RelatedTopics>`:"<RelatedTopics />":e}serialize(){const t=this._managerVersion;let e=null;this.serverAssignedId&&(e=`ServerAssignedId="${this.serverAssignedId}"`);let i=null;this.priority&&(i=`<Priority>${this.priority}</Priority>`);let s=null;this.index&&"2.1"===t&&(s=`<Index>${this.index}</Index>`);let n=null;this.modifiedDate&&(n=`<ModifiedDate>${this.modifiedDate.toISOString()}</ModifiedDate>`);let r=null;this.modifiedAuthor&&(r=`<ModifiedAuthor>${this.modifiedAuthor}</ModifiedAuthor>`);let o=null;this.dueDate&&(o=`<DueDate>${this.dueDate.toISOString()}</DueDate>`);let a=null;this.assignedTo&&(a=`<AssignedTo>${this.assignedTo}</AssignedTo>`);let h=null;this.description&&(h=`<Description>${this.description}</Description>`);let l=null;this.stage&&(l=`<Stage>${this.stage}</Stage>`);const c=this.createCommentTags(t),d=this.createViewpointTags(t),u=this.createLabelTags(t),p=this.createRelatedTopicTags(t);return`\n      <?xml version="1.0" encoding="UTF-8"?>\n      <Markup>\n        <Topic Guid="${this.guid}" TopicType="${this.type}" TopicStatus="${this.status}" ${e??""}>\n          <Title>${this.title}</Title>\n          <CreationDate>${this.creationDate.toISOString()}</CreationDate>\n          <CreationAuthor>${this.creationAuthor}</CreationAuthor>\n          ${i??""}\n          ${s??""}\n          ${n??""}\n          ${r??""}\n          ${o??""}\n          ${a??""}\n          ${h??""}\n          ${l??""}\n          ${u}\n          ${p}\n          ${"3"===t?c:""}\n          ${"3"===t?d:""}\n        </Topic>\n        ${"2.1"===t?c:""}\n        ${"2.1"===t?d:""}\n      </Markup>\n    `}};e(Nn,"default",{title:"BCF Topic",type:"Issue",status:"Active"});let Ln=Nn;const Rn=(t,e)=>{if(""===e.trim())return;const i=Zn.xmlParser.parse(e).Extensions;if(!i)return;const{Priorities:s,TopicStatuses:n,TopicTypes:r,Users:o}=i;if(s&&s.Priority){const e=Array.isArray(s.Priority)?s.Priority:[s.Priority];for(const i of e)t.config.priorities.add(i)}if(n&&n.TopicStatus){const e=Array.isArray(n.TopicStatus)?n.TopicStatus:[n.TopicStatus];for(const i of e)t.config.statuses.add(i)}if(r&&r.TopicType){const e=Array.isArray(r.TopicType)?r.TopicType:[r.TopicType];for(const i of e)t.config.types.add(i)}if(o&&o.User){const e=Array.isArray(o.User)?o.User:[o.User];for(const i of e)t.config.users.add(i)}};class Fn extends v{constructor(){super(...arguments),e(this,"_config",{version:{type:"Select",options:new Set(["2.1","3"]),multiple:!1,value:""},author:{type:"Text",value:""},types:{type:"TextSet",value:new Set},statuses:{type:"TextSet",value:new Set},priorities:{type:"TextSet",value:new Set},labels:{type:"TextSet",value:new Set},stages:{type:"TextSet",value:new Set},users:{type:"TextSet",value:new Set},includeSelectionTag:{type:"Boolean",value:!1},updateExtensionsOnImport:{type:"Boolean",value:!1},strict:{type:"Boolean",value:!1},includeAllExtensionsOnExport:{type:"Boolean",value:!1},fallbackVersionOnImport:{type:"Select",multiple:!1,options:new Set(["2.1","3"]),value:""},ignoreIncompleteTopicsOnImport:{type:"Boolean",value:!1},exportCustomDataAsLabels:{type:"Boolean",value:!1}})}get version(){return this._config.version.value}set version(t){this._config.version.value=t}get author(){return this._config.author.value}set author(t){this._config.author.value=t}get types(){return this._config.types.value}set types(t){this._config.types.value=t}get statuses(){return this._config.statuses.value}set statuses(t){this._config.statuses.value=t}get priorities(){return this._config.priorities.value}set priorities(t){this._config.priorities.value=t}get labels(){return this._config.labels.value}set labels(t){this._config.labels.value=t}get stages(){return this._config.stages.value}set stages(t){this._config.stages.value=t}get users(){return this._config.users.value}set users(t){this._config.users.value=t}get includeSelectionTag(){return this._config.includeSelectionTag.value}set includeSelectionTag(t){this._config.includeSelectionTag.value=t}get updateExtensionsOnImport(){return this._config.updateExtensionsOnImport.value}set updateExtensionsOnImport(t){this._config.updateExtensionsOnImport.value=t}get strict(){return this._config.strict.value}set strict(t){this._config.strict.value=t}get includeAllExtensionsOnExport(){return this._config.includeAllExtensionsOnExport.value}set includeAllExtensionsOnExport(t){this._config.includeAllExtensionsOnExport.value=t}get fallbackVersionOnImport(){return this._config.fallbackVersionOnImport.value}set fallbackVersionOnImport(t){this._config.fallbackVersionOnImport.value=t}get ignoreIncompleteTopicsOnImport(){return this._config.ignoreIncompleteTopicsOnImport.value}set ignoreIncompleteTopicsOnImport(t){this._config.ignoreIncompleteTopicsOnImport.value=t}get exportCustomDataAsLabels(){return this._config.exportCustomDataAsLabels.value}set exportCustomDataAsLabels(t){this._config.exportCustomDataAsLabels.value=t}}const Vn=class t extends h{constructor(){super(...arguments),e(this,"enabled",!1),e(this,"_defaultConfig",{author:"jhon.doe@example.com",version:"2.1",types:new Set(["Clash","Failure","Fault","Inquiry","Issue","Remark","Request"]),statuses:new Set(["Active","In Progress","Done","In Review","Closed"]),priorities:new Set(["On hold","Minor","Normal","Major","Critical"]),labels:new Set,stages:new Set,users:new Set,includeSelectionTag:!1,updateExtensionsOnImport:!0,strict:!1,includeAllExtensionsOnExport:!0,fallbackVersionOnImport:"2.1",ignoreIncompleteTopicsOnImport:!1,exportCustomDataAsLabels:!1}),e(this,"config",new Fn(this,this.components,"BCF Topics",t.uuid)),e(this,"list",new g),e(this,"onSetup",new o),e(this,"isSetup",!1),e(this,"onBCFImported",new o),e(this,"onDisposed",new o)}setup(t){if(this.isSetup)return;const e={...this._defaultConfig,...t};this.config.version=e.version,this.config.author=e.author,this.config.types=e.types,this.config.statuses=e.statuses,this.config.priorities=e.priorities,this.config.labels=e.labels,this.config.stages=e.stages,this.config.users=e.users,this.config.includeSelectionTag=e.includeSelectionTag,this.config.updateExtensionsOnImport=e.updateExtensionsOnImport,this.config.strict=e.strict,this.config.includeAllExtensionsOnExport=e.includeAllExtensionsOnExport,this.config.fallbackVersionOnImport=e.fallbackVersionOnImport||"",this.config.ignoreIncompleteTopicsOnImport=e.ignoreIncompleteTopicsOnImport,this.isSetup=!0,this.enabled=!0,this.onSetup.trigger()}create(t){const e=new Ln(this.components);return t?(e.guid=t.guid??e.guid,e.set(t)):this.list.set(e.guid,e),e}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}get usedTypes(){const t=[...this.list].map((([t,e])=>e.type));return new Set(t)}get usedStatuses(){const t=[...this.list].map((([t,e])=>e.status));return new Set(t)}get usedPriorities(){const t=[...this.list].map((([t,e])=>e.priority)).filter((t=>t));return new Set(t)}get usedStages(){const t=[...this.list].map((([t,e])=>e.stage)).filter((t=>t));return new Set(t)}get usedUsers(){const t=[];for(const[e,i]of this.list){t.push(i.creationAuthor),i.assignedTo&&t.push(i.assignedTo),i.modifiedAuthor&&t.push(i.modifiedAuthor);for(const[e,s]of i.comments)t.push(s.author),s.modifiedAuthor&&t.push(s.modifiedAuthor)}return new Set(t)}get usedLabels(){const t=[];for(const[e,i]of this.list)t.push(...i.labels);return new Set(t)}updateExtensions(){for(const[t,e]of this.list){for(const t of e.labels)this.config.labels.add(t);this.config.types.add(e.type),e.priority&&this.config.priorities.add(e.priority),e.stage&&this.config.stages.add(e.stage),this.config.statuses.add(e.status),this.config.users.add(e.creationAuthor),e.assignedTo&&this.config.users.add(e.assignedTo),e.modifiedAuthor&&this.config.users.add(e.modifiedAuthor);for(const[t,i]of e.comments)this.config.users.add(i.author),i.modifiedAuthor&&this.config.users.add(i.modifiedAuthor)}}updateViewpointReferences(){const t=this.components.get(Wn);for(const[e,i]of this.list)for(const e of i.viewpoints){t.list.has(e)||i.viewpoints.delete(e)}}async export(t=this.list.values()){const e=new ys;e.file("bcf.version",`<?xml version="1.0" encoding="UTF-8"?>\n    <Version VersionId="${this.config.version}" xsi:noNamespaceSchemaLocation="https://raw.githubusercontent.com/buildingSMART/BCF-XML/release_3_0/Schemas/version.xsd"\n    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\n    </Version>`),e.file("bcf.extensions",this.serializeExtensions());const i=await fetch("https://thatopen.github.io/engine_components/resources/favicon.ico"),s=await i.arrayBuffer(),n=this.components.get(Wn);for(const i of t){const t=e.folder(i.guid);t.file("markup.bcf",i.serialize());for(const e of i.viewpoints){const i=n.list.get(e);if(!i)continue;const r=n.snapshots.get(i.snapshot),o=r?i.snapshot:i.guid,a=r??s,h=i.title??i.guid;t.file(`${o}.jpeg`,a,{binary:!0}),t.file(`${h}.bcfv`,await i.serialize())}}return await e.generateAsync({type:"blob"})}serializeExtensions(){const t=[...this.config.types].map((t=>`<TopicType>${t}</TopicType>`)).join("\n"),e=[...this.config.statuses].map((t=>`<TopicStatus>${t}</TopicStatus>`)).join("\n"),i=[...this.config.priorities].map((t=>`<Priority>${t}</Priority>`)).join("\n"),s=[...this.config.labels].map((t=>`<TopicLabel>${t}</TopicLabel>`)).join("\n"),n=[...this.config.stages].map((t=>`<Stage>${t}</Stage>`)).join("\n"),r=[...this.config.users].map((t=>`<User>${t}</User>`)).join("\n");return`\n      <?xml version="1.0" encoding="UTF-8"?>\n      <Extensions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="your-schema-location.xsd">\n        ${0!==t.length?`<TopicTypes>\n${t}\n</TopicTypes>`:""}\n        ${0!==e.length?`<TopicStatuses>\n${e}\n</TopicStatuses>`:""}\n        ${0!==i.length?`<Priorities>\n${i}\n</Priorities>`:""}\n        ${0!==s.length?`<TopicLabels>\n${s}\n</TopicLabels>`:""}\n        ${0!==n.length?`<Stages>\n${n}\n</Stages>`:""}\n        ${0!==r.length?`<Users>\n${r}\n</Users>`:""}\n      </Extensions>\n    `}processMarkupComment(t){const{Guid:e,Date:i,Author:s,Comment:n,Viewpoint:r}=t;if(!(e&&i&&s&&Un))return null;const o=this.components.get(Wn),a=new Un(this.components,n??"");return a.guid=e,a.date=new Date(i),a.author=s,a.viewpoint=(null==r?void 0:r.Guid)?o.list.get(r.Guid):void 0,a.modifiedAuthor=t.ModifiedAuthor,a.modifiedDate=t.ModifiedDate?new Date(t.ModifiedDate):void 0,a}getMarkupComments(t,e){var i;let s;if("2.1"===e&&(s=t.Comment),"3"===e&&(s=null==(i=t.Topic.Comments)?void 0:i.Comment),!s)return[];s=Array.isArray(s)?s:[s];const n=s.map((t=>this.processMarkupComment(t))).filter((t=>t));return Array.isArray(n)?n:[n]}getMarkupLabels(t,e){var i;let s;if("2.1"===e&&(s=t.Topic.Labels),"3"===e&&(s=null==(i=t.Topic.Labels)?void 0:i.Label),!s)return[];return Array.isArray(s)?s:[s]}getMarkupViewpoints(t,e){var i;let s;return"2.1"===e&&(s=t.Viewpoints),"3"===e&&(s=null==(i=t.Topic.Viewpoints)?void 0:i.ViewPoint),s?(s=Array.isArray(s)?s:[s],s):[]}getMarkupRelatedTopics(t,e){var i;let s;if("2.1"===e&&(s=t.Topic.RelatedTopic),"3"===e&&(s=null==(i=t.Topic.RelatedTopics)?void 0:i.RelatedTopic),!s)return[];return(Array.isArray(s)?s:[s]).map((t=>t.Guid))}async load(e){var i;const{fallbackVersionOnImport:s,ignoreIncompleteTopicsOnImport:n,updateExtensionsOnImport:o}=this.config,a=new ys;await a.loadAsync(e);const h=Object.values(a.files);let l=s;const c=h.find((t=>t.name.endsWith(".version")));if(c){const e=await c.async("string"),i=t.xmlParser.parse(e).Version.VersionId;l=String(i)}if(!l||"2.1"!==l&&"3"!==l)throw new Error(`BCFTopics: ${l} is not supported.`);const d=h.find((t=>t.name.endsWith(".extensions")));if(o&&d){const t=await d.async("string");Rn(this,t)}const u=[],p=this.components.get(Wn),f=h.filter((t=>t.name.endsWith(".bcfv")));for(const e of f){const s=await e.async("string"),n=t.xmlParser.parse(s).VisualizationInfo;if(!n){console.warn("Missing VisualizationInfo in Viewpoint");continue}const o={},{Guid:a,Components:h,OrthogonalCamera:c,PerspectiveCamera:d}=n;if(a&&(o.guid=a),h){const{Selection:t,Visibility:e}=h;if(t&&t.Component){const e=Array.isArray(t.Component)?t.Component:[t.Component];o.selectionComponents=e.map((t=>t.IfcGuid)).filter((t=>t))}if(e&&"DefaultVisibility"in e&&(o.defaultVisibility=e.DefaultVisibility),e&&e.Exceptions&&"Component"in e.Exceptions){const{Component:t}=e.Exceptions,i=Array.isArray(t)?t:[t];o.exceptionComponents=i.map((t=>t.IfcGuid)).filter((t=>t))}let s;"2.1"===l&&(s=h.ViewSetupHints),"3"===l&&(s=null==(i=h.Visibility)?void 0:i.ViewSetupHints),s&&("OpeningsVisible"in s&&(o.openingsVisible=s.OpeningsVisible),"SpacesVisible"in s&&(o.spacesVisible=s.SpacesVisible),"SpaceBoundariesVisible"in s&&(o.spaceBoundariesVisible=s.SpaceBoundariesVisible))}if(c||d){const t=n.PerspectiveCamera??n.OrthogonalCamera,{CameraViewPoint:e,CameraDirection:i}=t,s=new r.Vector3(Number(e.X),Number(e.Z),Number(-e.Y)),a=new r.Vector3(Number(i.X),Number(i.Z),Number(-i.Y)),h={position:{x:s.x,y:s.y,z:s.z},direction:{x:a.x,y:a.y,z:a.z},aspectRatio:"AspectRatio"in t?t.AspectRatio:1};"ViewToWorldScale"in t&&(o.camera={...h,viewToWorldScale:t.ViewToWorldScale}),"FieldOfView"in t&&(o.camera={...h,fov:t.FieldOfView})}const p=new jn(this.components,o);if(h){const{Coloring:t}=h;if(t&&t.Color){const e=Array.isArray(t.Color)?t.Color:[t.Color];for(const t of e){const{Color:e,Component:i}=t;if(6!==e.length&&8!==e.length)continue;const s=6===e.length?e:e.slice(2),n=(Array.isArray(i)?i:[i]).map((t=>t.IfcGuid));p.componentColors.set(s,n)}}}u.push(p)}const m=t=>{const e=t.split("/"),i=e[e.length-1].split(".");return i.pop(),i.join(".")},g=h.filter((t=>t.name.endsWith(".png")||t.name.endsWith(".jpeg")));for(const t of g){const e=m(t.name),i=await t.async("arraybuffer");p.snapshots.set(e,i)}const _={},y=[],w=h.filter((t=>t.name.endsWith(".bcf")));for(const e of w){const i=await e.async("string"),s=t.xmlParser.parse(i).Markup,r=s.Topic,{Guid:o,TopicType:a,TopicStatus:h,Title:c,CreationDate:d,CreationAuthor:u}=r;if(n&&!(o&&a&&h&&c&&d&&u))continue;const f=new Ln(this.components);f.guid=o??f.guid;const g=this.getMarkupRelatedTopics(s,l);_[f.guid]=new Set(g),f.type=a??f.type,f.status=h??f.status,f.title=c??f.title,f.creationDate=d?new Date(d):f.creationDate,f.creationAuthor=u??f.creationAuthor,f.serverAssignedId=r.ServerAssignedId,f.priority=r.Priority,f.index=r.Index,f.modifiedDate=r.ModifiedDate?new Date(r.ModifiedDate):void 0,f.modifiedAuthor=r.ModifiedAuthor,f.dueDate=r.DueDate?new Date(r.DueDate):void 0,f.assignedTo=r.AssignedTo,f.description=r.Description,f.stage=r.Stage;const w=this.getMarkupLabels(s,l);for(const t of w)f.labels.add(t);const v=this.getMarkupComments(s,l);for(const t of v)f.comments.set(t.guid,t);const b=this.getMarkupViewpoints(s,l);for(const t of b){if(!t||!t.Guid)continue;const e=p.list.get(t.Guid);if(e){f.viewpoints.add(e.guid);const i=m(t.Snapshot);e.snapshot=i??null}}this.list.set(f.guid,f),y.push(f)}for(const t in _){const e=this.list.get(t);if(!e)continue;const i=_[t];for(const t of i)e.relatedTopics.add(t)}return this.onBCFImported.trigger(y),{viewpoints:u,topics:y}}};e(Vn,"uuid","de977976-e4f6-4e4f-a01a-204727839802"),e(Vn,"xmlParser",new In.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));let Zn=Vn;class jn{constructor(t,i){e(this,"title"),e(this,"guid",w.create()),e(this,"camera",{aspectRatio:1,fov:60,direction:{x:0,y:0,z:0},position:{x:0,y:0,z:0}}),e(this,"exceptionComponents",new m),e(this,"selectionComponents",new m),e(this,"componentColors",new g),e(this,"spacesVisible",!1),e(this,"spaceBoundariesVisible",!1),e(this,"openingsVisible",!1),e(this,"defaultVisibility",!0),e(this,"snapshot",this.guid),e(this,"_components"),e(this,"_world",null),this._components=t,i&&(this.guid=i.guid??this.guid,this.set(i))}async getSelectionMap(){const t=this._components.get(rs),e={};for(const i of this.selectionComponents)for(const[s,n]of t.list){const t=n.getItem(i),r=await(null==t?void 0:t.getLocalId());if(r){s in e||(e[s]=new Set),e[s].add(r);break}}return e}async getExceptionMap(){const t=this._components.get(rs),e={};for(const i of this.exceptionComponents)for(const[s,n]of t.list){const t=n.getItem(i),r=await(null==t?void 0:t.getLocalId());if(r){s in e||(e[s]=new Set),e[s].add(r);break}}return e}get projection(){return"fov"in this.camera?"Perspective":"Orthographic"}get position(){const{position:t}=this.camera,{x:e,y:i,z:s}=t;return new r.Vector3(e,i,s)}get direction(){const{direction:t}=this.camera,{x:e,y:i,z:s}=t;return new r.Vector3(e,i,s)}set world(t){this._world=t}get world(){return this._world}get _managerVersion(){return this._components.get(Zn).config.version}get topics(){return[...this._components.get(Zn).list.values()].filter((t=>t.viewpoints.has(this.guid)))}async addComponentsFromMap(t){const e=this._components.get(rs);for(const[i,s]of Object.entries(t)){const t=e.list.get(i);if(t)for(const e of s){const i=t.getItem(e);if(!i)continue;const s=await i.getGuid();s&&this.selectionComponents.add(s)}}this._components.get(Wn).list.set(this.guid,this)}set(t){const e=t,i=this;for(const s in t){if("guid"===s)continue;const t=e[s];"selectionComponents"!==s?"exceptionComponents"!==s?s in this&&(i[s]=t):(this.exceptionComponents.clear(),this.exceptionComponents.add(...t)):(this.selectionComponents.clear(),this.selectionComponents.add(...t))}return this._components.get(Wn).list.set(this.guid,this),this}async go(t=!0){if(!this.world)return;const{camera:e}=this.world;if(!e.hasCameraControls())throw new Error("Viewpoint: the world's camera need controls to set the viewpoint.");e instanceof ps&&e.projection.set(this.projection);const i=new r.Vector3(this.camera.position.x,this.camera.position.y,this.camera.position.z),s=new r.Vector3(this.camera.direction.x,this.camera.direction.y,this.camera.direction.z);if(i.equals(new r.Vector3)&&s.equals(new r.Vector3))return;const n=this.position,o=this.direction,a={x:n.x+80*o.x,y:n.y+80*o.y,z:n.z+80*o.z},h=await this.getSelectionMap();Object.keys(h).length,await e.controls.setLookAt(n.x,n.y,n.z,a.x,a.y,a.z,t)}async updateCamera(){return new Promise((t=>{if(!this.world)return void t(!1);const{camera:e,renderer:i}=this.world;if(!i)throw new Error("Viewpoint: the world needs to have a renderer!");if(!e.hasCameraControls())throw new Error("Viewpoint: world's camera need camera controls!");const s=new r.Vector3;e.controls.getPosition(s);const n=e.three,o=new r.Vector3(0,0,-1).applyEuler(n.rotation),{width:a,height:h}=i.getSize();let l=a/h;Number.isNaN(l)&&(l=1);const c=this._components.get(rs);s.applyMatrix4(c.baseCoordinationMatrix.clone().invert());const d={aspectRatio:l,position:{x:s.x,y:s.y,z:s.z},direction:{x:o.x,y:o.y,z:o.z}};n instanceof r.PerspectiveCamera?this.camera={...d,fov:n.fov}:n instanceof r.OrthographicCamera&&(this.camera={...d,viewToWorldScale:n.top-n.bottom});const u=this._components.get(Wn),p=i.three.domElement;i.three.render(this.world.scene.three,e.three),p.toBlob((async e=>{if(e){const t=await e.arrayBuffer();u.snapshots.set(this.guid,t)}u.list.set(this.guid,this),t(!0)}))}))}applyColors(){}resetColors(){}async createComponentTags(t){var e,i;const s=this._components.get(rs);let n="";if(this._components.get(Zn).config.includeSelectionTag){const r="selection"===t?await this.getSelectionMap():await this.getExceptionMap();for(const t in r){const o=s.list.get(t);if(!o)continue;const a=r[t];for(const t of a){const s=await o.getProperties(t);if(!s)continue;const r=null==(e=s.GlobalId)?void 0:e.value;if(!r)continue;const a=null==(i=s.Tag)?void 0:i.value;let h=null;a&&(h=`AuthoringToolId="${a}"`),n+=`\n<Component IfcGuid="${r}" ${h??""} />`}}}else n=[...this.selectionComponents].map((t=>`<Component IfcGuid="${t}" />`)).join("\n");return n}createColorTags(){let t="";for(const[e,i]of this.componentColors.entries()){t+=`<Color Color="${e}">\n${i.map((t=>`\n<Component IfcGuid="${t}" />`)).join("\n")}\n</Color>`}return 0!==t.length?`<Coloring>\n${t}\n</Coloring>`:"<Coloring />"}async serialize(t=this._managerVersion){const e=this._components.get(rs),i=this.position;i.applyMatrix4(e.baseCoordinationMatrix.clone().invert());const s=this.direction;s.normalize();const n=(new r.Matrix4).makeRotationX(Math.PI/2),o=s.clone().applyMatrix4(n);o.normalize();const a=`<CameraViewPoint>\n      <X>${i.x}</X>\n      <Y>${-i.z}</Y>\n      <Z>${i.y}</Z>\n    </CameraViewPoint>`,h=`<CameraDirection>\n      <X>${s.x}</X>\n      <Y>${-s.z}</Y>\n      <Z>${s.y}</Z>\n    </CameraDirection>`,l=`<CameraUpVector>\n      <X>${o.x}</X>\n      <Y>${-o.z}</Y>\n      <Z>${o.y}</Z>\n    </CameraUpVector>`,c=`<AspectRatio>${this.camera.aspectRatio}</AspectRatio>`;let d="";"viewToWorld"in this.camera?d=`<OrthogonalCamera>\n        ${a}\n        ${h}\n        ${l}\n        ${c}\n        <ViewToWorldScale>${this.camera.viewToWorld}</ViewToWorldScale>\n      </OrthogonalCamera>`:"fov"in this.camera&&(d=`<PerspectiveCamera>\n        ${a}\n        ${h}\n        ${l}\n        ${c}\n        <FieldOfView>${this.camera.fov}</FieldOfView>\n      </PerspectiveCamera>`);const u=`<ViewSetupHints SpacesVisible="${this.spacesVisible??!1}" SpaceBoundariesVisible="${this.spaceBoundariesVisible??!1}" OpeningsVisible="${this.openingsVisible??!1}" />`,p=(await this.createComponentTags("selection")).trim(),f=(await this.createComponentTags("exception")).trim(),m=this.createColorTags();return`<?xml version="1.0" encoding="UTF-8"?>\n    <VisualizationInfo Guid="${this.guid}">\n      <Components>\n        ${"2.1"===t?u:""}\n        ${0!==p.length?`<Selection>${p}</Selection>`:""}\n        <Visibility DefaultVisibility="${this.defaultVisibility}">\n          ${"3"===t?u:""}\n          ${0!==f.length?`<Exceptions>${f}</Exceptions>`:""}\n        </Visibility>\n        ${m}\n      </Components>\n      ${d}\n    </VisualizationInfo>`}}class Hn extends v{constructor(){super(...arguments),e(this,"_config",{overwriteColors:{value:!1,type:"Boolean"}})}get overwriteColors(){return this._config.overwriteColors.value}set overwriteColors(t){this._config.overwriteColors.value=t}}const Yn=class t extends h{constructor(i){super(i),e(this,"enabled",!0),e(this,"list",new g),e(this,"snapshots",new g),e(this,"isSetup",!1),e(this,"onSetup",new o),e(this,"config",new Hn(this,this.components,"Viewpoints",t.uuid)),e(this,"onDisposed",new o),i.add(t.uuid,this)}create(t){const e=new jn(this.components,t);return t||this.list.set(e.guid,e),e}setup(){}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}};e(Yn,"uuid","ee867824-a796-408d-8aa0-4e5962a83c66");let Wn=Yn;const $n=new i.Raycaster,Xn=new i.Vector3,Gn=new i.Vector3,Qn=new i.Quaternion,qn={X:new i.Vector3(1,0,0),Y:new i.Vector3(0,1,0),Z:new i.Vector3(0,0,1)},Kn={type:"change"},Jn={type:"mouseDown",mode:null},tr={type:"mouseUp",mode:null},er={type:"objectChange"};class ir extends i.Controls{constructor(t,e=null){super(void 0,e);const s=new Tr(this);this._root=s;const n=new Er;this._gizmo=n,s.add(n);const r=new Cr;this._plane=r,s.add(r);const o=this;function a(t,e){let i=e;Object.defineProperty(o,t,{get:function(){return void 0!==i?i:e},set:function(e){i!==e&&(i=e,r[t]=e,n[t]=e,o.dispatchEvent({type:t+"-changed",value:e}),o.dispatchEvent(Kn))}}),o[t]=e,r[t]=e,n[t]=e}a("camera",t),a("object",void 0),a("enabled",!0),a("axis",null),a("mode","translate"),a("translationSnap",null),a("rotationSnap",null),a("scaleSnap",null),a("space","world"),a("size",1),a("dragging",!1),a("showX",!0),a("showY",!0),a("showZ",!0),a("minX",-1/0),a("maxX",1/0),a("minY",-1/0),a("maxY",1/0),a("minZ",-1/0),a("maxZ",1/0);const h=new i.Vector3,l=new i.Vector3,c=new i.Quaternion,d=new i.Quaternion,u=new i.Vector3,p=new i.Quaternion,f=new i.Vector3,m=new i.Vector3,g=new i.Vector3,_=new i.Vector3;a("worldPosition",h),a("worldPositionStart",l),a("worldQuaternion",c),a("worldQuaternionStart",d),a("cameraPosition",u),a("cameraQuaternion",p),a("pointStart",f),a("pointEnd",m),a("rotationAxis",g),a("rotationAngle",0),a("eye",_),this._offset=new i.Vector3,this._startNorm=new i.Vector3,this._endNorm=new i.Vector3,this._cameraScale=new i.Vector3,this._parentPosition=new i.Vector3,this._parentQuaternion=new i.Quaternion,this._parentQuaternionInv=new i.Quaternion,this._parentScale=new i.Vector3,this._worldScaleStart=new i.Vector3,this._worldQuaternionInv=new i.Quaternion,this._worldScale=new i.Vector3,this._positionStart=new i.Vector3,this._quaternionStart=new i.Quaternion,this._scaleStart=new i.Vector3,this._getPointer=sr.bind(this),this._onPointerDown=rr.bind(this),this._onPointerHover=nr.bind(this),this._onPointerMove=or.bind(this),this._onPointerUp=ar.bind(this),null!==e&&this.connect()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(t){if(void 0===this.object||!0===this.dragging)return;null!==t&&$n.setFromCamera(t,this.camera);const e=hr(this._gizmo.picker[this.mode],$n);this.axis=e?e.object.name:null}pointerDown(t){if(void 0!==this.object&&!0!==this.dragging&&(null==t||0===t.button)&&null!==this.axis){null!==t&&$n.setFromCamera(t,this.camera);const e=hr(this._plane,$n,!0);e&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(e.point).sub(this.worldPositionStart)),this.dragging=!0,Jn.mode=this.mode,this.dispatchEvent(Jn)}}pointerMove(t){const e=this.axis,i=this.mode,s=this.object;let n=this.space;if("scale"===i?n="local":"E"!==e&&"XYZE"!==e&&"XYZ"!==e||(n="world"),void 0===s||null===e||!1===this.dragging||null!==t&&-1!==t.button)return;null!==t&&$n.setFromCamera(t,this.camera);const r=hr(this._plane,$n,!0);if(r){if(this.pointEnd.copy(r.point).sub(this.worldPositionStart),"translate"===i)this._offset.copy(this.pointEnd).sub(this.pointStart),"local"===n&&"XYZ"!==e&&this._offset.applyQuaternion(this._worldQuaternionInv),-1===e.indexOf("X")&&(this._offset.x=0),-1===e.indexOf("Y")&&(this._offset.y=0),-1===e.indexOf("Z")&&(this._offset.z=0),"local"===n&&"XYZ"!==e?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),s.position.copy(this._offset).add(this._positionStart),this.translationSnap&&("local"===n&&(s.position.applyQuaternion(Qn.copy(this._quaternionStart).invert()),-1!==e.search("X")&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(this._quaternionStart)),"world"===n&&(s.parent&&s.position.add(Xn.setFromMatrixPosition(s.parent.matrixWorld)),-1!==e.search("X")&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(Xn.setFromMatrixPosition(s.parent.matrixWorld)))),s.position.x=Math.max(this.minX,Math.min(this.maxX,s.position.x)),s.position.y=Math.max(this.minY,Math.min(this.maxY,s.position.y)),s.position.z=Math.max(this.minZ,Math.min(this.maxZ,s.position.z));else if("scale"===i){if(-1!==e.search("XYZ")){let t=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(t*=-1),Gn.set(t,t,t)}else Xn.copy(this.pointStart),Gn.copy(this.pointEnd),Xn.applyQuaternion(this._worldQuaternionInv),Gn.applyQuaternion(this._worldQuaternionInv),Gn.divide(Xn),-1===e.search("X")&&(Gn.x=1),-1===e.search("Y")&&(Gn.y=1),-1===e.search("Z")&&(Gn.z=1);s.scale.copy(this._scaleStart).multiply(Gn),this.scaleSnap&&(-1!==e.search("X")&&(s.scale.x=Math.round(s.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Y")&&(s.scale.y=Math.round(s.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Z")&&(s.scale.z=Math.round(s.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===i){this._offset.copy(this.pointEnd).sub(this.pointStart);const t=20/this.worldPosition.distanceTo(Xn.setFromMatrixPosition(this.camera.matrixWorld));let i=!1;"XYZE"===e?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(Xn.copy(this.rotationAxis).cross(this.eye))*t):"X"!==e&&"Y"!==e&&"Z"!==e||(this.rotationAxis.copy(qn[e]),Xn.copy(qn[e]),"local"===n&&Xn.applyQuaternion(this.worldQuaternion),Xn.cross(this.eye),0===Xn.length()?i=!0:this.rotationAngle=this._offset.dot(Xn.normalize())*t),("E"===e||i)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),"local"===n&&"E"!==e&&"XYZE"!==e?(s.quaternion.copy(this._quaternionStart),s.quaternion.multiply(Qn.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),s.quaternion.copy(Qn.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),s.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(Kn),this.dispatchEvent(er)}}pointerUp(t){null!==t&&0!==t.button||(this.dragging&&null!==this.axis&&(tr.mode=this.mode,this.dispatchEvent(tr)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(t){return this.object=t,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(Kn),this.dispatchEvent(er),this.pointStart.copy(this.pointEnd))}getRaycaster(){return $n}getMode(){return this.mode}setMode(t){this.mode=t}setTranslationSnap(t){this.translationSnap=t}setRotationSnap(t){this.rotationSnap=t}setScaleSnap(t){this.scaleSnap=t}setSize(t){this.size=t}setSpace(t){this.space=t}}function sr(t){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:t.button};{const e=this.domElement.getBoundingClientRect();return{x:(t.clientX-e.left)/e.width*2-1,y:-(t.clientY-e.top)/e.height*2+1,button:t.button}}}function nr(t){if(this.enabled)switch(t.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(t))}}function rr(t){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(t.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(t)),this.pointerDown(this._getPointer(t)))}function or(t){this.enabled&&this.pointerMove(this._getPointer(t))}function ar(t){this.enabled&&(this.domElement.releasePointerCapture(t.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(t)))}function hr(t,e,i){const s=e.intersectObject(t,!0);for(let t=0;t<s.length;t++)if(s[t].object.visible||i)return s[t];return!1}const lr=new i.Euler,cr=new i.Vector3(0,1,0),dr=new i.Vector3(0,0,0),ur=new i.Matrix4,pr=new i.Quaternion,fr=new i.Quaternion,mr=new i.Vector3,gr=new i.Matrix4,_r=new i.Vector3(1,0,0),yr=new i.Vector3(0,1,0),wr=new i.Vector3(0,0,1),vr=new i.Vector3,br=new i.Vector3,xr=new i.Vector3;class Tr extends i.Object3D{constructor(t){super(),this.isTransformControlsRoot=!0,this.controls=t,this.visible=!1}updateMatrixWorld(t){const e=this.controls;void 0!==e.object&&(e.object.updateMatrixWorld(),null===e.object.parent?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):e.object.parent.matrixWorld.decompose(e._parentPosition,e._parentQuaternion,e._parentScale),e.object.matrixWorld.decompose(e.worldPosition,e.worldQuaternion,e._worldScale),e._parentQuaternionInv.copy(e._parentQuaternion).invert(),e._worldQuaternionInv.copy(e.worldQuaternion).invert()),e.camera.updateMatrixWorld(),e.camera.matrixWorld.decompose(e.cameraPosition,e.cameraQuaternion,e._cameraScale),e.camera.isOrthographicCamera?e.camera.getWorldDirection(e.eye).negate():e.eye.copy(e.cameraPosition).sub(e.worldPosition).normalize(),super.updateMatrixWorld(t)}dispose(){this.traverse((function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}))}}class Er extends i.Object3D{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const t=new i.MeshBasicMaterial({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),e=new i.LineBasicMaterial({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),s=t.clone();s.opacity=.15;const n=e.clone();n.opacity=.5;const r=t.clone();r.color.setHex(16711680);const o=t.clone();o.color.setHex(65280);const a=t.clone();a.color.setHex(255);const h=t.clone();h.color.setHex(16711680),h.opacity=.5;const l=t.clone();l.color.setHex(65280),l.opacity=.5;const c=t.clone();c.color.setHex(255),c.opacity=.5;const d=t.clone();d.opacity=.25;const u=t.clone();u.color.setHex(16776960),u.opacity=.25;t.clone().color.setHex(16776960);const p=t.clone();p.color.setHex(7895160);const f=new i.CylinderGeometry(0,.04,.1,12);f.translate(0,.05,0);const m=new i.BoxGeometry(.08,.08,.08);m.translate(0,.04,0);const g=new i.BufferGeometry;g.setAttribute("position",new i.Float32BufferAttribute([0,0,0,1,0,0],3));const _=new i.CylinderGeometry(.0075,.0075,.5,3);function y(t,e){const s=new i.TorusGeometry(t,.0075,3,64,e*Math.PI*2);return s.rotateY(Math.PI/2),s.rotateX(Math.PI/2),s}_.translate(0,.25,0);const w={X:[[new i.Mesh(f,r),[.5,0,0],[0,0,-Math.PI/2]],[new i.Mesh(f,r),[-.5,0,0],[0,0,Math.PI/2]],[new i.Mesh(_,r),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new i.Mesh(f,o),[0,.5,0]],[new i.Mesh(f,o),[0,-.5,0],[Math.PI,0,0]],[new i.Mesh(_,o)]],Z:[[new i.Mesh(f,a),[0,0,.5],[Math.PI/2,0,0]],[new i.Mesh(f,a),[0,0,-.5],[-Math.PI/2,0,0]],[new i.Mesh(_,a),null,[Math.PI/2,0,0]]],XYZ:[[new i.Mesh(new i.OctahedronGeometry(.1,0),d.clone()),[0,0,0]]],XY:[[new i.Mesh(new i.BoxGeometry(.15,.15,.01),c.clone()),[.15,.15,0]]],YZ:[[new i.Mesh(new i.BoxGeometry(.15,.15,.01),h.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new i.Mesh(new i.BoxGeometry(.15,.15,.01),l.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},v={X:[[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[0,.3,0]],[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new i.Mesh(new i.OctahedronGeometry(.2,0),s)]],XY:[[new i.Mesh(new i.BoxGeometry(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new i.Mesh(new i.BoxGeometry(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new i.Mesh(new i.BoxGeometry(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]]},b={START:[[new i.Mesh(new i.OctahedronGeometry(.01,2),n),null,null,null,"helper"]],END:[[new i.Mesh(new i.OctahedronGeometry(.01,2),n),null,null,null,"helper"]],DELTA:[[new i.Line(function(){const t=new i.BufferGeometry;return t.setAttribute("position",new i.Float32BufferAttribute([0,0,0,1,1,1],3)),t}(),n),null,null,null,"helper"]],X:[[new i.Line(g,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new i.Line(g,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new i.Line(g,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},x={XYZE:[[new i.Mesh(y(.5,1),p),null,[0,Math.PI/2,0]]],X:[[new i.Mesh(y(.5,.5),r)]],Y:[[new i.Mesh(y(.5,.5),o),null,[0,0,-Math.PI/2]]],Z:[[new i.Mesh(y(.5,.5),a),null,[0,Math.PI/2,0]]],E:[[new i.Mesh(y(.75,1),u),null,[0,Math.PI/2,0]]]},T={AXIS:[[new i.Line(g,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},E={XYZE:[[new i.Mesh(new i.SphereGeometry(.25,10,8),s)]],X:[[new i.Mesh(new i.TorusGeometry(.5,.1,4,24),s),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new i.Mesh(new i.TorusGeometry(.5,.1,4,24),s),[0,0,0],[Math.PI/2,0,0]]],Z:[[new i.Mesh(new i.TorusGeometry(.5,.1,4,24),s),[0,0,0],[0,0,-Math.PI/2]]],E:[[new i.Mesh(new i.TorusGeometry(.75,.1,2,24),s)]]},C={X:[[new i.Mesh(m,r),[.5,0,0],[0,0,-Math.PI/2]],[new i.Mesh(_,r),[0,0,0],[0,0,-Math.PI/2]],[new i.Mesh(m,r),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new i.Mesh(m,o),[0,.5,0]],[new i.Mesh(_,o)],[new i.Mesh(m,o),[0,-.5,0],[0,0,Math.PI]]],Z:[[new i.Mesh(m,a),[0,0,.5],[Math.PI/2,0,0]],[new i.Mesh(_,a),[0,0,0],[Math.PI/2,0,0]],[new i.Mesh(m,a),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new i.Mesh(new i.BoxGeometry(.15,.15,.01),c),[.15,.15,0]]],YZ:[[new i.Mesh(new i.BoxGeometry(.15,.15,.01),h),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new i.Mesh(new i.BoxGeometry(.15,.15,.01),l),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new i.Mesh(new i.BoxGeometry(.1,.1,.1),d.clone())]]},O={X:[[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[0,.3,0]],[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new i.Mesh(new i.CylinderGeometry(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new i.Mesh(new i.BoxGeometry(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new i.Mesh(new i.BoxGeometry(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new i.Mesh(new i.BoxGeometry(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new i.Mesh(new i.BoxGeometry(.2,.2,.2),s),[0,0,0]]]},A={X:[[new i.Line(g,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new i.Line(g,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new i.Line(g,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function S(t){const e=new i.Object3D;for(const i in t)for(let s=t[i].length;s--;){const n=t[i][s][0].clone(),r=t[i][s][1],o=t[i][s][2],a=t[i][s][3],h=t[i][s][4];n.name=i,n.tag=h,r&&n.position.set(r[0],r[1],r[2]),o&&n.rotation.set(o[0],o[1],o[2]),a&&n.scale.set(a[0],a[1],a[2]),n.updateMatrix();const l=n.geometry.clone();l.applyMatrix4(n.matrix),n.geometry=l,n.renderOrder=1/0,n.position.set(0,0,0),n.rotation.set(0,0,0),n.scale.set(1,1,1),e.add(n)}return e}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=S(w)),this.add(this.gizmo.rotate=S(x)),this.add(this.gizmo.scale=S(C)),this.add(this.picker.translate=S(v)),this.add(this.picker.rotate=S(E)),this.add(this.picker.scale=S(O)),this.add(this.helper.translate=S(b)),this.add(this.helper.rotate=S(T)),this.add(this.helper.scale=S(A)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(t){const e="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:fr;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;let i=[];i=i.concat(this.picker[this.mode].children),i=i.concat(this.gizmo[this.mode].children),i=i.concat(this.helper[this.mode].children);for(let t=0;t<i.length;t++){const s=i[t];let n;if(s.visible=!0,s.rotation.set(0,0,0),s.position.copy(this.worldPosition),n=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),s.scale.set(1,1,1).multiplyScalar(n*this.size/4),"helper"!==s.tag){if(s.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode){const t=.99,i=.2;"X"===s.name&&Math.abs(cr.copy(_r).applyQuaternion(e).dot(this.eye))>t&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"Y"===s.name&&Math.abs(cr.copy(yr).applyQuaternion(e).dot(this.eye))>t&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"Z"===s.name&&Math.abs(cr.copy(wr).applyQuaternion(e).dot(this.eye))>t&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"XY"===s.name&&Math.abs(cr.copy(wr).applyQuaternion(e).dot(this.eye))<i&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"YZ"===s.name&&Math.abs(cr.copy(_r).applyQuaternion(e).dot(this.eye))<i&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1),"XZ"===s.name&&Math.abs(cr.copy(yr).applyQuaternion(e).dot(this.eye))<i&&(s.scale.set(1e-10,1e-10,1e-10),s.visible=!1)}else"rotate"===this.mode&&(pr.copy(e),cr.copy(this.eye).applyQuaternion(Qn.copy(e).invert()),-1!==s.name.search("E")&&s.quaternion.setFromRotationMatrix(ur.lookAt(this.eye,dr,yr)),"X"===s.name&&(Qn.setFromAxisAngle(_r,Math.atan2(-cr.y,cr.z)),Qn.multiplyQuaternions(pr,Qn),s.quaternion.copy(Qn)),"Y"===s.name&&(Qn.setFromAxisAngle(yr,Math.atan2(cr.x,cr.z)),Qn.multiplyQuaternions(pr,Qn),s.quaternion.copy(Qn)),"Z"===s.name&&(Qn.setFromAxisAngle(wr,Math.atan2(cr.y,cr.x)),Qn.multiplyQuaternions(pr,Qn),s.quaternion.copy(Qn)));s.visible=s.visible&&(-1===s.name.indexOf("X")||this.showX),s.visible=s.visible&&(-1===s.name.indexOf("Y")||this.showY),s.visible=s.visible&&(-1===s.name.indexOf("Z")||this.showZ),s.visible=s.visible&&(-1===s.name.indexOf("E")||this.showX&&this.showY&&this.showZ),s.material._color=s.material._color||s.material.color.clone(),s.material._opacity=s.material._opacity||s.material.opacity,s.material.color.copy(s.material._color),s.material.opacity=s.material._opacity,this.enabled&&this.axis&&(s.name===this.axis||this.axis.split("").some((function(t){return s.name===t})))&&(s.material.color.setHex(16776960),s.material.opacity=1)}else s.visible=!1,"AXIS"===s.name?(s.visible=!!this.axis,"X"===this.axis&&(Qn.setFromEuler(lr.set(0,0,0)),s.quaternion.copy(e).multiply(Qn),Math.abs(cr.copy(_r).applyQuaternion(e).dot(this.eye))>.9&&(s.visible=!1)),"Y"===this.axis&&(Qn.setFromEuler(lr.set(0,0,Math.PI/2)),s.quaternion.copy(e).multiply(Qn),Math.abs(cr.copy(yr).applyQuaternion(e).dot(this.eye))>.9&&(s.visible=!1)),"Z"===this.axis&&(Qn.setFromEuler(lr.set(0,Math.PI/2,0)),s.quaternion.copy(e).multiply(Qn),Math.abs(cr.copy(wr).applyQuaternion(e).dot(this.eye))>.9&&(s.visible=!1)),"XYZE"===this.axis&&(Qn.setFromEuler(lr.set(0,Math.PI/2,0)),cr.copy(this.rotationAxis),s.quaternion.setFromRotationMatrix(ur.lookAt(dr,cr,yr)),s.quaternion.multiply(Qn),s.visible=this.dragging),"E"===this.axis&&(s.visible=!1)):"START"===s.name?(s.position.copy(this.worldPositionStart),s.visible=this.dragging):"END"===s.name?(s.position.copy(this.worldPosition),s.visible=this.dragging):"DELTA"===s.name?(s.position.copy(this.worldPositionStart),s.quaternion.copy(this.worldQuaternionStart),Xn.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),Xn.applyQuaternion(this.worldQuaternionStart.clone().invert()),s.scale.copy(Xn),s.visible=this.dragging):(s.quaternion.copy(e),this.dragging?s.position.copy(this.worldPositionStart):s.position.copy(this.worldPosition),this.axis&&(s.visible=-1!==this.axis.search(s.name)))}super.updateMatrixWorld(t)}}class Cr extends i.Mesh{constructor(){super(new i.PlaneGeometry(1e5,1e5,2,2),new i.MeshBasicMaterial({visible:!1,wireframe:!0,side:i.DoubleSide,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(t){let e=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(e="local"),vr.copy(_r).applyQuaternion("local"===e?this.worldQuaternion:fr),br.copy(yr).applyQuaternion("local"===e?this.worldQuaternion:fr),xr.copy(wr).applyQuaternion("local"===e?this.worldQuaternion:fr),cr.copy(br),this.mode){case"translate":case"scale":switch(this.axis){case"X":cr.copy(this.eye).cross(vr),mr.copy(vr).cross(cr);break;case"Y":cr.copy(this.eye).cross(br),mr.copy(br).cross(cr);break;case"Z":cr.copy(this.eye).cross(xr),mr.copy(xr).cross(cr);break;case"XY":mr.copy(xr);break;case"YZ":mr.copy(vr);break;case"XZ":cr.copy(xr),mr.copy(br);break;case"XYZ":case"E":mr.set(0,0,0)}break;default:mr.set(0,0,0)}0===mr.length()?this.quaternion.copy(this.cameraQuaternion):(gr.lookAt(Xn.set(0,0,0),mr,cr),this.quaternion.setFromRotationMatrix(gr)),super.updateMatrixWorld(t)}}class Or{constructor(t,i,s,n,a,h=5,l=!0){if(e(this,"onDraggingStarted",new o),e(this,"onDraggingEnded",new o),e(this,"onDisposed",new o),e(this,"normal"),e(this,"origin"),e(this,"three",new r.Plane),e(this,"components"),e(this,"world"),e(this,"type","default"),e(this,"_helper"),e(this,"_visible",!0),e(this,"_enabled",!0),e(this,"_controlsActive",!1),e(this,"_arrowBoundBox",new r.Mesh),e(this,"_planeMesh"),e(this,"_controls"),e(this,"_hiddenMaterial",new r.MeshBasicMaterial({visible:!1})),e(this,"update",(()=>{this._enabled&&this.three.setFromNormalAndCoplanarPoint(this.normal,this._helper.position)})),e(this,"changeDrag",(t=>{this._visible=!t.value,this.preventCameraMovement(),this.notifyDraggingChanged(t)})),this.components=t,this.world=i,!i.renderer)throw new Error("The given world must have a renderer!");this.normal=n,this.origin=s,i.renderer.setPlane(!0,this.three),this._planeMesh=Or.newPlaneMesh(h,a),this._helper=this.newHelper(),this._controls=this.newTransformControls(),this.three.setFromNormalAndCoplanarPoint(n,s),l&&this.toggleControls(!0)}get enabled(){return this._enabled}set enabled(t){if(!this.world.isDisposing){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");this._enabled=t,this.world.renderer.setPlane(t,this.three)}}get visible(){return this._visible}set visible(t){this._visible=t,this._controls.getHelper().visible=t,this._helper.visible=t,this.toggleControls(t)}get meshes(){return[this._planeMesh,this._arrowBoundBox]}get planeMaterial(){return this._planeMesh.material}set planeMaterial(t){this._planeMesh.material=t}get size(){return this._planeMesh.scale.x}set size(t){this._planeMesh.scale.set(t,t,t)}get helper(){return this._helper}setFromNormalAndCoplanarPoint(t,e){this.reset(),this.normal.equals(t)||(this.normal.copy(t),this._helper.lookAt(t)),this.origin.copy(e),this._helper.position.copy(e),this._helper.updateMatrix(),this.update()}dispose(){this._enabled=!1,this.onDraggingStarted.reset(),this.onDraggingEnded.reset(),this._helper.removeFromParent(),this.world.renderer&&this.world.renderer.setPlane(!1,this.three),this._arrowBoundBox.removeFromParent(),this._arrowBoundBox.geometry.dispose(),this._planeMesh.geometry.dispose(),this._controls.getHelper().removeFromParent(),this._controls.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}reset(){const t=new r.Vector3(1,0,0),e=new r.Vector3;this.normal.equals(t)||(this.normal.copy(t),this._helper.lookAt(t)),this.origin.copy(e),this._helper.position.copy(e),this._helper.updateMatrix()}toggleControls(t){if(t){if(this._controlsActive)return;this._controls.addEventListener("change",this.update),this._controls.addEventListener("dragging-changed",this.changeDrag)}else this._controls.removeEventListener("change",this.update),this._controls.removeEventListener("dragging-changed",this.changeDrag);this._controlsActive=t}newTransformControls(){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");const t=this.world.camera.three,e=this.world.renderer.three.domElement,i=new ir(t,e);return this.initializeControls(i),this.world.scene.three.add(i.getHelper()),i}initializeControls(t){t.attach(this._helper),t.showX=!1,t.showY=!1,t.setSpace("local"),this.createArrowBoundingBox(),t.getHelper().children[0].children[0].add(this._arrowBoundBox)}createArrowBoundingBox(){this._arrowBoundBox.geometry=new r.CylinderGeometry(.18,.18,1.2),this._arrowBoundBox.material=this._hiddenMaterial,this._arrowBoundBox.rotateX(Math.PI/2),this._arrowBoundBox.updateMatrix(),this._arrowBoundBox.geometry.applyMatrix4(this._arrowBoundBox.matrix)}notifyDraggingChanged(t){t.value?this.onDraggingStarted.trigger():this.onDraggingEnded.trigger()}preventCameraMovement(){this.world.camera.enabled=this._visible}newHelper(){const t=new r.Object3D;return t.lookAt(this.normal),t.position.copy(this.origin),this._planeMesh.position.z+=.01,t.add(this._planeMesh),this.world.scene.three.add(t),t}static newPlaneMesh(t,e){const i=new r.PlaneGeometry(1),s=new r.Mesh(i,e);return s.scale.set(t,t,t),s}}class Ar extends v{constructor(){super(...arguments),e(this,"_config",{enabled:{value:!0,type:"Boolean"},visible:{value:!0,type:"Boolean"},color:{value:new r.Color,type:"Color"},opacity:{type:"Number",interpolable:!0,value:1,min:0,max:1},size:{type:"Number",interpolable:!0,value:2,min:0,max:100}})}get enabled(){return this._config.enabled.value}set enabled(t){this._config.enabled.value=t,this._component.enabled=t}get visible(){return this._config.visible.value}set visible(t){this._config.visible.value=t,this._component.visible=t}get color(){return this._config.color.value}set color(t){this._config.color.value=t,this._component.material.color.copy(t)}get opacity(){return this._config.opacity.value}set opacity(t){this._config.opacity.value=t,this._component.material.opacity=t}get size(){return this._config.size.value}set size(t){this._config.size.value=t,this._component.size=t}}const Sr=class t extends h{constructor(i){super(i),e(this,"onSetup",new o),e(this,"onBeforeDrag",new o),e(this,"onAfterDrag",new o),e(this,"onBeforeCreate",new o),e(this,"onBeforeCancel",new o),e(this,"onAfterCancel",new o),e(this,"onBeforeDelete",new o),e(this,"onAfterCreate",new o),e(this,"onAfterDelete",new o),e(this,"onDisposed",new o),e(this,"isSetup",!1),e(this,"orthogonalY",!1),e(this,"toleranceOrthogonalY",.7),e(this,"Type",Or),e(this,"list",[]),e(this,"config",new Ar(this,this.components,"Clipper",t.uuid)),e(this,"_defaultConfig",{color:new r.Color(12255487),opacity:.2,size:2}),e(this,"_material",new r.MeshBasicMaterial({color:12255487,side:r.DoubleSide,transparent:!0,opacity:.2})),e(this,"_size",5),e(this,"_enabled",!1),e(this,"_visible",!0),e(this,"_onStartDragging",(()=>{this.onBeforeDrag.trigger()})),e(this,"_onEndDragging",(()=>{this.onAfterDrag.trigger()})),this.components.add(t.uuid,this)}get enabled(){return this._enabled}set enabled(t){this._enabled=t;for(const e of this.list)e.enabled=t;this.updateMaterialsAndPlanes()}get visible(){return this._visible}set visible(t){this._visible=t;for(const e of this.list)e.visible=t}get material(){return this._material}set material(t){this._material=t;for(const e of this.list)e.planeMaterial=t}get size(){return this._size}set size(t){this._size=t;for(const e of this.list)e.size=t}dispose(){this._enabled=!1;this.components.get(x).list.delete(this.config.uuid);for(const t of this.list)t.dispose();this.list.length=0,this._material.dispose(),this.onBeforeCreate.reset(),this.onBeforeCancel.reset(),this.onBeforeDelete.reset(),this.onBeforeDrag.reset(),this.onAfterCreate.reset(),this.onAfterCancel.reset(),this.onAfterDelete.reset(),this.onAfterDrag.reset(),this.onDisposed.trigger(t.uuid),this.onDisposed.reset()}async create(t){const e=this.components.get(hs).get(t),i=await e.castRay();return i?this.createPlaneFromIntersection(t,i):null}createFromNormalAndCoplanarPoint(t,e,i){const s=this.newPlane(t,i,e);return this.updateMaterialsAndPlanes(),s}async delete(t,e){e||(e=await this.pickPlane(t)),e&&this.deletePlane(e)}deleteAll(t){const e=[...this.list];for(const i of e)if(!t||t.has(i.type)){this.delete(i.world,i);const t=this.list.indexOf(i);-1!==t&&this.list.splice(t,1)}}setup(t){const e={...this._defaultConfig,...t};this.config.color=e.color,this.config.opacity=e.opacity,this.config.size=e.size,this.isSetup=!0,this.onSetup.trigger()}deletePlane(t){const e=this.list.indexOf(t);if(-1!==e){if(this.list.splice(e,1),!t.world.renderer)throw new Error("Renderer not found for this plane's world!");t.world.renderer.setPlane(!1,t.three),t.dispose(),this.updateMaterialsAndPlanes(),this.onAfterDelete.trigger(t)}}async pickPlane(t){const e=this.components.get(hs).get(t),i=this.getAllPlaneMeshes(),s=await e.castRay(i);if(s){const t=s.object;return this.list.find((e=>e.meshes.includes(t)))}}getAllPlaneMeshes(){const t=[];for(const e of this.list)t.push(...e.meshes);return t}createPlaneFromIntersection(t,e){var i;if(!t.renderer)throw new Error("The given world must have a renderer!");const s=e.point.distanceTo(new r.Vector3(0,0,0)),n=e.normal||(null==(i=e.face)?void 0:i.normal);if(!s||!n)return null;const o=this.getWorldNormal(e,n),a=this.newPlane(t,e.point,o.negate());return a.visible=this._visible,a.size=this._size,t.renderer.setPlane(!0,a.three),this.updateMaterialsAndPlanes(),a}getWorldNormal(t,e){const i=t.object;let s=t.object.matrixWorld.clone();if(i instanceof r.InstancedMesh&&void 0!==t.instanceId){const e=new r.Matrix4;i.getMatrixAt(t.instanceId,e),s=e.multiply(s)}const n=(new r.Matrix3).getNormalMatrix(s),o=e.clone().applyMatrix3(n).normalize();return this.normalizePlaneDirectionY(o),o}normalizePlaneDirectionY(t){this.orthogonalY&&(t.y>this.toleranceOrthogonalY&&(t.x=0,t.y=1,t.z=0),t.y<-this.toleranceOrthogonalY&&(t.x=0,t.y=-1,t.z=0))}newPlane(t,e,i){const s=new this.Type(this.components,t,e,i,this._material);return s.onDraggingStarted.add(this._onStartDragging),s.onDraggingEnded.add(this._onEndDragging),this.list.push(s),this.onAfterCreate.trigger(s),s}updateMaterialsAndPlanes(){const t=this.components.get(Ct);for(const[e,i]of t.list){if(!i.renderer)continue;i.renderer.updateClippingPlanes();const{clippingPlanes:t}=i.renderer;for(const e of i.meshes)if(e.material)if(Array.isArray(e.material))for(const i of e.material)i.clippingPlanes=t;else e.material.clippingPlanes=t}}};e(Sr,"uuid","66290bc5-18c4-4cd1-9379-2e17a0617611");let Pr=Sr;exports.AsyncEvent=class{constructor(){e(this,"enabled",!0),e(this,"trigger",(async t=>{if(!this.enabled)return;const e=this.handlers.slice(0);for(const i of e)await i(t)})),e(this,"handlers",[])}add(t){this.handlers.push(t)}remove(t){this.handlers=this.handlers.filter((e=>e!==t))}reset(){this.handlers.length=0}},exports.BCFTopics=Zn,exports.BCFTopicsConfigManager=Fn,exports.Base=a,exports.BaseCamera=c,exports.BaseRenderer=d,exports.BaseScene=f,exports.BaseWorldItem=l,exports.Clipper=Pr,exports.Comment=Un,exports.Component=h,exports.ComponentWithUI=class extends h{},exports.Components=is,exports.ConfigManager=x,exports.Configurator=v,exports.ControlsUtils=_,exports.DataMap=g,exports.DataSet=m,exports.Disposer=p,exports.Event=o,exports.EventManager=class{constructor(){e(this,"list",new Set)}add(t){for(const e of t)this.list.add(e)}remove(t){for(const e of t)this.list.delete(e)}set(t){for(const e of this.list)e.enabled=t}reset(){for(const t of this.list)t.reset()}},exports.FirstPersonMode=ls,exports.FragmentsManager=rs,exports.Grids=Pt,exports.Mouse=ss,exports.OrbitMode=cs,exports.OrthoPerspectiveCamera=ps,exports.PlanMode=ds,exports.ProjectionManager=us,exports.Raycasters=hs,exports.SimpleCamera=Tt,exports.SimpleGrid=At,exports.SimpleGridConfigManager=Ot,exports.SimplePlane=Or,exports.SimpleRaycaster=os,exports.SimpleRenderer=class extends d{constructor(t,i,s){super(t),e(this,"enabled",!0),e(this,"container"),e(this,"three"),e(this,"_canvas"),e(this,"_parameters"),e(this,"_resizeObserver",null),e(this,"onContainerUpdated",new o),e(this,"_resizing",!1),e(this,"resize",(t=>{if(this._resizing)return;this._resizing=!0,this.onContainerUpdated.trigger();const e=t?t.x:this.container.clientWidth,i=t?t.y:this.container.clientHeight;this.three.setSize(e,i),this.onResize.trigger(new r.Vector2(e,i)),this._resizing=!1})),e(this,"resizeEvent",(()=>{this.resize()})),e(this,"onContextLost",(t=>{t.preventDefault(),this.enabled=!1})),e(this,"onContextBack",(()=>{this.three.setRenderTarget(null),this.three.dispose(),this.three=new r.WebGLRenderer({canvas:this._canvas,antialias:!0,alpha:!0,...this._parameters}),this.enabled=!0})),this.container=i,this._parameters=s,this.three=new r.WebGLRenderer({antialias:!0,alpha:!0,...s}),this.three.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.setupRenderer(),this.setupEvents(!0),this.resize(),this._canvas=this.three.domElement;const n=this.three.getContext(),{canvas:a}=n;a.addEventListener("webglcontextlost",this.onContextLost,!1),a.addEventListener("webglcontextrestored",this.onContextBack,!1)}update(){if(!this.enabled||!this.currentWorld)return;this.onBeforeUpdate.trigger(this);const t=this.currentWorld.scene.three,e=this.currentWorld.camera.three;this.three.render(t,e),this.onAfterUpdate.trigger(this)}dispose(){this.enabled=!1,this.setupEvents(!1),this.three.domElement.remove(),this.three.forceContextLoss(),this.three.dispose(),this.onResize.reset(),this.onAfterUpdate.reset(),this.onBeforeUpdate.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}getSize(){return new r.Vector2(this.three.domElement.clientWidth,this.three.domElement.clientHeight)}setupEvents(t){const e=this.three.domElement.parentElement;if(!e)throw new Error("This renderer needs to have an HTML container!");this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),window.removeEventListener("resize",this.resizeEvent),t&&(this._resizeObserver=new ResizeObserver(this.resizeEvent),this._resizeObserver.observe(e),window.addEventListener("resize",this.resizeEvent))}setupRenderer(){this.three.localClippingEnabled=!0,this.container&&this.container.appendChild(this.three.domElement),this.onContainerUpdated.trigger()}},exports.SimpleScene=class extends f{constructor(t){super(t),e(this,"onSetup",new o),e(this,"isSetup",!1),e(this,"three"),e(this,"config",new O(this,this.components,"Scene")),e(this,"_defaultConfig",{backgroundColor:new r.Color(2107698),directionalLight:{color:new r.Color("white"),intensity:1.5,position:new r.Vector3(5,10,3)},ambientLight:{color:new r.Color("white"),intensity:1}}),this.three=new r.Scene,this.three.background=new r.Color(2107698)}setup(t){const e={...this._defaultConfig,...t};this.config.backgroundColor=e.backgroundColor;const i=e.ambientLight;this.config.ambientLight.color=i.color,this.config.ambientLight.intensity=i.intensity;const s=e.directionalLight;this.config.directionalLight.color=s.color,this.config.directionalLight.intensity=s.intensity,this.config.directionalLight.position=s.position,this.deleteAllLights();const{color:n,intensity:o}=this.config.directionalLight,a=new r.DirectionalLight(n,o);a.position.copy(s.position);const{color:h,intensity:l}=this.config.directionalLight,c=new r.AmbientLight(h,l);this.three.add(a,c),this.directionalLights.set(a.uuid,a),this.ambientLights.set(c.uuid,c),this.isSetup=!0,this.onSetup.trigger()}dispose(){super.dispose();this.components.get(x).list.delete(this.config.uuid)}},exports.SimpleSceneConfigManager=O,exports.SimpleWorld=T,exports.Topic=Ln,exports.UUID=w,exports.Viewpoint=jn,exports.Viewpoints=Wn,exports.Worlds=Ct,exports.extensionsImporter=Rn;
